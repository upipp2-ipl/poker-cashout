<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <title>IPL ‚Äì Poker Cashout</title>
  <style>
    [data-theme="dark"]{--bg:#1a1f2e;--bg2:#242938;--text:#e8eefc;--muted:#8b95b0;--line:rgba(255,255,255,.08);--card-border:rgba(255,255,255,.08);--input-bg:rgba(0,0,0,.15);--input-border:rgba(255,255,255,.10);--hover:rgba(255,255,255,.04);--good:#2bd576;--warn:#f5c542;--bad:#ff5c7a;--accent:#7aa7ff;--b:#3b4557;--p:#7c3aed;--y:#f59e0b;--pk:#ec4899;--o:#f97316;--sh:0 4px 20px rgba(0,0,0,.25)}
    [data-theme="light"]{--bg:#f0f2f7;--bg2:#ffffff;--text:#1a1f2e;--muted:#5a6278;--line:rgba(0,0,0,.08);--card-border:rgba(0,0,0,.08);--input-bg:rgba(0,0,0,.03);--input-border:rgba(0,0,0,.12);--hover:rgba(0,0,0,.03);--good:#0d9f4f;--warn:#c68a00;--bad:#dc2f4a;--accent:#4a7fdd;--b:#6b7280;--p:#7c3aed;--y:#d97706;--pk:#db2777;--o:#ea580c;--sh:0 2px 12px rgba(0,0,0,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:0 14px 20px;transition:background .3s,color .3s}
    .iplHeader{text-align:center;padding:20px 14px 10px}
    .iplLogo{display:inline-flex;align-items:center;gap:6px;font-size:28px;font-weight:800;letter-spacing:1px}
    .suit{font-size:20px;opacity:.7}.suit.red{color:var(--bad)}.suit.blk{color:var(--muted)}
    .iplSub{color:var(--muted);font-size:12px;margin-top:2px;letter-spacing:.5px}
    .wrap{max-width:480px;width:100%}
    .card{border:1px solid var(--card-border);border-radius:14px;background:var(--bg2);box-shadow:var(--sh);overflow:hidden;transition:background .3s}
    .hd{padding:16px;border-bottom:1px solid var(--line);text-align:center}
    .hd h1{margin:0;font-size:18px}.hd .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .bd{padding:16px}
    label{display:block;color:var(--muted);font-size:11px;margin-bottom:5px;font-weight:500}
    input,select,button{font:inherit}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);outline:none;font-size:16px;transition:border-color .15s}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(122,167,255,.10)}
    input[type="number"]{appearance:textfield}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border-radius:10px;border:1px solid var(--card-border);background:var(--input-bg);color:var(--text);cursor:pointer;user-select:none;font-size:15px;font-weight:600;touch-action:manipulation;transition:all .15s}
    .btn:hover{background:var(--hover)}.btn:active{opacity:.9}
    .btn.good{border-color:rgba(43,213,118,.25);color:var(--good)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .note{color:var(--muted);font-size:11px;line-height:1.4;margin-top:8px}
    .muted{color:var(--muted)}.good{color:var(--good)}.bad{color:var(--bad)}.warn{color:var(--warn)}
    .hidden{display:none!important}
    .step{margin-bottom:16px}.stepLabel{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--accent);margin-bottom:8px;font-weight:600}
    .infoBanner{padding:10px 12px;border-radius:10px;border:1px solid rgba(122,167,255,.15);background:rgba(122,167,255,.04);margin-bottom:16px;font-size:13px}
    .infoBanner .k{color:var(--muted);font-size:10px}.infoBanner .v{font-weight:600}
    .chips{display:flex;flex-direction:column;gap:8px}
    .cell{border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px}
    .cell .colorInfo{display:flex;align-items:center;gap:8px;min-width:100px}
    .sw{width:12px;height:12px;border-radius:3px;flex-shrink:0}
    .sw.b{background:var(--b)}.sw.p{background:var(--p)}.sw.y{background:var(--y)}.sw.pk{background:var(--pk)}.sw.o{background:var(--o)}
    .cname{font-size:13px;font-weight:600;color:var(--text)}.cval{font-size:11px;color:var(--muted)}
    .cell[data-color="black"]{background:rgba(59,69,87,.25);border:1px solid rgba(59,69,87,.30)}
    .cell[data-color="purple"]{background:rgba(124,58,237,.10);border:1px solid rgba(124,58,237,.18)}
    .cell[data-color="yellow"]{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.16)}
    .cell[data-color="pink"]{background:rgba(236,72,153,.08);border:1px solid rgba(236,72,153,.16)}
    .cell[data-color="orange"]{background:rgba(249,115,22,.08);border:1px solid rgba(249,115,22,.16)}
    [data-theme="light"] .cell[data-color="black"]{background:rgba(59,69,87,.06);border-color:rgba(59,69,87,.12)}
    [data-theme="light"] .cell[data-color="purple"]{background:rgba(124,58,237,.05);border-color:rgba(124,58,237,.12)}
    [data-theme="light"] .cell[data-color="yellow"]{background:rgba(245,158,11,.05);border-color:rgba(245,158,11,.12)}
    [data-theme="light"] .cell[data-color="pink"]{background:rgba(236,72,153,.05);border-color:rgba(236,72,153,.12)}
    [data-theme="light"] .cell[data-color="orange"]{background:rgba(249,115,22,.05);border-color:rgba(249,115,22,.12)}
    .stepper{display:flex;align-items:stretch;border-radius:8px;overflow:hidden;border:1px solid var(--input-border);background:var(--input-bg);flex:1;max-width:180px}
    .stepper input{border:none;border-radius:0;text-align:center;padding:10px 2px;min-width:0;flex:1;background:transparent;font-size:16px}
    .stepper input:focus{box-shadow:none}
    .stepper .sbtn{display:flex;align-items:center;justify-content:center;width:44px;min-width:44px;background:var(--hover);color:var(--muted);cursor:pointer;user-select:none;touch-action:manipulation;font-size:20px;font-weight:700;border:none;transition:all .12s}
    .stepper .sbtn:hover{color:var(--text)}.stepper .sbtn:active{background:rgba(122,167,255,.15)}
    /* Results bar */
    .resultsBar{padding:14px;border-radius:10px;border:1px solid var(--card-border);background:var(--input-bg);margin:16px 0}
    .resultsBar .row{display:flex;justify-content:space-between;padding:4px 0;font-size:13px}
    .resultsBar .row.big{font-size:16px;font-weight:800;padding:8px 0 2px}
    .resultsBar .lbl{color:var(--muted)}.resultsBar .val{font-weight:600}
    .successCard{text-align:center;padding:32px 16px}
    .successCard .icon{font-size:48px;margin-bottom:12px}
    .successCard h2{margin:0 0 8px;font-size:18px}
    .toastBox{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none}
    .toast{padding:9px 16px;border-radius:10px;background:var(--bg2);border:1px solid var(--card-border);color:var(--text);font-size:12px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.25);opacity:0;transform:translateY(-8px) scale(.96);animation:toastIn .25s ease forwards;pointer-events:auto}
    .toast.out{animation:toastOut .2s ease forwards}
    @keyframes toastIn{to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes toastOut{to{opacity:0;transform:translateY(-8px) scale(.96)}}
    .spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .errorBox{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,92,122,.25);background:rgba(255,92,122,.06);color:var(--bad);font-size:13px;margin-top:10px;display:none}
    .warnBox{padding:10px 12px;border-radius:10px;border:1px solid rgba(245,158,11,.25);background:rgba(245,158,11,.06);color:var(--warn);font-size:13px;margin-top:10px;display:none}
    .themeToggle{position:fixed;top:12px;right:12px;z-index:100;width:36px;height:36px;border-radius:10px;border:1px solid var(--card-border);background:var(--bg2);color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:var(--sh)}
    .debugPanel{position:fixed;bottom:0;left:0;right:0;z-index:999;max-height:30vh;overflow-y:auto;background:rgba(0,0,0,.92);border-top:1px solid rgba(255,255,255,.15);font-family:ui-monospace,monospace;font-size:10px;padding:8px;display:none}
    .debugPanel.open{display:block}
    .debugToggle{position:fixed;bottom:8px;right:8px;z-index:1000;width:32px;height:32px;border-radius:50%;background:var(--bg2);border:1px solid var(--card-border);color:var(--muted);display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;box-shadow:var(--sh)}
    .debugToggle.has-error{color:var(--bad);border-color:rgba(255,92,122,.30)}
    .dline{padding:2px 0;border-bottom:1px solid rgba(255,255,255,.04);word-break:break-all;color:#ccc}
    .dline.ok{color:#2bd576}.dline.err{color:#ff5c7a}.dline.info{color:#7aa7ff}.dline.data{color:#888}
    .nameOption{padding:8px 0;display:flex;justify-content:space-between;align-items:center}
    .nameOption .tag{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
    .nameOption .tag.claimed{background:rgba(255,92,122,.12);color:var(--bad)}
    .nameOption .tag.adminLock{background:rgba(245,158,11,.12);color:var(--warn)}
    .nameOption .tag.yours{background:rgba(43,213,118,.12);color:var(--good)}
  </style>
</head>
<body>
<div class="toastBox" id="toastBox"></div>
<button class="themeToggle" id="themeToggle" type="button">üåô</button>
<div class="debugToggle" id="debugToggle">üêõ</div>
<div class="debugPanel" id="debugPanel"></div>

<div class="iplHeader">
  <div class="iplLogo"><span class="suit blk">‚ô†</span><span class="suit red">‚ô•</span> IPL <span class="suit red">‚ô¶</span><span class="suit blk">‚ô£</span></div>
  <div class="iplSub">Innovation Poker League</div>
</div>

<div class="wrap">
  <div class="card">
    <div class="hd"><h1>Poker Cashout</h1><div class="sub">Enter your chip count at the end of the game</div></div>
    <div class="bd" id="joinScreen">
      <div class="step">
        <div class="stepLabel">Step 1 ‚Äî Join Session</div>
        <label>Session code (from the host)</label>
        <input id="codeInput" type="text" placeholder="e.g. WUUV" autocapitalize="characters" maxlength="12" style="text-transform:uppercase;letter-spacing:2px;text-align:center;font-size:20px;font-weight:700"/>
      </div>
      <button class="btn" id="joinBtn" type="button">Join Session</button>
      <div id="joinError" class="errorBox"></div>
      <div class="note" style="text-align:center">Ask the host for the session code</div>
    </div>
    <div class="bd hidden" id="nameScreen">
      <div id="sessionInfo" class="infoBanner"></div>
      <div class="step">
        <div class="stepLabel">Step 2 ‚Äî Who are you?</div>
        <label>Pick your name</label>
        <select id="nameSelect" style="font-size:16px"><option value="">Choose your name‚Ä¶</option></select>
        <div id="nameWarn" class="warnBox"></div>
      </div>
      <button class="btn" id="confirmName" type="button" disabled>Continue</button>
    </div>
    <div class="bd hidden" id="chipScreen">
      <div id="chipPlayerName" style="font-size:15px;font-weight:700;margin-bottom:4px"></div>
      <div class="note" style="margin-top:0;margin-bottom:14px">Count your chips by color and enter the totals</div>
      <div id="adminLockWarn" class="warnBox" style="display:none;margin-bottom:12px">The host has already entered your cashout. Your submission is disabled. Contact the host if this is wrong.</div>
      <div class="chips" id="chipInputs"></div>
      <div class="resultsBar" id="resultsBar">
        <div class="row"><span class="lbl">Cashout value</span><span class="val" id="rCashout">$0.00</span></div>
        <div class="row"><span class="lbl">Buy-ins</span><span class="val" id="rBuyins">1 √ó $50.00 = $50.00</span></div>
        <div class="row"><span class="lbl">RF tax</span><span class="val" id="rTax">$0.00</span></div>
        <div class="sep" style="margin:6px 0"></div>
        <div class="row big"><span class="lbl">Your net</span><span class="val" id="rNet">$0.00</span></div>
      </div>
      <button class="btn good" id="submitChips" type="button">Submit Cashout</button>
      <div id="submitError" class="errorBox"></div>
      <div class="note" style="text-align:center">You can re-submit if you made a mistake</div>
    </div>
    <div class="bd hidden" id="successScreen">
      <div class="successCard">
        <div class="icon">‚úÖ</div>
        <h2>Cashout Submitted!</h2>
        <div class="muted" id="successDetail"></div>
        <div class="sep"></div>
        <button class="btn" id="resubmitBtn" type="button" style="max-width:240px;margin:0 auto">Edit & Resubmit</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script>
(()=>{
  const THEME_KEY="poker_theme",DEVICE_KEY="poker_device_id";
  let theme=localStorage.getItem(THEME_KEY)||"dark";
  function applyTheme(){document.documentElement.setAttribute("data-theme",theme);document.getElementById("themeToggle").textContent=theme==="dark"?"‚òÄÔ∏è":"üåô";localStorage.setItem(THEME_KEY,theme)}
  applyTheme();
  document.getElementById("themeToggle").addEventListener("click",()=>{theme=theme==="dark"?"light":"dark";applyTheme()});

  // Device ID ‚Äî persistent per browser
  let deviceId=localStorage.getItem(DEVICE_KEY);
  if(!deviceId){deviceId=crypto.randomUUID?crypto.randomUUID():(Math.random().toString(36).slice(2)+Date.now().toString(36));localStorage.setItem(DEVICE_KEY,deviceId)}

  const debugEl=document.getElementById("debugPanel"),debugBtn=document.getElementById("debugToggle");
  let debugOpen=false;
  debugBtn.addEventListener("click",()=>{debugOpen=!debugOpen;debugEl.classList.toggle("open",debugOpen)});
  function dlog(msg,type="info"){const d=document.createElement("div");d.className="dline "+type;d.textContent=`[${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})}] ${msg}`;debugEl.appendChild(d);debugEl.scrollTop=debugEl.scrollHeight;if(type==="err")debugBtn.classList.add("has-error");console.log(`[${type}]`,msg)}

  let db;
  try{firebase.initializeApp({apiKey:"AIzaSyCZKgCKh9qxBcW0Gf3LmQFMsFfVB16rwCM",authDomain:"poker-cashout-bde23.firebaseapp.com",databaseURL:"https://poker-cashout-bde23-default-rtdb.firebaseio.com",projectId:"poker-cashout-bde23",storageBucket:"poker-cashout-bde23.firebasestorage.app",messagingSenderId:"1054875878552",appId:"1:1054875878552:web:94d610f9d20a18bed07ced"});db=firebase.database();dlog("Firebase OK","ok");dlog("Device: "+deviceId.slice(0,8)+"‚Ä¶","data")}catch(err){dlog("Firebase FAILED: "+err.message,"err");return}

  const COLORS=["black","purple","yellow","pink","orange"],SW={black:"b",purple:"p",yellow:"y",pink:"pk",orange:"o"};
  const $=id=>document.getElementById(id),clamp=v=>Number.isFinite(v)?v:0;
  const fmtUsd=x=>clamp(x).toLocaleString(undefined,{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2});
  function toast(msg,dur=2200){const box=$("toastBox"),el=document.createElement("div");el.className="toast";el.textContent=msg;box.appendChild(el);setTimeout(()=>{el.classList.add("out");setTimeout(()=>el.remove(),220)},dur)}
  function showError(id,msg){const el=$(id);el.textContent=msg;el.style.display=msg?"block":"none"}

  let sessionCode="",sessionData=null,selectedPlayer="",chipCounts={black:0,purple:0,yellow:0,pink:0,orange:0};
  let playerBuyinCount=1,isAdminLocked=false;

  function showScreen(id){["joinScreen","nameScreen","chipScreen","successScreen"].forEach(s=>$(s).classList.toggle("hidden",s!==id));dlog("Screen: "+id,"info")}

  // ‚îÄ‚îÄ Step 1: Join ‚îÄ‚îÄ
  $("joinBtn").addEventListener("click",async()=>{
    showError("joinError","");
    const raw=$("codeInput").value.trim().toUpperCase().replace(/[^A-Z0-9]/g,"");
    if(!raw){showError("joinError","Enter a session code");return}
    dlog("Joining: "+raw,"info");$("joinBtn").innerHTML='<span class="spinner"></span> Joining‚Ä¶';$("joinBtn").disabled=true;
    try{
      const snap=await db.ref("sessions/"+raw+"/config").once("value"),data=snap.val();
      if(!data||!data.playerNames||!Array.isArray(data.playerNames)){dlog("Not found","err");showError("joinError","Session not found.");$("joinBtn").innerHTML="Join Session";$("joinBtn").disabled=false;return}
      sessionCode=raw;sessionData=data;
      $("sessionInfo").innerHTML=`<div class="k">Session</div><div class="v">${data.sessionName||raw}</div><div style="margin-top:6px;font-size:12px;color:var(--muted)">Buy-in: ${fmtUsd(data.buyinUsd||50)} ¬∑ Players: ${data.playerNames.length}</div>`;

      // Fetch cashout data to check claims, admin locks, submissions
      const cashSnap=await db.ref("sessions/"+raw+"/cashouts").once("value");
      const cashData=cashSnap.val()||{};

      const sel=$("nameSelect");sel.innerHTML='<option value="">Choose your name‚Ä¶</option>';
      data.playerNames.forEach(n=>{
        const opt=document.createElement("option");opt.value=n;
        const cd=cashData[n]||{};
        const isClaimed=!!cd.claimedBy;
        const isMyDevice=cd.claimedBy===deviceId;
        const isSubmitted=!!cd.submitted;
        const isAdminOvr=!!cd.adminOverride;

        if(isAdminOvr){
          opt.textContent=n+" üîí (host entered)";
          opt.disabled=true;
        }else if(isSubmitted&&!isMyDevice){
          opt.textContent=n+" ‚úì (submitted)";
          opt.disabled=true;
        }else if(isClaimed&&!isMyDevice){
          opt.textContent=n+" (in use by another player)";
          opt.disabled=true;
        }else if(isMyDevice&&isSubmitted){
          opt.textContent=n+" ‚úì (your submission)";
        }else if(isMyDevice){
          opt.textContent=n+" (your claim)";
        }else{
          opt.textContent=n;
        }
        sel.appendChild(opt);
      });
      showScreen("nameScreen");toast("Session found ‚úì");
    }catch(err){dlog("Error: "+err.message,"err");showError("joinError","Connection error: "+err.message)}
    $("joinBtn").innerHTML="Join Session";$("joinBtn").disabled=false;
  });
  $("codeInput").addEventListener("keydown",e=>{if(e.key==="Enter")$("joinBtn").click()});

  // ‚îÄ‚îÄ Step 2: Pick name ‚îÄ‚îÄ
  $("nameSelect").addEventListener("change",()=>{$("confirmName").disabled=!$("nameSelect").value;showError("nameWarn","")});

  $("confirmName").addEventListener("click",async()=>{
    selectedPlayer=$("nameSelect").value;if(!selectedPlayer)return;
    dlog("Player: "+selectedPlayer,"info");

    // Claim the name in Firebase
    try{
      const ref=db.ref("sessions/"+sessionCode+"/cashouts/"+selectedPlayer);
      const snap=await ref.once("value");
      const existing=snap.val()||{};

      // Check admin override
      if(existing.adminOverride){
        showError("nameWarn","The host has already entered your cashout. Contact the host.");
        return;
      }

      // Check if claimed by another device
      if(existing.claimedBy&&existing.claimedBy!==deviceId&&!existing.submitted){
        // Another device claimed but didn't submit ‚Äî allow override after warning
        dlog("Overriding stale claim","info");
      }

      // Write claim
      await ref.update({claimedBy:deviceId,claimTime:Date.now()});
      dlog("Name claimed","ok");
    }catch(err){dlog("Claim error: "+err.message,"err")}

    $("chipPlayerName").textContent=selectedPlayer;
    chipCounts={black:0,purple:0,yellow:0,pink:0,orange:0};
    isAdminLocked=false;

    // Read existing data + buy-in count
    try{
      const snap=await db.ref("sessions/"+sessionCode+"/cashouts/"+selectedPlayer).once("value");
      const ex=snap.val()||{};

      // Check admin override
      if(ex.adminOverride){
        isAdminLocked=true;
        COLORS.forEach(c=>{chipCounts[c]=clamp(ex[c]||0)});
        dlog("Admin locked ‚Äî read only","warn");
      }else if(ex.submitted){
        COLORS.forEach(c=>{chipCounts[c]=clamp(ex[c]||0)});
        dlog("Pre-filled from previous submission","ok");
        toast("Previous submission loaded");
      }

      // Read buy-in count
      playerBuyinCount=clamp(ex.buyinCount||1);
      if(playerBuyinCount<1)playerBuyinCount=1;
      dlog("Buy-ins: "+playerBuyinCount,"data");
    }catch(err){dlog("Read error: "+err.message,"err")}

    renderChipInputs();
    showScreen("chipScreen");
  });

  // ‚îÄ‚îÄ Step 3: Chips ‚îÄ‚îÄ
  function renderChipInputs(){
    const cv=sessionData?.chipValues||{};
    const dis=isAdminLocked?"disabled":"";
    $("chipInputs").innerHTML=COLORS.map(c=>`<div class="cell" data-color="${c}"><div class="colorInfo"><span class="sw ${SW[c]}"></span><div><div class="cname">${c[0].toUpperCase()+c.slice(1)}</div><div class="cval">${(cv[c]||0).toLocaleString()} units</div></div></div><div class="stepper"><button class="sbtn" type="button" data-step="-1" data-c="${c}" ${dis}>‚àí</button><input type="number" step="1" inputmode="numeric" data-c="${c}" value="${chipCounts[c]}" placeholder="0" ${dis}/><button class="sbtn" type="button" data-step="1" data-c="${c}" ${dis}>+</button></div></div>`).join("");
    $("adminLockWarn").style.display=isAdminLocked?"block":"none";
    $("submitChips").disabled=isAdminLocked;
    $("submitChips").textContent=isAdminLocked?"Locked by host":"Submit Cashout";
    updateResults();
  }

  function updateResults(){
    const cv=sessionData?.chipValues||{};
    const buyinUsd=sessionData?.buyinUsd||50;
    const taxRate=sessionData?.taxRate||0.30;
    const units=COLORS.reduce((s,c)=>s+clamp(chipCounts[c])*clamp(cv[c]),0);
    const gross=units/1000;
    const totalBuyin=playerBuyinCount*buyinUsd;
    const taxable=Math.max(0,gross-totalBuyin);
    const rf=taxable*taxRate;
    const finalPay=gross-rf;
    const net=finalPay-totalBuyin;

    $("rCashout").textContent=fmtUsd(gross);
    $("rBuyins").textContent=`${playerBuyinCount} √ó ${fmtUsd(buyinUsd)} = ${fmtUsd(totalBuyin)}`;
    $("rTax").textContent=fmtUsd(rf);
    const netEl=$("rNet");
    netEl.textContent=(net>=0?"+":"")+fmtUsd(net);
    netEl.className="val "+(net>0.01?"good":(net<-0.01?"bad":""));
  }

  document.addEventListener("click",e=>{const btn=e.target.closest(".sbtn");if(!btn||isAdminLocked)return;e.preventDefault();const step=Number(btn.dataset.step)||0,c=btn.dataset.c;if(!c||!COLORS.includes(c))return;chipCounts[c]=Math.max(0,(chipCounts[c]||0)+step);btn.parentElement.querySelector("input").value=chipCounts[c];updateResults()});
  document.addEventListener("input",e=>{const c=e.target?.dataset?.c;if(!c||!COLORS.includes(c)||isAdminLocked)return;chipCounts[c]=Math.max(0,parseInt(e.target.value,10)||0);updateResults()});

  // ‚îÄ‚îÄ Submit ‚îÄ‚îÄ
  $("submitChips").addEventListener("click",async()=>{
    if(isAdminLocked)return;
    showError("submitError","");

    // Re-check admin override before submitting
    try{
      const snap=await db.ref("sessions/"+sessionCode+"/cashouts/"+selectedPlayer+"/adminOverride").once("value");
      if(snap.val()){
        isAdminLocked=true;renderChipInputs();
        showError("submitError","The host just entered your cashout. Your submission is blocked.");
        return;
      }
    }catch(e){}

    $("submitChips").innerHTML='<span class="spinner"></span> Submitting‚Ä¶';$("submitChips").disabled=true;
    try{
      const payload={submitted:true,timestamp:Date.now(),claimedBy:deviceId};
      COLORS.forEach(c=>{payload[c]=chipCounts[c]});
      // Preserve buyinCount from admin
      payload.buyinCount=playerBuyinCount;
      dlog("Submitting","data");
      await db.ref("sessions/"+sessionCode+"/cashouts/"+selectedPlayer).update(payload);
      dlog("OK","ok");

      const cv=sessionData?.chipValues||{};
      const units=COLORS.reduce((s,c)=>s+clamp(chipCounts[c])*clamp(cv[c]),0);
      const gross=units/1000;
      const totalBuyin=playerBuyinCount*(sessionData?.buyinUsd||50);
      const taxable=Math.max(0,gross-totalBuyin);
      const rf=taxable*(sessionData?.taxRate||.30);
      const net=(gross-rf)-totalBuyin;

      $("successDetail").innerHTML=`<b>${selectedPlayer}</b><br>Cashout: ${fmtUsd(gross)}<br>Net: <span class="${net>=0?"good":"bad"}">${net>=0?"+":""}${fmtUsd(net)}</span><br><span style="font-size:11px;display:block;margin-top:4px">The host sees this in real-time</span>`;
      showScreen("successScreen");toast("Submitted ‚úì");
    }catch(err){dlog("FAIL: "+err.message,"err");showError("submitError","Error: "+err.message)}
    $("submitChips").innerHTML="Submit Cashout";$("submitChips").disabled=false;
  });

  $("resubmitBtn").addEventListener("click",()=>{
    if(isAdminLocked){toast("Locked by host");return}
    renderChipInputs();showScreen("chipScreen");
  });

  const params=new URLSearchParams(window.location.search),urlCode=(params.get("code")||params.get("session")||"").trim().toUpperCase();
  if(urlCode){$("codeInput").value=urlCode;dlog("Auto-code: "+urlCode,"info");setTimeout(()=>$("joinBtn").click(),500)}
  // Auto-select on focus, restore 0 on blur
  document.addEventListener("focus",e=>{const t=e.target;if(t&&t.type==="number"&&t.closest(".stepper,.chips")){t.select()}},true);
  document.addEventListener("blur",e=>{const t=e.target;if(t&&t.type==="number"&&t.closest(".stepper,.chips")){if(t.value===""||t.value===null)t.value="0"}},true);

  dlog("Ready ¬∑ Device: "+deviceId.slice(0,8),"ok");
})();
</script>
</body>
</html>
