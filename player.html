<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <title>IPL ‚Äì Poker Cashout</title>
  <link rel="manifest" href="manifest.json"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="theme-color" content="#1a1f2e"/>
  <style>
    [data-theme="dark"]{--bg:#1a1f2e;--bg2:#242938;--text:#e8eefc;--muted:#8b95b0;--line:rgba(255,255,255,.08);--card-border:rgba(255,255,255,.08);--input-bg:rgba(0,0,0,.15);--input-border:rgba(255,255,255,.10);--hover:rgba(255,255,255,.04);--good:#2bd576;--warn:#f5c542;--bad:#ff5c7a;--accent:#7aa7ff;--b:#3b4557;--p:#7c3aed;--y:#f59e0b;--pk:#ec4899;--o:#f97316;--sh:0 4px 20px rgba(0,0,0,.25)}
    [data-theme="light"]{--bg:#f0f2f7;--bg2:#ffffff;--text:#1a1f2e;--muted:#5a6278;--line:rgba(0,0,0,.08);--card-border:rgba(0,0,0,.08);--input-bg:rgba(0,0,0,.03);--input-border:rgba(0,0,0,.12);--hover:rgba(0,0,0,.03);--good:#0d9f4f;--warn:#c68a00;--bad:#dc2f4a;--accent:#4a7fdd;--b:#6b7280;--p:#7c3aed;--y:#d97706;--pk:#db2777;--o:#ea580c;--sh:0 2px 12px rgba(0,0,0,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:0 14px 40px;transition:background .3s,color .3s;overscroll-behavior-y:none}
    .iplHeader{text-align:center;padding:20px 14px 10px;padding-top:calc(20px + env(safe-area-inset-top))}
    .iplLogo{display:inline-flex;align-items:center;gap:6px;font-size:28px;font-weight:800;letter-spacing:1px}
    .suit{font-size:20px;opacity:.7}.suit.red{color:var(--bad)}.suit.blk{color:var(--muted)}
    .iplSub{color:var(--muted);font-size:12px;margin-top:2px;letter-spacing:.5px}
    .wrap{max-width:480px;width:100%}
    .card{border:1px solid var(--card-border);border-radius:14px;background:var(--bg2);box-shadow:var(--sh);overflow:hidden}
    .hd{padding:16px;border-bottom:1px solid var(--line);text-align:center}
    .hd h1{margin:0;font-size:18px}.hd .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .bd{padding:16px}
    label{display:block;color:var(--muted);font-size:11px;margin-bottom:5px;font-weight:500}
    input,select,button{font:inherit}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);outline:none;font-size:16px}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(122,167,255,.10)}
    input[type="number"]{appearance:textfield}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border-radius:10px;border:1px solid var(--card-border);background:var(--input-bg);color:var(--text);cursor:pointer;user-select:none;font-size:15px;font-weight:600;touch-action:manipulation}
    .btn:hover{background:var(--hover)}.btn.good{border-color:rgba(43,213,118,.25);color:var(--good)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .note{color:var(--muted);font-size:11px;line-height:1.4;margin-top:8px}
    .muted{color:var(--muted)}.good{color:var(--good)}.bad{color:var(--bad)}
    .hidden{display:none!important}
    .step{margin-bottom:16px}
    .stepLabel{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--accent);margin-bottom:8px;font-weight:600}
    .infoBanner{padding:10px 12px;border-radius:10px;border:1px solid rgba(122,167,255,.15);background:rgba(122,167,255,.04);margin-bottom:16px;font-size:13px}
    .infoBanner .k{color:var(--muted);font-size:10px}.infoBanner .v{font-weight:600}
    .chips{display:flex;flex-direction:column;gap:8px}
    .cell{border-radius:10px;padding:12px;display:flex;align-items:center;gap:12px}
    .cell .colorInfo{display:flex;align-items:center;gap:8px;min-width:100px}
    .sw{width:12px;height:12px;border-radius:3px;flex-shrink:0}
    .sw.b{background:var(--b)}.sw.p{background:var(--p)}.sw.y{background:var(--y)}.sw.pk{background:var(--pk)}.sw.o{background:var(--o)}
    .cname{font-size:13px;font-weight:600;color:var(--text)}.cval{font-size:11px;color:var(--muted)}
    .cell[data-color="black"]{background:rgba(59,69,87,.25);border:1px solid rgba(59,69,87,.30)}
    .cell[data-color="purple"]{background:rgba(124,58,237,.10);border:1px solid rgba(124,58,237,.18)}
    .cell[data-color="yellow"]{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.16)}
    .cell[data-color="pink"]{background:rgba(236,72,153,.08);border:1px solid rgba(236,72,153,.16)}
    .cell[data-color="orange"]{background:rgba(249,115,22,.08);border:1px solid rgba(249,115,22,.16)}
    [data-theme="light"] .cell[data-color="black"]{background:rgba(59,69,87,.06)}
    [data-theme="light"] .cell[data-color="purple"]{background:rgba(124,58,237,.05)}
    [data-theme="light"] .cell[data-color="yellow"]{background:rgba(245,158,11,.05)}
    [data-theme="light"] .cell[data-color="pink"]{background:rgba(236,72,153,.05)}
    [data-theme="light"] .cell[data-color="orange"]{background:rgba(249,115,22,.05)}
    .stepper{display:flex;align-items:stretch;border-radius:8px;overflow:hidden;border:1px solid var(--input-border);background:var(--input-bg);flex:1;max-width:180px}
    .stepper input{border:none;border-radius:0;text-align:center;padding:10px 2px;min-width:0;flex:1;background:transparent;font-size:16px}
    .stepper input:focus{box-shadow:none}
    .stepper .sbtn{display:flex;align-items:center;justify-content:center;width:44px;min-width:44px;background:var(--hover);color:var(--muted);cursor:pointer;user-select:none;touch-action:manipulation;font-size:20px;font-weight:700;border:none}
    .stepper .sbtn:active{background:rgba(122,167,255,.15)}
    .presetBar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .presetBtn{padding:7px 12px;border-radius:8px;border:1px solid var(--card-border);background:var(--hover);font-size:12px;font-weight:600;cursor:pointer;color:var(--text)}
    .presetBtn:hover{border-color:var(--accent)}.presetBtn.on{border-color:var(--accent);background:rgba(122,167,255,.12)}
    .resultsBar{padding:14px;border-radius:10px;border:1px solid var(--card-border);background:var(--input-bg);margin:16px 0}
    .resultsBar .rw{display:flex;justify-content:space-between;padding:4px 0;font-size:13px}
    .resultsBar .rw.big{font-size:16px;font-weight:800;padding:8px 0 2px}
    .resultsBar .lbl{color:var(--muted)}.resultsBar .val{font-weight:600}
    .successCard{text-align:center;padding:32px 16px}
    .successCard .icon{font-size:48px;margin-bottom:12px}
    .successCard h2{margin:0 0 8px;font-size:18px}
    .resultsCard{text-align:center;padding:20px 12px}
    .resultsCard h2{margin:0 0 4px;font-size:18px}
    .resultsList{text-align:left;margin-top:14px}
    .resultRow{display:flex;justify-content:space-between;padding:10px 12px;border:1px solid var(--card-border);border-radius:10px;margin-top:6px;background:var(--input-bg);align-items:center}
    .resultRow.you{border-color:var(--accent);background:rgba(122,167,255,.06)}
    .resultRow .rName{font-weight:600;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:160px}
    .resultRow .rVal{font-weight:700;font-size:13px}
    .disclaimer{text-align:center;padding:20px 14px;margin-top:20px;color:var(--muted);font-size:11px;line-height:1.5;opacity:.6}
    .toastBox{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none}
    .toast{padding:9px 16px;border-radius:10px;background:var(--bg2);border:1px solid var(--card-border);color:var(--text);font-size:12px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.25);opacity:0;transform:translateY(-8px) scale(.96);animation:toastIn .25s ease forwards;pointer-events:auto}
    .toast.out{animation:toastOut .2s ease forwards}
    @keyframes toastIn{to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes toastOut{to{opacity:0;transform:translateY(-8px) scale(.96)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
    .errorBox{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,92,122,.25);background:rgba(255,92,122,.06);color:var(--bad);font-size:13px;margin-top:10px;display:none}
    .warnBox{padding:10px 12px;border-radius:10px;border:1px solid rgba(245,158,11,.25);background:rgba(245,158,11,.06);color:var(--warn);font-size:13px;margin-top:10px;display:none}
    .themeToggle{position:fixed;top:12px;right:12px;z-index:100;width:36px;height:36px;border-radius:10px;border:1px solid var(--card-border);background:var(--bg2);color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:var(--sh)}
    .offlineBanner{position:fixed;top:0;left:0;right:0;z-index:300;padding:10px 14px;padding-top:calc(10px + env(safe-area-inset-top));background:#dc2626;color:#fff;text-align:center;font-size:13px;font-weight:600;display:none}
    .offlineBanner.show{display:block}
    .confettiCanvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999}
  </style>
</head>
<body>
<div class="toastBox" id="toastBox"></div>
<div class="offlineBanner" id="offlineBanner">‚ö†Ô∏è No internet ‚Äî submissions won't work</div>
<button class="themeToggle" id="themeToggle" type="button">üåô</button>

<div class="iplHeader"><div class="iplLogo"><span class="suit blk">‚ô†</span><span class="suit red">‚ô•</span> IPL <span class="suit red">‚ô¶</span><span class="suit blk">‚ô£</span></div><div class="iplSub">Innovation Poker League</div></div>

<div class="wrap">
  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center"><a href="index.html" style="padding:8px 14px;border-radius:10px;background:var(--accent);color:#fff;font-size:13px;font-weight:600;text-decoration:none">‚ô† Admin</a><a href="rf-fund.html" style="padding:8px 14px;border-radius:10px;border:1px solid var(--card-border);background:var(--bg2);color:var(--muted);font-size:13px;font-weight:600;text-decoration:none">üí∞ RF Fund</a><a href="analytics.html" style="padding:8px 14px;border-radius:10px;border:1px solid var(--card-border);background:var(--bg2);color:var(--muted);font-size:13px;font-weight:600;text-decoration:none">üìä Analytics</a></div>
  <div class="card">
    <div class="hd"><h1>Poker Cashout</h1><div class="sub">Enter your chip count at the end of the game</div></div>

    <!-- Join -->
    <div class="bd" id="joinScreen">
      <div class="step"><div class="stepLabel">Step 1 ‚Äî Join Session</div>
        <label>Session code (from the host)</label>
        <input id="codeInput" type="text" placeholder="e.g. WUUV" autocapitalize="characters" maxlength="12" style="text-transform:uppercase;letter-spacing:2px;text-align:center;font-size:20px;font-weight:700"/>
      </div>
      <button class="btn" id="joinBtn" type="button">Join Session</button>
      <div id="joinError" class="errorBox"></div>
    </div>

    <!-- Name -->
    <div class="bd hidden" id="nameScreen">
      <div id="sessionInfo" class="infoBanner"></div>
      <div class="step"><div class="stepLabel">Step 2 ‚Äî Who are you?</div>
        <label>Pick your name</label>
        <select id="nameSelect" style="font-size:16px"><option value="">Choose your name‚Ä¶</option></select>
        <div id="nameWarn" class="warnBox"></div>
      </div>
      <button class="btn" id="confirmName" type="button" disabled>Continue</button>
    </div>

    <!-- Chips -->
    <div class="bd hidden" id="chipScreen">
      <div id="chipPlayerName" style="font-size:15px;font-weight:700;margin-bottom:4px"></div>
      <div class="note" style="margin-top:0;margin-bottom:10px">Count your chips by color ‚Äî or use a quick preset</div>
      <div id="adminLockWarn" class="warnBox" style="display:none;margin-bottom:12px">The host entered your cashout. Submission disabled.</div>
      <div class="presetBar" id="presetBar"></div>
      <div class="chips" id="chipInputs"></div>
      <div class="resultsBar">
        <div class="rw"><span class="lbl">Cashout value</span><span class="val" id="rCashout">‚Ç•0.00</span></div>
        <div class="rw"><span class="lbl">Buy-ins</span><span class="val" id="rBuyins">1 √ó ‚Ç•50.00 = ‚Ç•50.00</span></div>
        <div class="rw"><span class="lbl">RF tax</span><span class="val" id="rTax">‚Ç•0.00</span></div>
        <div class="sep" style="margin:6px 0"></div>
        <div class="rw big"><span class="lbl">Your net</span><span class="val" id="rNet">‚Ç•0.00</span></div>
      </div>
      <button class="btn good" id="submitChips" type="button">Submit Cashout</button>
      <div id="submitError" class="errorBox"></div>
      <div class="note" style="text-align:center">You can re-submit if you made a mistake</div>
    </div>

    <!-- Success -->
    <div class="bd hidden" id="successScreen">
      <div class="successCard">
        <div class="icon">‚úÖ</div>
        <h2>Cashout Submitted!</h2>
        <div class="muted" id="successDetail"></div>
        <div class="sep"></div>
        <button class="btn" id="resubmitBtn" type="button" style="max-width:240px;margin:0 auto">Edit & Resubmit</button>
        <div class="note" style="margin-top:12px;text-align:center">Waiting for host to lock‚Ä¶<br>Results appear automatically.</div>
      </div>
    </div>

    <!-- Results -->
    <div class="bd hidden" id="resultsScreen">
      <div class="resultsCard">
        <div style="font-size:32px">üèÜ</div>
        <h2>Session Complete!</h2>
        <div class="muted" id="resultsSessionName"></div>
        <div class="resultsList" id="resultsList"></div>
      </div>
    </div>
  </div>

  <div class="disclaimer">
    üÉè <b>Innovation Poker League</b><br>
    Data accuracy depends on honest submissions ‚Äî we trust you (but the audit table doesn't üëÄ).<br>
    <a href="odds.html" style="color:var(--accent);text-decoration:none;font-weight:600">üé≤ Poker Odds Calculator ‚Üí</a>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script>
(()=>{
  // Theme
  const THEME_KEY="poker_theme",DEVICE_KEY="poker_device_id";
  let theme=localStorage.getItem(THEME_KEY)||"dark";
  function applyTheme(){document.documentElement.setAttribute("data-theme",theme);document.getElementById("themeToggle").textContent=theme==="dark"?"‚òÄÔ∏è":"üåô";localStorage.setItem(THEME_KEY,theme)}
  applyTheme();
  document.getElementById("themeToggle").addEventListener("click",()=>{theme=theme==="dark"?"light":"dark";applyTheme()});

  // Device ID
  let deviceId=localStorage.getItem(DEVICE_KEY);
  if(!deviceId){deviceId=crypto.randomUUID?crypto.randomUUID():(Math.random().toString(36).slice(2)+Date.now().toString(36));localStorage.setItem(DEVICE_KEY,deviceId)}

  // Firebase
  let db;
  try{
    firebase.initializeApp({apiKey:"AIzaSyCZKgCKh9qxBcW0Gf3LmQFMsFfVB16rwCM",authDomain:"poker-cashout-bde23.firebaseapp.com",databaseURL:"https://poker-cashout-bde23-default-rtdb.firebaseio.com",projectId:"poker-cashout-bde23",storageBucket:"poker-cashout-bde23.firebasestorage.app",messagingSenderId:"1054875878552",appId:"1:1054875878552:web:94d610f9d20a18bed07ced"});
    db=firebase.database();
    firebase.auth().signInAnonymously().catch(()=>{});
  }catch(err){document.body.innerHTML='<p style="color:red;padding:40px;text-align:center">Firebase failed</p>';return}

  // Constants
  const COLORS=["black","purple","yellow","pink","orange"];
  const SW={black:"b",purple:"p",yellow:"y",pink:"pk",orange:"o"};
  const PRESETS=[
    {key:"std",label:"üé∞ Standard",chips:{black:15,purple:3,yellow:12,pink:3,orange:2}},
    {key:"half",label:"¬Ω Half",chips:{black:8,purple:2,yellow:6,pink:2,orange:1}},
    {key:"heavy",label:"üí∞ Heavy",chips:{black:20,purple:5,yellow:15,pink:5,orange:3}},
    {key:"light",label:"ü™∂ Light",chips:{black:10,purple:2,yellow:8,pink:2,orange:1}},
    {key:"zero",label:"‚úï Clear",chips:{black:0,purple:0,yellow:0,pink:0,orange:0}}
  ];

  const $=id=>document.getElementById(id);
  const clamp=v=>Number.isFinite(v)?v:0;
  const fmtUsd=x=>{const v=clamp(x).toLocaleString(undefined,{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2});return v.replace(/\$/g,"‚Ç•")};
  function toast(msg,dur=2200){const box=$("toastBox"),el=document.createElement("div");el.className="toast";el.textContent=msg;box.appendChild(el);setTimeout(()=>{el.classList.add("out");setTimeout(()=>el.remove(),220)},dur)}
  function showError(id,msg){const el=$(id);if(!el)return;el.textContent=msg;el.style.display=msg?"block":"none"}

  let sessionCode="",sessionData=null,selectedPlayer="";
  let chipCounts={black:0,purple:0,yellow:0,pink:0,orange:0};
  let playerBuyinCount=1,isAdminLocked=false;

  function showScreen(id){["joinScreen","nameScreen","chipScreen","successScreen","resultsScreen"].forEach(s=>$(s).classList.toggle("hidden",s!==id))}

  // ‚îÄ‚îÄ JOIN ‚îÄ‚îÄ
  $("joinBtn").addEventListener("click",async()=>{
    showError("joinError","");
    const raw=$("codeInput").value.trim().toUpperCase().replace(/[^A-Z0-9]/g,"");
    if(!raw){showError("joinError","Enter a session code");return}
    $("joinBtn").innerHTML='<span class="spinner"></span> Joining‚Ä¶';$("joinBtn").disabled=true;
    try{
      const snap=await db.ref("sessions/"+raw+"/config").once("value");
      const data=snap.val();
      if(!data||!data.playerNames||!Array.isArray(data.playerNames)){
        showError("joinError","Session not found. Check code.");
        $("joinBtn").innerHTML="Join Session";$("joinBtn").disabled=false;return;
      }
      sessionCode=raw;sessionData=data;
      try{localStorage.setItem("poker_last_session",raw)}catch(e){}

      $("sessionInfo").innerHTML=`<div class="k">Session</div><div class="v">${data.sessionName||raw}</div><div style="margin-top:6px;font-size:12px;color:var(--muted)">Buy-in: ${fmtUsd(data.buyinUsd||50)} ¬∑ Players: ${data.playerNames.length}</div>`;

      // Check who's claimed/submitted
      const cashSnap=await db.ref("sessions/"+raw+"/cashouts").once("value");
      const cashData=cashSnap.val()||{};
      const sel=$("nameSelect");
      sel.innerHTML='<option value="">Choose your name‚Ä¶</option>';
      data.playerNames.forEach(n=>{
        const opt=document.createElement("option");opt.value=n;
        const pd=cashData[n]||{};
        if(pd.adminOverride){opt.textContent=n+" üîí (host entered)";opt.disabled=true}
        else if(pd.submitted&&pd.claimedBy!==deviceId){opt.textContent=n+" ‚úì (submitted)";opt.disabled=true}
        else if(pd.claimedBy&&pd.claimedBy!==deviceId){opt.textContent=n+" (in use)";opt.disabled=true}
        else if(pd.claimedBy===deviceId&&pd.submitted){opt.textContent=n+" ‚úì (yours)"}
        else{opt.textContent=n}
        sel.appendChild(opt);
      });
      showScreen("nameScreen");toast("Session found ‚úì");
    }catch(err){showError("joinError","Connection error")}
    $("joinBtn").innerHTML="Join Session";$("joinBtn").disabled=false;
  });
  $("codeInput").addEventListener("keydown",e=>{if(e.key==="Enter")$("joinBtn").click()});

  // ‚îÄ‚îÄ NAME ‚îÄ‚îÄ
  $("nameSelect").addEventListener("change",()=>{$("confirmName").disabled=!$("nameSelect").value});
  $("confirmName").addEventListener("click",async()=>{
    selectedPlayer=$("nameSelect").value;if(!selectedPlayer)return;
    try{
      const ref=db.ref("sessions/"+sessionCode+"/cashouts/"+selectedPlayer);
      const snap=await ref.once("value");const ex=snap.val()||{};
      if(ex.adminOverride){showError("nameWarn","Host entered your cashout.");return}
      await ref.update({claimedBy:deviceId,claimTime:Date.now()});
    }catch(e){}

    $("chipPlayerName").textContent=selectedPlayer;
    chipCounts={black:0,purple:0,yellow:0,pink:0,orange:0};
    isAdminLocked=false;

    try{
      const snap=await db.ref("sessions/"+sessionCode+"/cashouts/"+selectedPlayer).once("value");
      const ex=snap.val()||{};
      if(ex.adminOverride){isAdminLocked=true;COLORS.forEach(c=>{chipCounts[c]=clamp(ex[c]||0)})}
      else if(ex.submitted){COLORS.forEach(c=>{chipCounts[c]=clamp(ex[c]||0)});toast("Previous submission loaded")}
      playerBuyinCount=Math.max(1,clamp(ex.buyinCount||1));
    }catch(e){}

    renderChips();showScreen("chipScreen");listenForResults();
  });

  // ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ
  function renderChips(){
    const cv=sessionData?.chipValues||{};
    const dis=isAdminLocked?"disabled":"";

    // Presets
    if(isAdminLocked){$("presetBar").innerHTML=""}
    else{$("presetBar").innerHTML=PRESETS.map(p=>`<button class="presetBtn" data-pre="${p.key}" type="button">${p.label}</button>`).join("")}

    // Chip inputs
    $("chipInputs").innerHTML=COLORS.map(c=>`<div class="cell" data-color="${c}"><div class="colorInfo"><span class="sw ${SW[c]}"></span><div><div class="cname">${c[0].toUpperCase()+c.slice(1)}</div><div class="cval">${(cv[c]||0).toLocaleString()} units</div></div></div><div class="stepper"><button class="sbtn" type="button" data-step="-1" data-c="${c}" ${dis}>‚àí</button><input type="number" step="1" inputmode="numeric" min="0" max="999" data-c="${c}" value="${chipCounts[c]}" placeholder="0" ${dis}/><button class="sbtn" type="button" data-step="1" data-c="${c}" ${dis}>+</button></div></div>`).join("");

    $("adminLockWarn").style.display=isAdminLocked?"block":"none";
    $("submitChips").disabled=isAdminLocked;
    $("submitChips").textContent=isAdminLocked?"Locked by host":"Submit Cashout";
    updateResults();
  }

  function updateResults(){
    const cv=sessionData?.chipValues||{};
    const bi=sessionData?.buyinUsd||50;
    const tr=sessionData?.taxRate||.30;
    const units=COLORS.reduce((s,c)=>s+clamp(chipCounts[c])*clamp(cv[c]),0);
    const gross=units/1000;
    const tb=playerBuyinCount*bi;
    const rf=Math.max(0,gross-tb)*tr;
    const net=(gross-rf)-tb;

    $("rCashout").textContent=fmtUsd(gross);
    $("rBuyins").textContent=`${playerBuyinCount} √ó ${fmtUsd(bi)} = ${fmtUsd(tb)}`;
    $("rTax").textContent=fmtUsd(rf);
    const ne=$("rNet");
    ne.textContent=(net>=0?"+":"")+fmtUsd(net);
    ne.className="val "+(net>0.01?"good":(net<-0.01?"bad":""));
  }

  // Stepper +/-
  document.addEventListener("click",e=>{
    const btn=e.target.closest(".sbtn");
    if(btn&&!isAdminLocked){
      e.preventDefault();
      const step=Number(btn.dataset.step)||0;
      const c=btn.dataset.c;
      if(c&&COLORS.includes(c)){
        chipCounts[c]=Math.min(999,Math.max(0,(chipCounts[c]||0)+step));
        const inp=btn.parentElement.querySelector("input");
        if(inp)inp.value=chipCounts[c];
        updateResults();
      }
    }
    // Preset buttons
    const pre=e.target.closest("[data-pre]");
    if(pre&&!isAdminLocked){
      const p=PRESETS.find(x=>x.key===pre.dataset.pre);
      if(!p)return;
      COLORS.forEach(c=>{chipCounts[c]=p.chips[c]||0});
      document.querySelectorAll("#chipInputs input[data-c]").forEach(inp=>{inp.value=chipCounts[inp.dataset.c]});
      document.querySelectorAll(".presetBtn").forEach(b=>b.classList.toggle("on",b.dataset.pre===pre.dataset.pre));
      updateResults();
      toast(p.key==="zero"?"Cleared":p.label+" applied");
    }
  });

  // Manual input
  document.addEventListener("input",e=>{
    const c=e.target?.dataset?.c;
    if(c&&COLORS.includes(c)&&!isAdminLocked){
      chipCounts[c]=Math.min(999,Math.max(0,parseInt(e.target.value,10)||0));
      updateResults();
    }
  });

  // ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ
  $("submitChips").addEventListener("click",async()=>{
    if(isAdminLocked)return;
    showError("submitError","");
    $("submitChips").innerHTML='<span class="spinner"></span> Submitting‚Ä¶';
    $("submitChips").disabled=true;
    try{
      // Transaction to prevent race condition with admin override
      const ref=db.ref("sessions/"+sessionCode+"/cashouts/"+selectedPlayer);
      const payload={submitted:true,timestamp:Date.now(),claimedBy:deviceId,buyinCount:playerBuyinCount};
      COLORS.forEach(c=>{payload[c]=chipCounts[c]});

      const result=await ref.transaction(current=>{
        if(current&&current.adminOverride)return; // abort
        return Object.assign(current||{},payload);
      });

      if(!result.committed){
        isAdminLocked=true;renderChips();
        showError("submitError","Host just locked your cashout.");
        $("submitChips").innerHTML="Submit Cashout";$("submitChips").disabled=false;
        return;
      }

      const cv=sessionData?.chipValues||{};
      const units=COLORS.reduce((s,c)=>s+clamp(chipCounts[c])*clamp(cv[c]),0);
      const gross=units/1000;
      const tb=playerBuyinCount*(sessionData?.buyinUsd||50);
      const rf=Math.max(0,gross-tb)*(sessionData?.taxRate||.30);
      const net=(gross-rf)-tb;

      $("successDetail").innerHTML=`<b>${selectedPlayer}</b><br>Cashout: ${fmtUsd(gross)}<br>Net: <span class="${net>=0?"good":"bad"}">${net>=0?"+":""}${fmtUsd(net)}</span>`;
      showScreen("successScreen");toast("Submitted ‚úì");
      // Ensure results listener is running
      listenForResults();
      // Also poll every 5 seconds as fallback
      startResultsPolling();
    }catch(err){showError("submitError","Error: "+err.message)}
    $("submitChips").innerHTML="Submit Cashout";$("submitChips").disabled=false;
  });

  $("resubmitBtn").addEventListener("click",()=>{
    if(isAdminLocked){toast("Locked by host");return}
    renderChips();showScreen("chipScreen");
  });

  // ‚îÄ‚îÄ RESULTS POLLING FALLBACK ‚îÄ‚îÄ
  let pollInterval=null;
  function startResultsPolling(){
    if(pollInterval||!sessionCode)return;
    console.log("Starting results polling fallback");
    pollInterval=setInterval(async()=>{
      try{
        const snap=await db.ref("sessions/"+sessionCode+"/results").once("value");
        const data=snap.val();
        if(data&&data.locked&&data.players){
          console.log("Poll found results!");
          clearInterval(pollInterval);pollInterval=null;
          showResults(data);
        }
      }catch(e){console.log("Poll error:",e.message)}
    },5000);
  }

  // ‚îÄ‚îÄ SHOW RESULTS (shared by listener + poll) ‚îÄ‚îÄ
  function showResults(data){
    $("resultsSessionName").textContent=sessionData?.sessionName||sessionCode;
    const players=Object.entries(data.players).map(([name,d])=>({name,...d}));
    if(!players.length)return;
    players.sort((a,b)=>(b.net||0)-(a.net||0));
    const medals=["ü•á","ü•à","ü•â"];
    $("resultsList").innerHTML=players.map(p=>{
      const isYou=p.name===selectedPlayer;
      const net=p.net||0;
      const cls=net>0.01?"good":(net<-0.01?"bad":"muted");
      const medal=(data.mode==="tournament"&&p.place>=1&&p.place<=3)?medals[p.place-1]+" ":"";
      const buyinInfo=p.buyins?` ¬∑ ${p.buyins} buy-in${p.buyins>1?"s":""}`:""
      const grossInfo=p.gross?` ¬∑ Gross: ${fmtUsd(p.gross)}`:"";
      const rfInfo=(p.rfTax||p.rf)?` ¬∑ RF: ${fmtUsd(p.rfTax||p.rf)}`:"";
      return`<div class="resultRow ${isYou?"you":""}"><div><span class="rName">${medal}${p.name}</span>${isYou?' <span style="font-size:10px;color:var(--accent)">(you)</span>':""}<br><span style="font-size:10px;color:var(--muted)">${buyinInfo}${grossInfo}${rfInfo}</span></div><div class="rVal ${cls}">${net>=0?"+":""}${fmtUsd(net)}</div></div>`;
    }).join("");
    console.log("Results rendered: "+players.length+" players");
    showScreen("resultsScreen");toast("Results are in! üéâ");
    // Confetti
    try{const cv=document.createElement("canvas");cv.className="confettiCanvas";document.body.appendChild(cv);const ctx=cv.getContext("2d");cv.width=window.innerWidth;cv.height=window.innerHeight;const cs=["#2bd576","#f5c542","#ff5c7a","#7aa7ff","#ec4899"];const pcs=[];for(let i=0;i<80;i++)pcs.push({x:Math.random()*cv.width,y:-Math.random()*cv.height*.5-50,r:Math.random()*5+3,dx:(Math.random()-.5)*3,dy:Math.random()*3+2,rot:Math.random()*360,dr:Math.random()*8-4,c:cs[Math.floor(Math.random()*cs.length)]});let f=0;(function draw(){ctx.clearRect(0,0,cv.width,cv.height);let alive=false;pcs.forEach(p=>{p.x+=p.dx;p.y+=p.dy;p.dy+=.04;p.rot+=p.dr;if(p.y<cv.height+20)alive=true;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot*Math.PI/180);ctx.fillStyle=p.c;ctx.fillRect(-p.r,-p.r/2,p.r*2,p.r);ctx.restore()});f++;if(alive&&f<150)requestAnimationFrame(draw);else cv.remove()})()}catch(e){}
    try{const ac=new(window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator(),g=ac.createGain();o.type="sine";o.frequency.value=784;g.gain.value=.1;o.connect(g);g.connect(ac.destination);o.start();o.stop(ac.currentTime+.3)}catch(e){}
  }

  // ‚îÄ‚îÄ RESULTS LISTENER ‚îÄ‚îÄ
  let resultsListener=null;
  function listenForResults(){
    if(resultsListener||!sessionCode)return;
    console.log("Listening for results at: sessions/"+sessionCode+"/results");
    resultsListener=db.ref("sessions/"+sessionCode+"/results").on("value",snap=>{
      const data=snap.val();
      console.log("Results listener fired:",data?JSON.stringify(data).slice(0,200):"null");
      if(!data||!data.locked||!data.players||typeof data.players!=="object")return;
      if(pollInterval){clearInterval(pollInterval);pollInterval=null}
      showResults(data);
    },err=>{
      console.error("Results listener error:",err);
    });
  }

  // ‚îÄ‚îÄ OFFLINE ‚îÄ‚îÄ
  function updateOnline(){const b=$("offlineBanner");if(!navigator.onLine)b.classList.add("show");else b.classList.remove("show")}
  window.addEventListener("online",()=>{updateOnline();toast("Back online ‚úì")});
  window.addEventListener("offline",updateOnline);
  updateOnline();

  // Focus/blur
  document.addEventListener("focus",e=>{if(e.target?.tagName==="INPUT"&&e.target.type!=="checkbox")e.target.select()},true);
  document.addEventListener("blur",e=>{if(e.target?.type==="number"&&(e.target.value===""||e.target.value===null))e.target.value="0"},true);

  // Auto-fill code
  const params=new URLSearchParams(window.location.search);
  const urlCode=(params.get("code")||params.get("session")||"").trim().toUpperCase();
  if(urlCode){$("codeInput").value=urlCode;setTimeout(()=>$("joinBtn").click(),500)}
  else{try{const last=localStorage.getItem("poker_last_session");if(last)$("codeInput").value=last}catch(e){}}
})();
</script>
</body>
</html>
