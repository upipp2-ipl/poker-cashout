<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <title>IPL ‚Äì Poker Cashout Admin</title>
  <link rel="manifest" href="manifest.json"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="theme-color" content="#1a1f2e"/>
  <style>
    [data-theme="dark"]{--bg:#1a1f2e;--bg2:#242938;--bg3:#2d3348;--text:#e8eefc;--muted:#8b95b0;--line:rgba(255,255,255,.08);--card:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));--card-border:rgba(255,255,255,.08);--input-bg:rgba(0,0,0,.15);--input-border:rgba(255,255,255,.10);--hover:rgba(255,255,255,.04);--good:#2bd576;--warn:#f5c542;--bad:#ff5c7a;--accent:#7aa7ff;--b:#3b4557;--p:#7c3aed;--y:#f59e0b;--pk:#ec4899;--o:#f97316;--sh:0 4px 20px rgba(0,0,0,.25)}
    [data-theme="light"]{--bg:#f0f2f7;--bg2:#ffffff;--bg3:#e8ebf0;--text:#1a1f2e;--muted:#5a6278;--line:rgba(0,0,0,.08);--card:linear-gradient(180deg,#fff,#fafbfd);--card-border:rgba(0,0,0,.08);--input-bg:rgba(0,0,0,.03);--input-border:rgba(0,0,0,.12);--hover:rgba(0,0,0,.03);--good:#0d9f4f;--warn:#c68a00;--bad:#dc2f4a;--accent:#4a7fdd;--b:#6b7280;--p:#7c3aed;--y:#d97706;--pk:#db2777;--o:#ea580c;--sh:0 2px 12px rgba(0,0,0,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);transition:background .3s,color .3s;min-height:100vh;overscroll-behavior-y:none;overflow-x:hidden}
    html{overflow-x:hidden}
    .pullIndicator{position:fixed;top:0;left:0;right:0;z-index:200;display:flex;align-items:center;justify-content:center;height:0;overflow:hidden;background:var(--bg2);border-bottom:1px solid var(--card-border);font-size:12px;color:var(--muted);font-weight:500;transition:height .2s}
    .pullIndicator.pulling{transition:none}.pullIndicator .pullIcon{display:inline-block;margin-right:6px;transition:transform .2s}
    .pullIndicator.ready .pullIcon{transform:rotate(180deg)}.pullIndicator.refreshing .pullIcon{animation:spin .6s linear infinite}
    .iplHeader{text-align:center;padding:20px 14px 10px;padding-top:calc(20px + env(safe-area-inset-top))}
    .iplLogo{display:inline-flex;align-items:center;gap:6px;font-size:28px;font-weight:800;letter-spacing:1px}
    .suit{font-size:20px;opacity:.7}.suit.red{color:var(--bad)}.suit.blk{color:var(--muted)}
    .iplSub{color:var(--muted);font-size:12px;margin-top:2px;letter-spacing:.5px}
    .wrap{max-width:1050px;margin:0 auto;padding:0 14px 0}
    .top{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 14px;border:1px solid var(--card-border);border-radius:14px;background:var(--bg2);box-shadow:var(--sh);margin-bottom:14px;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
    .topPills{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    h1{margin:0;font-size:15px}.sub{color:var(--muted);font-size:11px;margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:5px;padding:6px 10px;border-radius:999px;border:1px solid var(--card-border);background:var(--input-bg);color:var(--muted);font-size:11px;white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;transition:all .3s;backdrop-filter:blur(8px)}
    @media(max-width:480px){.pill{max-width:130px;font-size:10px;padding:5px 8px}}
    .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
    .pill.good .dot{background:var(--good)}.pill.warn .dot{background:var(--warn)}.pill.bad .dot{background:var(--bad)}
    .pill.secondary{background:var(--input-bg)}.pill.live{background:rgba(43,213,118,.10);border-color:rgba(43,213,118,.25);color:var(--good)}
    .pill.live .dot{background:var(--good);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .themeToggle{width:36px;height:36px;border-radius:10px;border:1px solid var(--card-border);background:var(--input-bg);color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .lockedOverlay{position:fixed;bottom:70px;left:12px;right:12px;z-index:40;display:none;padding:10px 12px;border-radius:14px;border:1px solid var(--card-border);background:var(--bg2);box-shadow:var(--sh);max-width:1050px;opacity:.95}
    @media(min-width:1050px){.lockedOverlay{left:50%;transform:translateX(-50%);width:1050px}}
    button[disabled],input[disabled],select[disabled]{opacity:.5;cursor:not-allowed!important}
    .grid{display:grid;gap:14px;margin-top:14px}@media(min-width:900px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{border:1px solid var(--card-border);border-radius:14px;background:var(--card);box-shadow:var(--sh);overflow:hidden;transition:background .3s,transform .15s,box-shadow .15s;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
    .card:hover{box-shadow:0 6px 28px rgba(0,0,0,.3)}
    .hd{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
    .hd h2{margin:0;font-size:13px;font-weight:700}.bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}.row>*{flex:1}
    label{display:block;color:var(--muted);font-size:11px;margin-bottom:5px;font-weight:500}
    input,select,button{font:inherit}
    input,select{width:100%;padding:9px 11px;border-radius:10px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);outline:none;font-size:16px}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(122,167,255,.10)}
    input[type="number"]{appearance:textfield}input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 12px;border-radius:10px;border:1px solid var(--card-border);background:var(--input-bg);color:var(--text);cursor:pointer;user-select:none;touch-action:manipulation;font-size:13px;font-weight:500;transition:all .15s,transform .1s}
    .btn:hover{background:var(--hover);transform:translateY(-1px)}.btn:active{transform:translateY(0)}
    .btn.danger{color:var(--bad);border-color:rgba(255,92,122,.20)}
    .btn.small{padding:6px 10px;font-size:11px;border-radius:8px}.btn.gold{color:var(--warn);border-color:rgba(245,158,11,.25)}.btn.live{color:var(--good);border-color:rgba(43,213,118,.25)}
    .btnbar{display:flex;gap:6px;flex-wrap:wrap}.sep{height:1px;background:var(--line);margin:12px 0}
    .note{color:var(--muted);font-size:11px;line-height:1.4;margin-top:6px}
    .muted{color:var(--muted)}.good{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}.hidden{display:none!important}
    .modeToggle{display:flex;border:1px solid var(--card-border);border-radius:10px;overflow:hidden;background:var(--input-bg);margin-bottom:14px}
    .modeBtn{flex:1;padding:12px;text-align:center;font-size:13px;font-weight:600;cursor:pointer;user-select:none;transition:all .2s;border:none;background:transparent;color:var(--muted)}
    .modeBtn.active{background:var(--accent);color:#fff}.modeBtn.active.tourney{background:var(--warn);color:#1a1f2e}
    .chips{display:grid;gap:8px;grid-template-columns:repeat(5,minmax(0,1fr))}@media(max-width:560px){.chips{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .cell{border-radius:10px;padding:8px}.cell .ctop{display:flex;gap:6px;align-items:center;margin-bottom:6px}
    .sw{width:10px;height:10px;border-radius:3px}.sw.b{background:var(--b)}.sw.p{background:var(--p)}.sw.y{background:var(--y)}.sw.pk{background:var(--pk)}.sw.o{background:var(--o)}
    .cname{color:var(--muted);font-size:11px;font-weight:600}.cval{margin-left:auto;color:var(--muted);font-size:10px;opacity:.7}
    .cell[data-color="black"]{background:rgba(59,69,87,.25);border:1px solid rgba(59,69,87,.35)}.cell[data-color="purple"]{background:rgba(124,58,237,.10);border:1px solid rgba(124,58,237,.20)}.cell[data-color="yellow"]{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.18)}.cell[data-color="pink"]{background:rgba(236,72,153,.08);border:1px solid rgba(236,72,153,.18)}.cell[data-color="orange"]{background:rgba(249,115,22,.08);border:1px solid rgba(249,115,22,.18)}
    [data-theme="light"] .cell[data-color="black"]{background:rgba(59,69,87,.06);border-color:rgba(59,69,87,.15)}[data-theme="light"] .cell[data-color="purple"]{background:rgba(124,58,237,.05);border-color:rgba(124,58,237,.15)}[data-theme="light"] .cell[data-color="yellow"]{background:rgba(245,158,11,.05);border-color:rgba(245,158,11,.15)}[data-theme="light"] .cell[data-color="pink"]{background:rgba(236,72,153,.05);border-color:rgba(236,72,153,.15)}[data-theme="light"] .cell[data-color="orange"]{background:rgba(249,115,22,.05);border-color:rgba(249,115,22,.15)}
    .stepper{display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--input-border);background:var(--input-bg)}
    .stepper input{border:none;border-radius:0;text-align:center;padding:7px 2px;min-width:0;flex:1;background:transparent;font-size:16px}.stepper input:focus{box-shadow:none}
    .stepper .sbtn{display:flex;align-items:center;justify-content:center;width:32px;min-width:32px;background:var(--hover);color:var(--muted);cursor:pointer;user-select:none;touch-action:manipulation;font-size:16px;font-weight:700;border:none;transition:all .12s}    .stepper .sbtn:hover{color:var(--text);background:rgba(122,167,255,.08)}.stepper .sbtn:active{background:rgba(122,167,255,.15);transform:scale(.95)}.stepper .sbtn[disabled]{pointer-events:none;opacity:.3}
    .cashoutSection{border:1px solid rgba(122,167,255,.15);border-radius:12px;background:rgba(122,167,255,.03);padding:10px;margin-top:10px}.cashoutSection>label{color:var(--accent);font-weight:600}
    [data-theme="light"] .cashoutSection{background:rgba(74,127,221,.04);border-color:rgba(74,127,221,.15)}
    .miniCard{border:1px solid var(--card-border);border-radius:12px;background:var(--input-bg);overflow:hidden;margin-top:10px}
    .miniHd{padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px;border-bottom:1px solid var(--line);background:var(--hover)}.miniHd b{font-size:12px}.miniBd{padding:10px}
    .outblock{border:1px solid var(--card-border);border-radius:12px;background:var(--input-bg);padding:10px;margin-top:10px}
    .outblock pre{margin:0;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:11px;line-height:1.4;color:var(--text)}
    .tablewrap{overflow:auto;border:1px solid var(--card-border);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}th,td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:12px}
    th{background:var(--input-bg);color:var(--muted);text-align:left;font-weight:600}.num{text-align:right}
    td:first-child{max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    /* FOOTER */
    .footer{position:sticky;bottom:0;z-index:50;margin:14px 0 0;border-radius:0;border:none;border-top:1px solid var(--card-border);background:var(--bg2);box-shadow:0 -4px 20px rgba(0,0,0,.25);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
    .footer .inner{max-width:1050px;margin:0 auto;padding:10px 14px;padding-bottom:calc(10px + env(safe-area-inset-bottom,0px));display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .tot{border:1px solid var(--card-border);background:var(--input-bg);padding:6px 9px;border-radius:10px;min-width:130px;flex:1 1 130px}
    .tot .k{font-size:10px;color:var(--muted);font-weight:500}.tot .v{font-size:13px;font-weight:800}
    .totwrap{display:flex;gap:6px;flex-wrap:wrap;align-items:stretch;flex:1;min-width:250px}.totwrap .tot{max-width:200px}
    @media(max-width:420px){.totwrap{min-width:0}.totwrap .tot{max-width:none}}
    .toastBox{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none}
    .toast{padding:9px 16px;border-radius:10px;background:var(--bg2);border:1px solid var(--card-border);color:var(--text);font-size:12px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.25);opacity:0;transform:translateY(-8px) scale(.96);animation:toastIn .25s ease forwards;pointer-events:auto}
    .toast.out{animation:toastOut .2s ease forwards}
    @keyframes toastIn{to{opacity:1;transform:translateY(0) scale(1)}}@keyframes toastOut{to{opacity:0;transform:translateY(-8px) scale(.96)}}@keyframes spin{to{transform:rotate(360deg)}}
    .players{display:flex;flex-direction:column;gap:10px}
    .player{border:1px solid var(--card-border);border-radius:12px;overflow:hidden;background:var(--input-bg);transition:all .2s}
    .player:hover{border-color:rgba(122,167,255,.15)}
    .phd{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;justify-content:space-between}
    .pname{flex:1;min-width:0;overflow:hidden}.pactions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pname input{text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
    .pbd{padding:12px}.pbd.collapsed{display:none}
    .pSummaryInline{display:none;font-size:11px;color:var(--muted);margin-top:3px}.player.is-collapsed .pSummaryInline{display:block}
    .chevron{display:inline-block;width:18px;height:18px;border-radius:5px;background:var(--hover);text-align:center;line-height:18px;font-size:11px;color:var(--muted);cursor:pointer;user-select:none;transition:transform .2s;flex-shrink:0}
    .player.is-collapsed .chevron{transform:rotate(-90deg)}
    .jumpNav{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}    .jumpNav .jbtn{padding:5px 9px;border-radius:8px;font-size:11px;border:1px solid var(--card-border);background:var(--input-bg);color:var(--muted);cursor:pointer;transition:all .15s;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.jumpNav .jbtn:hover{color:var(--text);border-color:var(--accent)}
    .auditHint{margin-top:10px;padding:10px;border-radius:12px;border:1px solid var(--card-border);background:var(--input-bg);color:var(--muted);font-size:11px}.auditHint b{color:var(--text)}.auditHint .chip{display:inline-flex;align-items:center;gap:5px;margin-right:8px;margin-top:5px}.auditHint .sw{width:10px;height:10px;border-radius:3px;display:inline-block}
    .hl-black{outline:2px solid rgba(90,160,255,.7)}.hl-purple{outline:2px solid rgba(167,139,250,.7)}.hl-yellow{outline:2px solid rgba(250,204,21,.7)}.hl-pink{outline:2px solid rgba(244,114,182,.7)}.hl-orange{outline:2px solid rgba(251,146,60,.7)}
    .histHd{border-bottom-color:var(--line)}.statPositive{color:var(--good);font-weight:700}.statNegative{color:var(--bad);font-weight:700}.statNeutral{color:var(--muted);font-weight:700}
    .sessionRow{cursor:pointer;transition:background .12s}.sessionRow:hover{background:var(--hover)}
    .sessionDetail{display:none;background:var(--input-bg)}.sessionDetail td{font-size:11px;color:var(--muted)}.sessionDetail.open{display:table-row}
    .deleteSession{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;border:1px solid rgba(255,92,122,.20);background:rgba(255,92,122,.06);color:var(--bad);font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;opacity:.7}
    .deleteSession:hover{opacity:1;background:rgba(255,92,122,.15)}
    .emptyState{text-align:center;padding:20px;color:var(--muted);font-size:12px}
    .codeDisplay{font-size:28px;font-weight:800;letter-spacing:4px;text-align:center;padding:14px;font-family:ui-monospace,monospace}
    .playerLink{font-size:12px;color:var(--accent);word-break:break-all;text-align:center}
    .statusGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px;margin-top:10px}
    .statusItem{padding:8px;border-radius:8px;border:1px solid var(--card-border);background:var(--input-bg);font-size:12px;display:flex;align-items:center;gap:6px}
    .statusItem .sDot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.statusItem.pending .sDot{background:var(--muted);opacity:.3}.statusItem.submitted .sDot{background:var(--good)}.statusItem.submitted{border-color:rgba(43,213,118,.20)}
    .submitBadge{font-size:10px;padding:3px 6px;border-radius:5px;font-weight:600}.submitBadge.yes{background:rgba(43,213,118,.12);color:var(--good)}.submitBadge.no{background:var(--input-bg);color:var(--muted)}
    .qrWrap{text-align:center;margin:10px 0}.qrWrap canvas{border-radius:10px}
    .timerCard .hd{border-bottom-color:rgba(245,158,11,.15)}
    .timerDisplay{font-size:48px;font-weight:800;text-align:center;padding:16px 0;font-family:ui-monospace,monospace;letter-spacing:2px}.timerDisplay.warn{color:var(--warn)}.timerDisplay.danger{color:var(--bad);animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}
    .placeSelect{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}.placeItem{flex:1;min-width:120px;padding:10px;border-radius:10px;border:1px solid var(--card-border);background:var(--input-bg)}
    .placeItem .placeLabel{font-size:11px;color:var(--muted);margin-bottom:4px;font-weight:600}.placeItem.gold .placeLabel{color:#f5c542}.placeItem.silver .placeLabel{color:#c0c0c0}.placeItem.bronze .placeLabel{color:#cd7f32}
    .payLine{position:relative;overflow:hidden;border:1px solid var(--card-border);border-radius:10px;margin-top:6px;background:var(--input-bg);touch-action:pan-y}
    .payLine .payContent{padding:10px 12px;display:flex;justify-content:space-between;align-items:center;position:relative;z-index:1;background:var(--input-bg);transition:transform .2s}
    .payLine .payBg{position:absolute;inset:0;display:flex;align-items:center;padding-left:16px;font-size:12px;font-weight:600;color:#fff}
    .payLine .payBg.toBePaid{background:var(--good)}.payLine .payBg.toUnpay{background:var(--bad)}
    .payLine.paid .payContent{opacity:.6;text-decoration:line-through}.payLine.paid{border-color:rgba(43,213,118,.25)}
    .paidBadge{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(43,213,118,.15);color:var(--good);font-weight:600}
    .modeBadge{font-size:9px;padding:2px 5px;border-radius:4px;font-weight:600;text-transform:uppercase}.modeBadge.cash{background:rgba(122,167,255,.12);color:var(--accent)}.modeBadge.tourney{background:rgba(245,158,11,.12);color:var(--warn)}
    .disclaimer{text-align:center;padding:20px 14px;margin-top:14px;color:var(--muted);font-size:11px;line-height:1.5;opacity:.6}.disclaimer .dEmoji{font-size:20px;margin-bottom:6px}
    .confettiCanvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999}
    .resumeBox{display:flex;gap:6px;margin-top:8px}.resumeBox input{flex:1;text-transform:uppercase;letter-spacing:1px;font-weight:700;text-align:center}
    /* PIN Lock */
    .pinOverlay{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
    .pinOverlay.hidden{display:none}
    .pinBox{max-width:320px;width:100%;text-align:center}
    .pinBox .pinLogo{font-size:28px;font-weight:800;letter-spacing:1px;margin-bottom:4px}
    .pinBox .pinSub{color:var(--muted);font-size:12px;margin-bottom:24px}
    .pinDots{display:flex;gap:12px;justify-content:center;margin:20px 0}
    .pinDot{width:16px;height:16px;border-radius:50%;border:2px solid var(--muted);transition:all .15s}
    .pinDot.filled{background:var(--accent);border-color:var(--accent)}
    .pinDot.wrong{background:var(--bad);border-color:var(--bad);animation:shake .4s}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
    .pinPad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:240px;margin:0 auto}
    .pinKey{height:52px;border-radius:12px;border:1px solid var(--card-border);background:var(--input-bg);color:var(--text);font-size:20px;font-weight:700;cursor:pointer;user-select:none;touch-action:manipulation;display:flex;align-items:center;justify-content:center;transition:all .12s}
    .pinKey:hover{background:var(--hover)}.pinKey:active{background:rgba(122,167,255,.15)}
    .pinKey.wide{grid-column:span 1}
    .pinMsg{color:var(--muted);font-size:11px;margin-top:16px;min-height:16px}
    .rosterWrap{margin-bottom:12px;border:1px solid var(--card-border);border-radius:12px;background:var(--input-bg);overflow:hidden}
    .rosterHd{padding:8px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);cursor:pointer;user-select:none}.rosterHd b{font-size:12px;color:var(--muted)}.rosterHd .rChev{font-size:10px;color:var(--muted);transition:transform .2s}
    .rosterBd{padding:10px 12px;display:none}.rosterBd.open{display:block}
    .rosterChips{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
    .rosterChip{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:1px solid var(--card-border);background:var(--hover);font-size:13px;transition:all .15s}
    .rosterChip .rc-name{flex:1;font-weight:500;overflow:hidden}
    .rosterChip .rc-name input{background:transparent;border:1px solid transparent;padding:4px 6px;border-radius:6px;font-size:13px;font-weight:500;width:100%;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
    .rosterChip .rc-name input:focus{border-color:var(--accent);background:var(--input-bg)}
    .rosterChip .rc-add{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid rgba(122,167,255,.25);background:rgba(122,167,255,.08);color:var(--accent)}
    .rosterChip .rc-add:hover{background:rgba(122,167,255,.15)}
    .rosterChip .rc-add.disabled{opacity:.4;cursor:default;border-style:dashed}
    .rosterChip .rc-del{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid rgba(255,92,122,.20);background:rgba(255,92,122,.06);color:var(--bad)}
    .rosterChip .rc-del:hover{background:rgba(255,92,122,.15)}
    .rosterAdd{display:flex;gap:6px;margin-top:8px}.rosterAdd input{flex:1}
    /* Player color dots */
    .pColorDot{width:12px;height:12px;border-radius:50%;flex-shrink:0;display:inline-block;vertical-align:middle}
    /* Chip presets */
    .presetBar{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
    .presetBtn{padding:6px 12px;border-radius:8px;border:1px solid var(--card-border);background:var(--hover);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;color:var(--text)}
    .presetBtn:hover{border-color:var(--accent);background:rgba(122,167,255,.08)}
    /* Payout preview */
    .payPreview{margin-top:12px;border:1px dashed var(--card-border);border-radius:12px;padding:12px;background:var(--input-bg)}
    .payPreview .ppTitle{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-bottom:8px}
    .payPreview .ppLine{display:flex;justify-content:space-between;padding:5px 0;font-size:12px;border-bottom:1px solid var(--line)}
    .payPreview .ppLine:last-child{border:none}
    .payPreview .ppDir{color:var(--muted)}.payPreview .ppAmt{font-weight:700}
    /* Export canvas */
    .exportCanvas{display:none}
    /* Rake/pot stats */
    .rakeBar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .rakeStat{flex:1;min-width:100px;padding:8px 10px;border-radius:10px;border:1px solid var(--card-border);background:var(--input-bg);text-align:center}
    .rakeStat .rs-v{font-size:16px;font-weight:800}.rakeStat .rs-k{font-size:10px;color:var(--muted);margin-top:2px}
    /* Cashout save status */
    .cashoutStatus{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:600;padding:3px 7px;border-radius:6px;margin-left:8px}
    .cashoutStatus.pending{background:rgba(139,149,176,.10);color:var(--muted)}
    .cashoutStatus.saved{background:rgba(43,213,118,.12);color:var(--good)}
    .cashoutStatus.submitted{background:rgba(122,167,255,.12);color:var(--accent)}
    .saveBtn{padding:6px 14px;border-radius:8px;border:1px solid rgba(43,213,118,.25);background:rgba(43,213,118,.08);color:var(--good);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;margin-top:8px;display:inline-flex;align-items:center;gap:4px}
    .saveBtn:hover{background:rgba(43,213,118,.15)}.saveBtn:active{transform:scale(.97)}
    .saveBtn.done{background:rgba(43,213,118,.15);border-color:rgba(43,213,118,.35)}
    /* Offline banner */
    .offlineBanner{position:fixed;top:0;left:0;right:0;z-index:300;padding:10px 14px;padding-top:calc(10px + env(safe-area-inset-top));background:#dc2626;color:#fff;text-align:center;font-size:13px;font-weight:600;display:none;box-shadow:0 4px 16px rgba(0,0,0,.3)}
    .offlineBanner.show{display:block}
    /* Long name overflow */
    .statusItem{padding:8px;border-radius:8px;border:1px solid var(--card-border);background:var(--input-bg);font-size:12px;display:flex;align-items:center;gap:6px;overflow:hidden}
    .statusItem span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  </style>
</head>
<body>
<div class="toastBox" id="toastBox"></div>
<div class="offlineBanner" id="offlineBanner">‚ö†Ô∏è No internet connection ‚Äî changes won't sync</div>
<div class="pinOverlay hidden" id="pinOverlay">
  <div class="pinBox">
    <div class="pinLogo"><span style="opacity:.7;font-size:20px">‚ô†‚ô•</span> IPL <span style="opacity:.7;font-size:20px">‚ô¶‚ô£</span></div>
    <div class="pinSub" id="pinTitle">Enter admin PIN</div>
    <div class="pinDots"><div class="pinDot" id="pd0"></div><div class="pinDot" id="pd1"></div><div class="pinDot" id="pd2"></div><div class="pinDot" id="pd3"></div></div>
    <div class="pinPad">
      <div class="pinKey" data-pk="1">1</div><div class="pinKey" data-pk="2">2</div><div class="pinKey" data-pk="3">3</div>
      <div class="pinKey" data-pk="4">4</div><div class="pinKey" data-pk="5">5</div><div class="pinKey" data-pk="6">6</div>
      <div class="pinKey" data-pk="7">7</div><div class="pinKey" data-pk="8">8</div><div class="pinKey" data-pk="9">9</div>
      <div class="pinKey" data-pk="cancel" style="font-size:13px">Cancel</div><div class="pinKey" data-pk="0">0</div><div class="pinKey" data-pk="back">‚Üê</div>
    </div>
    <div class="pinMsg" id="pinMsg"></div>
  </div>
</div>
<div class="pullIndicator" id="pullIndicator"><span class="pullIcon">‚Üì</span><span class="pullText">Pull to refresh</span></div>
<div class="iplHeader"><div class="iplLogo"><span class="suit blk">‚ô†</span><span class="suit red">‚ô•</span> IPL <span class="suit red">‚ô¶</span><span class="suit blk">‚ô£</span></div><div class="iplSub">Innovation Poker League</div></div>
<div class="wrap">
  <div class="modeToggle" id="modeToggle"><button class="modeBtn active" data-mode="cash" type="button">‚ô† Cash Game</button><button class="modeBtn" data-mode="tournament" type="button">üèÜ Tournament</button></div>
  <div class="top"><div><h1 id="topTitle">Poker Cashout (Admin)</h1><div class="sub" id="topSub"></div></div>
    <div class="topPills"><div id="liveBadge" class="pill live" style="display:none"><span class="dot"></span><span id="liveText">LIVE</span></div><div id="lockBadge" class="pill secondary" style="display:none"><span class="dot" style="background:var(--accent)"></span><span>LOCKED</span></div><div id="pill" class="pill warn"><span class="dot"></span><span id="pillText">Audit: pending</span></div><button class="themeToggle" id="themeToggle" type="button">üåô</button></div></div>

  <div class="card timerCard hidden" id="timerCard" style="margin-bottom:14px"><div class="hd"><h2>‚è± Blinds Timer</h2><div class="btnbar"><button class="btn small" id="timerStart" type="button">Start</button><button class="btn small danger" id="timerReset" type="button">Reset</button></div></div><div class="bd"><div class="timerDisplay" id="timerDisplay">10:00</div><div class="row" style="max-width:300px;margin:0 auto"><div><label>Minutes</label><input id="timerMin" type="number" value="10" min="1" max="120" inputmode="numeric" style="text-align:center;font-size:18px;font-weight:700"/></div></div></div></div>

  <div class="card" id="onlineCard"><div class="hd"><h2>Online Session</h2><div class="btnbar"><button class="btn small live" id="startOnline" type="button">Start Online</button><button class="btn small danger" id="stopOnline" type="button" style="display:none">End Online</button></div></div>
    <div class="bd"><div id="onlineOff"><div class="note" style="margin:0;text-align:center;padding:6px 0">Let players submit cashouts from their phones.<br><b style="color:var(--warn)">1) Add & name players below  2) Click "Start Online"</b></div><div class="sep"></div><div class="note" style="margin:0;text-align:center">Or resume a previous session:</div><div class="resumeBox"><input id="resumeCode" type="text" placeholder="Session code" maxlength="12"/><button class="btn small" id="resumeBtn" type="button">Resume</button></div></div>
      <div id="onlineOn" style="display:none"><div class="note" style="margin:0;text-align:center">Share this code:</div><div class="codeDisplay" id="sessionCodeDisplay"></div><div class="qrWrap" id="qrWrap"></div><div class="playerLink" id="playerLinkDisplay"></div><div class="btnbar" style="justify-content:center;margin-top:8px"><button class="btn small" id="copyCode" type="button">Copy code</button><button class="btn small" id="copyLink" type="button">Copy link</button></div><div class="sep"></div><div style="font-size:11px;color:var(--muted)"><b id="submitCount">0</b> / <span id="submitTotal">0</span> submitted</div><div class="statusGrid" id="statusGrid"></div></div></div></div>

  <div class="grid" style="margin-top:14px">
    <div class="card"><div class="hd"><h2>Session & Rules</h2><div class="btnbar"><button class="btn small gold" id="archiveSession" type="button">Archive</button><button class="btn small danger" id="resetAll" type="button">Reset</button><button class="btn small" id="lockSession" type="button">Lock session</button><button class="btn small" id="toggleRules" type="button">Collapse</button></div></div>
      <div class="bd" id="rulesBody">
        <div class="row"><div><label>Session name</label><input id="sessionName" type="text" placeholder="Friday poker"/></div><div><label>Buy-in (‚Ç•)</label><input id="buyinUsd" type="number" step="0.01" inputmode="decimal"/></div><div><label>RF tax rate</label><input id="taxRate" type="number" step="0.01" inputmode="decimal"/></div></div>
        <div class="row" style="margin-top:8px"><div><label>Bank / Admin</label><select id="bankSelect"></select></div></div>
        <div id="chipValuesSection"><div class="sep"></div><label>Chip values (units per chip)</label><div class="row"><div><label>Black</label><input id="v_black" type="number" step="1" inputmode="numeric"/></div><div><label>Purple</label><input id="v_purple" type="number" step="1" inputmode="numeric"/></div><div><label>Yellow</label><input id="v_yellow" type="number" step="1" inputmode="numeric"/></div><div><label>Pink</label><input id="v_pink" type="number" step="1" inputmode="numeric"/></div><div><label>Orange</label><input id="v_orange" type="number" step="1" inputmode="numeric"/></div></div>
          <div class="sep"></div>
          <label>Buy-in chip presets</label>
          <div class="note" style="margin-top:0;margin-bottom:6px">Quick-fill buy-in chips for all players</div>
          <div class="presetBar">
            <button class="presetBtn" data-preset="standard" type="button">üé∞ Standard (15/3/12/3/2)</button>
            <button class="presetBtn" data-preset="half" type="button">¬Ω Half (8/2/6/2/1)</button>
            <button class="presetBtn" data-preset="heavy" type="button">üí∞ Heavy (20/5/15/5/3)</button>
            <button class="presetBtn" data-preset="light" type="button">ü™∂ Light (10/2/8/2/1)</button>
          </div>
        </div>
        <div id="prizeSplitSection" class="hidden"><div class="sep"></div><label>Prize split (%)</label><div class="row"><div><label>ü•á 1st</label><input id="split1" type="number" value="50" inputmode="numeric"/></div><div><label>ü•à 2nd</label><input id="split2" type="number" value="30" inputmode="numeric"/></div><div><label>ü•â 3rd</label><input id="split3" type="number" value="20" inputmode="numeric"/></div></div><div class="sep"></div><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px"><label style="margin:0;font-weight:700;color:var(--warn)">üé∞ Tournament Chip Pack</label><button class="btn small gold" id="copyChipPack" type="button">Copy to all</button></div><div class="note" style="margin-top:4px;margin-bottom:8px">Set starting chips, then copy to all.</div><div class="chips" id="tourneyChipPack"></div><div class="note" id="tourneyPackValue"></div></div>
        <div class="sep"></div><div class="btnbar"><button class="btn" id="saveRoster" type="button">Save roster</button><button class="btn" id="loadRoster" type="button">Load roster</button><button class="btn" id="copyAll" type="button">Copy outputs</button><button class="btn small" id="pinSetBtn" type="button">üîë PIN</button></div>
        <div id="auditHint" class="auditHint" style="display:none"></div>
      </div></div>
    <div class="card"><div class="hd"><h2>Players (<span id="playerCount">0</span>)</h2><div class="btnbar"><button class="btn small" id="collapseAll" type="button">Collapse all</button><button class="btn" id="addPlayer" type="button">+ Add player</button></div></div>
      <div class="bd">
        <div class="rosterWrap"><div class="rosterHd" id="rosterToggle"><b>üìã Regular Players</b><span class="rChev" id="rosterChev">‚ñº</span></div><div class="rosterBd" id="rosterBody"><div class="note" style="margin:0 0 8px">Tap a name to add to this game.</div><div class="rosterChips" id="rosterChips"></div><div class="rosterAdd"><input id="rosterNewName" type="text" placeholder="New regular player" autocapitalize="words"/><button class="btn small" id="rosterAddBtn" type="button">+ Save</button></div><div class="sep"></div><div class="btnbar"><button class="btn small" id="rosterAddAll" type="button">Add all to game</button><button class="btn small danger" id="rosterClearAll" type="button">Clear roster</button></div></div></div>
        <div id="jumpNav" class="jumpNav"></div><div id="players" class="players"></div>
        <div id="placementSection" class="hidden" style="margin-top:14px"><label style="font-weight:700;color:var(--warn);font-size:13px">üèÜ Placements</label><div class="placeSelect"><div class="placeItem gold"><div class="placeLabel">ü•á 1st (50%)</div><select id="place1"><option value="">Select</option></select></div><div class="placeItem silver"><div class="placeLabel">ü•à 2nd (30%)</div><select id="place2"><option value="">Select</option></select></div><div class="placeItem bronze"><div class="placeLabel">ü•â 3rd (20%)</div><select id="place3"><option value="">Select</option></select></div></div></div>
      </div></div></div>
  <div class="grid" id="cashAuditGrid"><div class="card"><div class="hd"><h2>Audit: IN vs OUT</h2></div><div class="bd"><div class="tablewrap"><table><thead><tr><th>Color</th><th class="num">IN</th><th class="num">OUT</th><th class="num">Diff</th></tr></thead><tbody id="auditBody"></tbody></table></div></div></div>    <div class="card"><div class="hd"><h2>Summary</h2><button class="btn small" id="exportImage" type="button">üì∏ Share</button></div><div class="bd"><div class="tablewrap"><table><thead><tr><th>Player</th><th class="num">Buy-ins</th><th class="num">Gross</th><th class="num">RF</th><th class="num">Final</th><th class="num">Net</th></tr></thead><tbody id="summaryBody"></tbody></table></div>
      <div class="rakeBar" id="rakeBar"></div>
      <div class="payPreview" id="payPreview" style="display:none"><div class="ppTitle">üí∏ Payout Preview (who owes who)</div><div id="payPreviewLines"></div></div>
    </div></div></div>
  <div class="card hidden" id="tournamentSummary" style="margin-top:14px"><div class="hd"><h2>üèÜ Tournament Summary</h2></div><div class="bd"><div class="tablewrap"><table><thead><tr><th>Place</th><th>Player</th><th class="num">Buy-ins</th><th class="num">Prize</th><th class="num">RF</th><th class="num">Payout</th><th class="num">Net</th></tr></thead><tbody id="tourneySummaryBody"></tbody></table></div><div class="outblock" style="margin-top:10px"><pre id="tourneyInfoText"></pre></div></div></div>
  <div class="card" id="payoutCard" style="margin-top:14px;display:none"><div class="hd"><h2>Payouts</h2><div class="btnbar"><button class="btn small" id="copyPayouts" type="button">Copy payouts</button></div></div><div class="bd"><div class="note" style="margin:0 0 8px">Swipe right ‚Üí paid. Swipe left ‚Üí undo.</div><div id="payoutLines"></div></div></div>
  <div class="card" style="margin-top:14px"><div class="hd histHd"><h2>Player Stats</h2><span class="muted" id="statsSessionCount" style="font-size:11px"></span></div><div class="bd"><div class="tablewrap"><table><thead><tr><th>Player</th><th class="num">Games</th><th class="num">Wins</th><th class="num">Win%</th><th class="num">Net</th><th class="num">Avg</th></tr></thead><tbody id="statsBody"></tbody></table></div><div id="statsEmpty" class="emptyState" style="display:none">No sessions yet.</div></div></div>
  <div class="card" style="margin-top:14px"><div class="hd histHd"><h2>History</h2><div class="btnbar"><button class="btn small" id="exportHistory" type="button">Export CSV</button><button class="btn small danger" id="clearHistory" type="button">Clear</button></div></div><div class="bd"><div class="tablewrap"><table><thead><tr><th>Date</th><th>Session</th><th class="num">Mode</th><th class="num">#</th><th></th></tr></thead><tbody id="historyBody"></tbody></table></div><div id="historyEmpty" class="emptyState" style="display:none">No sessions yet.</div></div></div>
  <div class="disclaimer"><div class="dEmoji">üÉè</div><b>Innovation Poker League</b> ‚Äî where bluffs are bold and the math is real.<br>Data accuracy depends on honest submissions (yes, we're looking at you).<br>Not affiliated with any casino. Just friends, chips & vibes. ‚ô†‚ô•‚ô¶‚ô£<br><br><a href="odds.html" style="color:var(--accent);text-decoration:none;font-weight:600">üé≤ Poker Odds Calculator ‚Üí</a></div>
</div>
<div class="footer"><div class="inner"><div class="totwrap"><div class="tot"><div class="k" id="footK1">Total Gross</div><div class="v" id="t_gross">‚Ç•0.00</div></div><div class="tot"><div class="k">RF fund</div><div class="v" id="t_rf">‚Ç•0.00</div></div><div class="tot"><div class="k" id="footK3">Total Final</div><div class="v" id="t_final">‚Ç•0.00</div></div></div><button class="btn" id="toTop" type="button">‚Üë</button></div></div>
<div id="lockedOverlay" class="lockedOverlay"><b>Session locked.</b> <span class="muted">Unlock to edit.</span></div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
(()=>{
  firebase.initializeApp({apiKey:"AIzaSyCZKgCKh9qxBcW0Gf3LmQFMsFfVB16rwCM",authDomain:"poker-cashout-bde23.firebaseapp.com",databaseURL:"https://poker-cashout-bde23-default-rtdb.firebaseio.com",projectId:"poker-cashout-bde23",storageBucket:"poker-cashout-bde23.firebasestorage.app",messagingSenderId:"1054875878552",appId:"1:1054875878552:web:94d610f9d20a18bed07ced"});
  const db=firebase.database();
  let adminUid=null;
  firebase.auth().signInAnonymously().then(cred=>{adminUid=cred.user.uid}).catch(()=>{});
  const KEY="poker_admin_v13",ROSTER_KEY="poker_admin_roster_v1",ROSTER_V2_KEY="poker_roster_v2",HISTORY_KEY="poker_admin_history_v2",THEME_KEY="poker_theme",PAY_KEY="poker_payments",ACTIVE_KEY="poker_active_session";
  const COLORS=["black","purple","yellow","pink","orange"],SW={black:"b",purple:"p",yellow:"y",pink:"pk",orange:"o"};
  const PLAYER_COLORS=["#7aa7ff","#2bd576","#f5c542","#ff5c7a","#ec4899","#f97316","#7c3aed","#06b6d4","#84cc16","#a78bfa","#fb923c","#f43f5e"];
  function playerColor(idx){return PLAYER_COLORS[idx%PLAYER_COLORS.length]}
  const CHIP_PRESETS={standard:{black:15,purple:3,yellow:12,pink:3,orange:2},half:{black:8,purple:2,yellow:6,pink:2,orange:1},heavy:{black:20,purple:5,yellow:15,pink:5,orange:3},light:{black:10,purple:2,yellow:8,pink:2,orange:1}};
  const DEFAULTS={buyinUsd:50,taxRate:.30,chipValues:{black:100,purple:500,yellow:1000,pink:5000,orange:10000},defaultPack:{black:15,purple:3,yellow:12,pink:3,orange:2}};
  const $=id=>document.getElementById(id),clamp=v=>Number.isFinite(v)?v:0,clone=o=>JSON.parse(JSON.stringify(o));
  const uid=()=>Math.random().toString(16).slice(2)+"-"+Date.now().toString(16);
  // ‚Ç• = mill sign (M with stroke) ‚Äî replaces $
  const fmtUsd=x=>{const s=clamp(x).toLocaleString(undefined,{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2});return s.replace(/\$/g,"‚Ç•")};
  const esc=s=>(s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  const u2d=u=>clamp(u)/1000,ufc=(c,v)=>COLORS.reduce((s,cl)=>s+clamp(c[cl])*clamp(v[cl]),0),tcc=c=>COLORS.reduce((s,cl)=>s+clamp(c[cl]),0);

  let theme=localStorage.getItem(THEME_KEY)||"dark";
  function applyTheme(){document.documentElement.setAttribute("data-theme",theme);$("themeToggle").textContent=theme==="dark"?"‚òÄÔ∏è":"üåô";localStorage.setItem(THEME_KEY,theme)}
  applyTheme();$("themeToggle").addEventListener("click",()=>{theme=theme==="dark"?"light":"dark";applyTheme()});
  function toast(msg,d=2200){const box=$("toastBox"),el=document.createElement("div");el.className="toast";el.textContent=msg;box.appendChild(el);setTimeout(()=>{el.classList.add("out");setTimeout(()=>el.remove(),220)},d)}

  let mode="cash";const collapsedPlayers=new Set();let onlineSessionCode=null,firebaseListener=null;
  let timerInterval=null,timerSeconds=600,timerRunning=false;
  let paidMap={};try{paidMap=JSON.parse(localStorage.getItem(PAY_KEY)||"{}")}catch{}
  function savePaid(){try{localStorage.setItem(PAY_KEY,JSON.stringify(paidMap))}catch{}}
  let allSubmittedSounded=false;
  const savedCashouts=new Set(); // tracks which players admin has confirmed

  function makePlayer(n){return{id:uid(),name:n||"Player",buyins:[{id:uid(),counts:clone(DEFAULTS.defaultPack)}],cashout:{black:0,purple:0,yellow:0,pink:0,orange:0}}}
  function defaultState(){return{sessionName:"",buyinUsd:DEFAULTS.buyinUsd,taxRate:DEFAULTS.taxRate,chipValues:clone(DEFAULTS.chipValues),locked:false,bankId:null,players:[makePlayer("Player 1"),makePlayer("Player 2")],place1:"",place2:"",place3:"",split1:50,split2:30,split3:20,tourneyPack:{black:0,purple:0,yellow:0,pink:0,orange:0}}}
  function sanitize(s){if(!s||typeof s!=="object")return defaultState();s.sessionName=typeof s.sessionName==="string"?s.sessionName:"";s.buyinUsd=Number(s.buyinUsd);if(!Number.isFinite(s.buyinUsd)||s.buyinUsd<=0)s.buyinUsd=DEFAULTS.buyinUsd;s.taxRate=Number(s.taxRate);if(!Number.isFinite(s.taxRate)||s.taxRate<0)s.taxRate=DEFAULTS.taxRate;s.locked=!!s.locked;s.bankId=typeof s.bankId==="string"?s.bankId:null;if(!s.chipValues)s.chipValues={};for(const c of COLORS){const v=Number(s.chipValues[c]);s.chipValues[c]=Number.isFinite(v)&&v>0?v:DEFAULTS.chipValues[c]}if(!Array.isArray(s.players)||!s.players.length)s.players=[makePlayer("Player 1")];for(const p of s.players){if(!p.id)p.id=uid();if(typeof p.name!=="string")p.name="Player";if(!Array.isArray(p.buyins)||!p.buyins.length)p.buyins=[{id:uid(),counts:clone(DEFAULTS.defaultPack)}];for(const b of p.buyins){if(!b.id)b.id=uid();if(!b.counts)b.counts=clone(DEFAULTS.defaultPack);for(const c of COLORS){const n=Number(b.counts[c]);b.counts[c]=Number.isFinite(n)&&n>=0?n:0}}if(!p.cashout)p.cashout={black:0,purple:0,yellow:0,pink:0,orange:0};for(const c of COLORS){const n=Number(p.cashout[c]);p.cashout[c]=Number.isFinite(n)&&n>=0?n:0}}const ids=s.players.map(p=>p.id);if(!s.bankId||!ids.includes(s.bankId))s.bankId=ids[0]||null;s.place1=s.place1||"";s.place2=s.place2||"";s.place3=s.place3||"";s.split1=Number(s.split1)||50;s.split2=Number(s.split2)||30;s.split3=Number(s.split3)||20;if(!s.tourneyPack)s.tourneyPack={black:0,purple:0,yellow:0,pink:0,orange:0};for(const c of COLORS){const n=Number(s.tourneyPack[c]);s.tourneyPack[c]=Number.isFinite(n)&&n>=0?n:0}return s}

  let state=(()=>{try{return sanitize(JSON.parse(localStorage.getItem(KEY)))}catch{return defaultState()}})();
  function save(){try{localStorage.setItem(KEY,JSON.stringify(state))}catch{};syncStateToFirebase()}
  function loadHistory(){try{return JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]")}catch{return[]}}
  function saveHistory(h){try{localStorage.setItem(HISTORY_KEY,JSON.stringify(h))}catch{}}
  function loadRoster(){try{return JSON.parse(localStorage.getItem(ROSTER_V2_KEY)||"[]")}catch{return[]}}
  function saveRosterData(r){try{localStorage.setItem(ROSTER_V2_KEY,JSON.stringify(r))}catch{}}
  // Migrate old roster
  (function(){const old=localStorage.getItem(ROSTER_KEY);if(old&&!localStorage.getItem(ROSTER_V2_KEY)){try{const n=JSON.parse(old);if(Array.isArray(n)&&n.length)saveRosterData(n)}catch{}}})();

  let syncTimer=null;
  function syncStateToFirebase(){if(!onlineSessionCode)return;clearTimeout(syncTimer);syncTimer=setTimeout(()=>{db.ref("sessions/"+onlineSessionCode+"/admin_state").set({state:JSON.stringify(state),mode,updatedAt:Date.now()}).catch(()=>{})},2000)}
  function syncBuyinsToFirebase(){if(!onlineSessionCode)return;const u={};for(const p of state.players){const pn=p.name.trim();if(pn)u[pn+"/buyinCount"]=p.buyins.length}db.ref("sessions/"+onlineSessionCode+"/cashouts").update(u).catch(()=>{})}
  function setAdminOverride(pn){if(!onlineSessionCode||!pn)return;const p=state.players.find(x=>x.name.trim()===pn);if(!p)return;const pl={adminOverride:true,submitted:true,timestamp:Date.now(),buyinCount:p.buyins.length};COLORS.forEach(c=>{pl[c]=p.cashout[c]});db.ref("sessions/"+onlineSessionCode+"/cashouts/"+pn).update(pl).catch(()=>{})}

  function calcPlayer(p){const bc=p.buyins.length,ou=ufc(p.cashout,state.chipValues),g=u2d(ou),bt=bc*state.buyinUsd,tb=Math.max(0,g-bt),rf=tb*state.taxRate,fp=g-rf,np=fp-bt;return{buyinsCount:bc,buyinUsdTotal:bt,outUnits:ou,outChips:tcc(p.cashout),gross:g,rfTax:rf,finalPayout:fp,netProfit:np}}
  function calcAudit(){const IN={black:0,purple:0,yellow:0,pink:0,orange:0},OUT={black:0,purple:0,yellow:0,pink:0,orange:0};for(const p of state.players){for(const b of p.buyins)for(const c of COLORS)IN[c]+=clamp(b.counts[c]);for(const c of COLORS)OUT[c]+=clamp(p.cashout[c])}return{IN,OUT}}
  function calcTournament(){const pool=state.players.reduce((s,p)=>s+p.buyins.length*state.buyinUsd,0),splits=[state.split1/100,state.split2/100,state.split3/100],pids=[state.place1,state.place2,state.place3];return{pool,results:pids.map((pid,i)=>{const p=state.players.find(x=>x.id===pid);if(!p)return null;const prize=pool*splits[i],bt=p.buyins.length*state.buyinUsd,rf=Math.max(0,prize-bt)*state.taxRate;return{name:p.name,place:i+1,buyins:p.buyins.length,buyinTotal:bt,prize,rf,payout:prize-rf,net:(prize-rf)-bt}})}}
  function outputBlockText(p){const c=calcPlayer(p),s=c.netProfit>=0?"+":"";return`Chips: ${c.outChips} / ${Math.round(c.outUnits).toLocaleString()}\nGross: ${fmtUsd(c.gross)}\nRF: ${fmtUsd(c.rfTax)}\nFinal: ${fmtUsd(c.finalPayout)}\nNet: ${s}${fmtUsd(c.netProfit)}`}
  function shortSummary(p){const c=calcPlayer(p),s=c.netProfit>=0?"+":"";return`${c.buyinsCount} buy-in${c.buyinsCount>1?"s":""} ¬∑ Net ${s}${fmtUsd(c.netProfit)}`}

  function archiveCurrentSession(){const players=state.players.map(p=>{if(mode==="tournament"){const t=calcTournament(),r=t.results.find(x=>x&&x.name===p.name.trim());return{name:p.name.trim(),buyins:p.buyins.length,gross:r?r.prize:0,rfTax:r?r.rf:0,final:r?r.payout:0,net:r?r.net:-(p.buyins.length*state.buyinUsd)}}else{const c=calcPlayer(p);return{name:p.name.trim(),buyins:c.buyinsCount,gross:c.gross,rfTax:c.rfTax,final:c.finalPayout,net:c.netProfit}}});const totalRF=players.reduce((s,p)=>s+p.rfTax,0);const entry={id:uid(),date:new Date().toISOString(),sessionName:(state.sessionName||"").trim()||"Untitled",mode,buyinUsd:state.buyinUsd,playerCount:players.length,totalRF,players};const h=loadHistory();if(h[0]&&Math.abs(new Date(h[0].date)-new Date(entry.date))<30000){toast("Already archived");return false}h.unshift(entry);saveHistory(h);return true}

  function syncResultsToFirebase(){
    if(!onlineSessionCode){console.log("No online session ‚Äî skipping results sync");return}
    const playersObj={};
    if(mode==="tournament"){
      const t=calcTournament();
      t.results.forEach((x,i)=>{if(x)playersObj[x.name]={place:i+1,prize:x.prize,rf:x.rf,payout:x.payout,net:x.net,buyins:x.buyins}});
      state.players.forEach(p=>{const n=p.name.trim();if(!playersObj[n])playersObj[n]={place:0,prize:0,rf:0,payout:0,net:-(p.buyins.length*state.buyinUsd),buyins:p.buyins.length}});
    }else{
      state.players.forEach(p=>{
        const c=calcPlayer(p);
        playersObj[p.name.trim()]={gross:c.gross,rfTax:c.rfTax,finalPayout:c.finalPayout,net:c.netProfit,buyins:c.buyinsCount};
      });
    }
    // Verify we have data
    const playerKeys=Object.keys(playersObj);
    if(!playerKeys.length){console.error("No players to sync");toast("Error: no player data");return}
    
    const payload={locked:true,mode:mode,timestamp:Date.now(),players:playersObj};
    console.log("Writing results:",JSON.stringify(payload).slice(0,300));
    console.log("Path: sessions/"+onlineSessionCode+"/results");
    console.log("Players:",playerKeys.join(", "));
    
    db.ref("sessions/"+onlineSessionCode+"/results").set(payload).then(()=>{
      console.log("‚úÖ Results written successfully");
      toast("Results published to players ‚úÖ");
      // Verify the write
      db.ref("sessions/"+onlineSessionCode+"/results/locked").once("value").then(s=>{
        console.log("Verify locked:",s.val());
      });
    }).catch(err=>{
      console.error("‚ùå Results write FAILED:",err.message,err.code);
      toast("Failed to publish: "+err.message);
      // Retry without validation-sensitive fields
      console.log("Retrying with simple write...");
      db.ref("sessions/"+onlineSessionCode+"/results/locked").set(true);
      db.ref("sessions/"+onlineSessionCode+"/results/mode").set(mode);
      db.ref("sessions/"+onlineSessionCode+"/results/timestamp").set(Date.now());
      db.ref("sessions/"+onlineSessionCode+"/results/players").set(playersObj).then(()=>{
        console.log("‚úÖ Retry succeeded");toast("Results published (retry) ‚úÖ");
      }).catch(err2=>{console.error("‚ùå Retry also failed:",err2.message)});
    });
  }

  // Confetti
  function fireConfetti(){
    const canvas=document.createElement("canvas");canvas.className="confettiCanvas";document.body.appendChild(canvas);
    const ctx=canvas.getContext("2d");canvas.width=window.innerWidth;canvas.height=window.innerHeight;
    const colors=["#2bd576","#f5c542","#ff5c7a","#7aa7ff","#ec4899","#f97316","#7c3aed","#ffffff"];
    const pieces=[];for(let i=0;i<120;i++){pieces.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height*-.5-50,r:Math.random()*6+3,dx:(Math.random()-.5)*4,dy:Math.random()*3+2,rot:Math.random()*360,dr:Math.random()*8-4,color:colors[Math.floor(Math.random()*colors.length)],shape:Math.random()>.5?"rect":"circle"})}
    let frame=0;
    function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);let alive=false;pieces.forEach(p=>{p.x+=p.dx;p.y+=p.dy;p.dy+=.04;p.rot+=p.dr;if(p.y<canvas.height+20)alive=true;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot*Math.PI/180);ctx.fillStyle=p.color;if(p.shape==="rect")ctx.fillRect(-p.r,-p.r/2,p.r*2,p.r);else{ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill()}ctx.restore()});frame++;if(alive&&frame<180)requestAnimationFrame(draw);else canvas.remove()}
    requestAnimationFrame(draw);
  }

  // Mode
  function setMode(m){mode=m;document.querySelectorAll(".modeBtn").forEach(b=>{b.classList.toggle("active",b.dataset.mode===m);b.classList.toggle("tourney",b.dataset.mode==="tournament"&&b.dataset.mode===m)});$("onlineCard").classList.toggle("hidden",m!=="cash");$("chipValuesSection").classList.toggle("hidden",m!=="cash");$("prizeSplitSection").classList.toggle("hidden",m!=="tournament");$("cashAuditGrid").classList.toggle("hidden",m!=="cash");$("tournamentSummary").classList.toggle("hidden",m!=="tournament");$("timerCard").classList.toggle("hidden",m!=="tournament");$("placementSection").classList.toggle("hidden",m!=="tournament");$("topTitle").textContent=m==="cash"?"Poker Cashout (Admin)":"Tournament Mode (Admin)";$("topSub").textContent=`Buy-in ‚Ç•${state.buyinUsd} ¬∑ RF ${Math.round(state.taxRate*100)}%`;$("pill").classList.toggle("hidden",m!=="cash");$("footK1").textContent=m==="cash"?"Total Gross":"Prize Pool";$("footK3").textContent=m==="cash"?"Total Final":"Payouts";renderAllFull()}
  $("modeToggle").addEventListener("click",e=>{const b=e.target.closest(".modeBtn");if(b)setMode(b.dataset.mode)});

  // Timer
  function fmtTimer(s){return`${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`}
  function renderTimer(){const d=$("timerDisplay");d.textContent=fmtTimer(timerSeconds);d.className="timerDisplay"+(timerSeconds<=30&&timerSeconds>0?" danger":(timerSeconds<=60?" warn":""))}
  $("timerStart").addEventListener("click",()=>{if(timerRunning){clearInterval(timerInterval);timerRunning=false;$("timerStart").textContent="Start";return}timerSeconds=Math.max(1,Number($("timerMin").value)||10)*60;timerRunning=true;$("timerStart").textContent="Pause";renderTimer();timerInterval=setInterval(()=>{timerSeconds--;renderTimer();if(timerSeconds<=0){clearInterval(timerInterval);timerRunning=false;$("timerStart").textContent="Start";try{const ctx=new(window.AudioContext||window.webkitAudioContext)();[880,1100].forEach((f,i)=>{const o=ctx.createOscillator();o.type="sine";o.frequency.value=f;o.connect(ctx.destination);o.start(ctx.currentTime+i*.6);o.stop(ctx.currentTime+i*.6+.4)})}catch{}toast("‚è∞ Time's up!")}},1000)});
  $("timerReset").addEventListener("click",()=>{clearInterval(timerInterval);timerRunning=false;$("timerStart").textContent="Start";timerSeconds=(Number($("timerMin").value)||10)*60;renderTimer()});
  $("timerMin").addEventListener("input",()=>{if(!timerRunning){timerSeconds=(Number($("timerMin").value)||10)*60;renderTimer()}});renderTimer();

  // Firebase online
  function generateCode(){const ch="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let c="";for(let i=0;i<4;i++)c+=ch[Math.floor(Math.random()*ch.length)];return c}
  function getPlayerPageUrl(code){return window.location.href.replace(/\/[^/]*$/,"/")+`player.html?code=${code}`}
  function startOnlineSession(){const names=state.players.map(p=>p.name.trim()).filter(Boolean);if(!names.length){toast("Add players first");return}const dupes=names.filter((n,i)=>names.indexOf(n)!==i);if(dupes.length){toast("Fix duplicate names: "+dupes.join(", "));return}$("startOnline").innerHTML="Starting‚Ä¶";$("startOnline").disabled=true;const code=generateCode();onlineSessionCode=code;localStorage.setItem(ACTIVE_KEY,code);const cashouts={};names.forEach(n=>{cashouts[n]={submitted:false,buyinCount:1,timestamp:Date.now(),black:0,purple:0,yellow:0,pink:0,orange:0}});    db.ref("sessions/"+code+"/config").set({sessionName:state.sessionName||"Poker Night",buyinUsd:state.buyinUsd,taxRate:state.taxRate,chipValues:clone(state.chipValues),playerNames:names,createdAt:Date.now()}).then(()=>{
      return db.ref("sessions/"+code+"/adminUid").set(adminUid);
    }).then(()=>{
      return db.ref("sessions/"+code+"/cashouts").set(cashouts);
    }).then(()=>{
      return db.ref("sessions/"+code+"/admin_state").set({state:JSON.stringify(state),mode,updatedAt:Date.now()});
    }).then(()=>{showOnlineUI(code);toast("Online: "+code);listenForCashouts(code);syncBuyinsToFirebase()}).catch(err=>{toast("Error: "+err.message);onlineSessionCode=null}).finally(()=>{$("startOnline").innerHTML="Start Online";$("startOnline").disabled=false})}

  function showOnlineUI(code){$("onlineOff").style.display="none";$("onlineOn").style.display="block";$("sessionCodeDisplay").textContent=code;const url=getPlayerPageUrl(code);$("playerLinkDisplay").textContent=url;$("qrWrap").innerHTML="";try{const cv=document.createElement("canvas");cv.style.borderRadius="10px";new QRious({element:cv,value:url,size:180,backgroundAlpha:1,foreground:"#1a1f2e",background:"#ffffff",level:"M"});$("qrWrap").appendChild(cv)}catch(e){}$("startOnline").style.display="none";$("stopOnline").style.display="inline-flex";$("liveBadge").style.display="inline-flex";$("liveText").textContent=`LIVE: ${code}`}

  function stopOnlineSession(){if(firebaseListener&&onlineSessionCode){db.ref("sessions/"+onlineSessionCode+"/cashouts").off("value",firebaseListener);firebaseListener=null}onlineSessionCode=null;localStorage.removeItem(ACTIVE_KEY);$("onlineOff").style.display="block";$("onlineOn").style.display="none";$("startOnline").style.display="inline-flex";$("stopOnline").style.display="none";$("liveBadge").style.display="none";toast("Online ended")}

  function listenForCashouts(code){firebaseListener=db.ref("sessions/"+code+"/cashouts").on("value",snap=>{const data=snap.val();if(!data)return;const names=Object.keys(data);let sub=0;$("statusGrid").innerHTML=names.map(n=>{const d=data[n],is=!!d.submitted,ia=!!d.adminOverride;if(is||ia)sub++;return`<div class="statusItem ${(is||ia)?"submitted":"pending"}"><span class="sDot"></span>${esc(n)}${ia?' <span style="font-size:9px;color:var(--warn)">(admin)</span>':''}</div>`}).join("");$("submitCount").textContent=sub;$("submitTotal").textContent=names.length;if(sub>0&&sub===names.length&&!allSubmittedSounded){allSubmittedSounded=true;try{const ctx=new(window.AudioContext||window.webkitAudioContext)();[523,659,784,1047].forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type="sine";o.frequency.value=f;g.gain.value=.15;o.connect(g);g.connect(ctx.destination);o.start(ctx.currentTime+i*.15);o.stop(ctx.currentTime+i*.15+.2)})}catch{}toast("üéâ All submitted!")}      let ch=false;for(const p of state.players){const pn=p.name.trim(),pd=data[pn];if(pd&&pd.submitted&&!pd.adminOverride){COLORS.forEach(c=>{const nv=clamp(pd[c]||0);if(p.cashout[c]!==nv){p.cashout[c]=nv;ch=true}});savedCashouts.add(p.id)}}if(ch){toast("Cashout received ‚úì");save();renderPlayersFull();renderAuditAndSummary()}})}

  async function resumeSession(code){code=code.trim().toUpperCase();if(!code)return;toast("Resuming‚Ä¶");try{const snap=await db.ref("sessions/"+code+"/admin_state").once("value");const data=snap.val();if(!data||!data.state){toast("No state found for "+code);return}state=sanitize(JSON.parse(data.state));if(data.mode)mode=data.mode;save();
    // Reclaim admin ownership
    if(adminUid)await db.ref("sessions/"+code+"/adminUid").set(adminUid);
    onlineSessionCode=code;localStorage.setItem(ACTIVE_KEY,code);showOnlineUI(code);listenForCashouts(code);setMode(mode);toast("Resumed: "+code+" ‚úì")}catch(err){toast("Failed: "+err.message)}}

  // Rendering
  function colorCell(col,vu,ct,kind,pid,bid){const d=state.locked?"disabled":"";return`<div class="cell" data-color="${col}"><div class="ctop"><span class="sw ${SW[col]}"></span><span class="cname">${col[0].toUpperCase()+col.slice(1)}</span><span class="cval">${vu.toLocaleString()}</span></div><div class="stepper"><button class="sbtn" data-step="-1" data-kind="${kind}" data-p="${pid}" data-b="${bid||""}" data-c="${col}" ${d}>‚àí</button><input type="number" step="1" inputmode="numeric" min="0" max="999" data-kind="${kind}" data-p="${pid}" data-b="${bid||""}" data-c="${col}" value="${ct??0}" ${d}/><button class="sbtn" data-step="1" data-kind="${kind}" data-p="${pid}" data-b="${bid||""}" data-c="${col}" ${d}>+</button></div></div>`}
  function renderJumpNav(){$("jumpNav").innerHTML=state.players.length<=2?"":state.players.map((p,i)=>`<span class="jbtn" data-jump="${p.id}"><span class="pColorDot" style="background:${playerColor(i)};width:8px;height:8px;margin-right:4px"></span>${esc(p.name)}</span>`).join("")}
  function renderStatic(){$("playerCount").textContent=state.players.length;$("sessionName").value=state.sessionName;$("buyinUsd").value=state.buyinUsd;$("taxRate").value=state.taxRate;$("split1").value=state.split1;$("split2").value=state.split2;$("split3").value=state.split3;for(const c of COLORS)$("v_"+c).value=state.chipValues[c];$("lockSession").textContent=state.locked?"Unlock":"Lock";$("lockSession").classList.toggle("danger",state.locked);$("lockBadge").style.display=state.locked?"inline-flex":"none";$("lockedOverlay").style.display=state.locked?"block":"none";["sessionName","buyinUsd","taxRate","v_black","v_purple","v_yellow","v_pink","v_orange","split1","split2","split3"].forEach(id=>{const el=$(id);if(el)el.disabled=!!state.locked});const bs=$("bankSelect");bs.innerHTML=state.players.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join("");bs.value=state.bankId||(state.players[0]?.id||"");bs.disabled=!!state.locked;$("addPlayer").disabled=!!state.locked;$("resetAll").disabled=!!state.locked}

  function renderTourneyChipPack(){const w=$("tourneyChipPack");if(!w)return;const cv=state.chipValues;w.innerHTML=COLORS.map(c=>`<div class="cell" data-color="${c}"><div class="ctop"><span class="sw ${SW[c]}"></span><span class="cname">${c[0].toUpperCase()+c.slice(1)}</span><span class="cval">${cv[c].toLocaleString()}</span></div><div class="stepper"><button class="sbtn" data-step="-1" data-kind="tpack" data-c="${c}" ${state.locked?"disabled":""}>‚àí</button><input type="number" step="1" inputmode="numeric" data-kind="tpack" data-c="${c}" value="${state.tourneyPack[c]}" ${state.locked?"disabled":""}/><button class="sbtn" data-step="1" data-kind="tpack" data-c="${c}" ${state.locked?"disabled":""}>+</button></div></div>`).join("");const u=ufc(state.tourneyPack,cv);$("tourneyPackValue").innerHTML=`Pack: <b>${u.toLocaleString()}</b> units (~ <b>${fmtUsd(u2d(u))}</b>)`}

  function renderPlayersFull(){
    if(mode==="tournament"){$("players").innerHTML=state.players.map((p,pi)=>{const rc=p.buyins.length,tu=p.buyins.reduce((s,b)=>s+ufc(b.counts,state.chipValues),0),cs=COLORS.map(c=>{const v=p.buyins[0].counts[c];return v?`<span style="display:inline-flex;align-items:center;gap:3px;margin-right:6px"><span class="sw ${SW[c]}" style="width:8px;height:8px"></span>${v}</span>`:""}).filter(Boolean).join("");return`<div class="player" data-p="${p.id}" id="player_${p.id}"><div class="phd"><span class="pColorDot" style="background:${playerColor(pi)}"></span><div class="pname"><input type="text" value="${esc(p.name)}" data-kind="name" data-p="${p.id}" ${state.locked?"disabled":""} style="font-weight:600;background:transparent;border-color:transparent;padding:5px 8px" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='transparent'"/><div style="font-size:11px;color:var(--muted);margin-top:2px;padding-left:8px">${cs} ¬∑ ${fmtUsd(u2d(tu))} (${rc} buy-in${rc>1?"s":""})</div></div><div class="pactions"><button class="btn small" data-act="addRebuy" data-p="${p.id}" ${state.locked?"disabled":""}>+ Rebuy</button><button class="btn small danger" data-act="removeRebuy" data-p="${p.id}" ${state.locked||rc<=1?"disabled":""}>‚àí Rebuy</button><button class="btn small danger" data-act="delPlayer" data-p="${p.id}" ${state.locked?"disabled":""}>‚úï</button></div></div></div>`}).join("");renderTourneyChipPack();[1,2,3].forEach(i=>{const sel=$("place"+i),cur=state["place"+i];sel.innerHTML='<option value="">Select</option>'+state.players.map(p=>`<option value="${p.id}" ${p.id===cur?"selected":""}>${esc(p.name)}</option>`).join("");sel.disabled=!!state.locked});renderTournamentSummary()
    }else{$("players").innerHTML=state.players.map((p,pi)=>{const isCol=collapsedPlayers.has(p.id),bh=p.buyins.map((b,i)=>{const t=i===0?"Buy-in 1":`Rebuy ${i}`,du=ufc(b.counts,state.chipValues);return`<div class="miniCard"><div class="miniHd"><b>${t}</b><button class="btn small danger" data-act="delBuyin" data-p="${p.id}" data-b="${b.id}" ${(state.locked||p.buyins.length===1)?"disabled":""}>Remove</button></div><div class="miniBd"><div class="chips">${COLORS.map(c=>colorCell(c,state.chipValues[c],b.counts[c],"buyin",p.id,b.id)).join("")}</div><div class="note" id="disp_${p.id}_${b.id}">Dispensed: <b>${du.toLocaleString()}</b> (~ <b>${fmtUsd(u2d(du))}</b>)</div></div></div>`}).join("");      const ou=ufc(p.cashout,state.chipValues);
      const hasChips=tcc(p.cashout)>0;
      const isSaved=savedCashouts.has(p.id);
      const statusHtml=isSaved?'<span class="cashoutStatus saved">üü¢ Saved</span>':hasChips?'<span class="cashoutStatus pending">üü° Unsaved</span>':'<span class="cashoutStatus pending">‚ö™ Pending</span>';
      const saveBtnHtml=state.locked?'':`<button class="saveBtn ${isSaved?"done":""}" data-savecashout="${p.id}" type="button">${isSaved?"‚úÖ Saved":"üíæ Save cashout"}</button>`;
      return`<div class="player ${isCol?"is-collapsed":""}" data-p="${p.id}" id="player_${p.id}"><div class="phd"><span class="chevron" data-act="togglePlayer" data-p="${p.id}">‚ñº</span><span class="pColorDot" style="background:${playerColor(pi)}"></span><div class="pname"><input type="text" value="${esc(p.name)}" data-kind="name" data-p="${p.id}" ${state.locked?"disabled":""} maxlength="20" style="font-weight:600;background:transparent;border-color:transparent;padding:5px 8px" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='transparent'"/><div class="pSummaryInline">${shortSummary(p)} ${statusHtml}</div></div><div class="pactions"><button class="btn small" data-act="addRebuy" data-p="${p.id}" ${state.locked?"disabled":""}>+ Rebuy</button><button class="btn small danger" data-act="delPlayer" data-p="${p.id}" ${state.locked?"disabled":""}>Remove</button></div></div><div class="pbd ${isCol?"collapsed":""}"><div class="outblock"><label>Buy-ins & Rebuys</label></div>${bh}<div class="cashoutSection"><label>Cashout (chips OUT) ${statusHtml}</label><div class="presetBar" style="margin-top:6px">${state.locked?"":Object.entries(CHIP_PRESETS).map(([k,v])=>`<button class="presetBtn" data-cashpreset="${k}" data-presetp="${p.id}" type="button">${k==="standard"?"üé∞ Std":k==="half"?"¬Ω":k==="heavy"?"üí∞":"ü™∂"}</button>`).join("")+`<button class="presetBtn" data-cashpreset="clear" data-presetp="${p.id}" type="button">‚úï</button>`}</div><div class="chips" style="margin-top:6px">${COLORS.map(c=>colorCell(c,state.chipValues[c],p.cashout[c],"cashout",p.id,"")).join("")}</div><div class="note" id="cashnote_${p.id}">Cashout: <b>${ou.toLocaleString()}</b> (~ <b>${fmtUsd(u2d(ou))}</b>)</div>${saveBtnHtml}</div><div class="outblock"><label>Summary</label><pre id="out_${p.id}">${esc(outputBlockText(p))}</pre></div></div></div>`}).join("")}}

  function renderTournamentSummary(){const t=calcTournament(),tb=$("tourneySummaryBody"),md=["ü•á","ü•à","ü•â"];tb.innerHTML=t.results.map((r,i)=>{if(!r)return`<tr><td>${md[i]}</td><td class="muted">Not selected</td><td></td><td></td><td></td><td></td><td></td></tr>`;const cls=r.net>0?"good":(r.net<0?"bad":"muted");return`<tr><td>${md[i]}</td><td>${esc(r.name)}</td><td class="num">${r.buyins}</td><td class="num">${fmtUsd(r.prize)}</td><td class="num">${fmtUsd(r.rf)}</td><td class="num">${fmtUsd(r.payout)}</td><td class="num ${cls}">${r.net>=0?"+":""}${fmtUsd(r.net)}</td></tr>`}).join("");state.players.filter(p=>![state.place1,state.place2,state.place3].includes(p.id)).forEach(p=>{const bt=p.buyins.length*state.buyinUsd;tb.innerHTML+=`<tr><td></td><td>${esc(p.name)}</td><td class="num">${p.buyins.length}</td><td class="num">‚Ç•0.00</td><td class="num">‚Ç•0.00</td><td class="num">‚Ç•0.00</td><td class="num bad">-${fmtUsd(bt)}</td></tr>`});$("tourneyInfoText").textContent=`Pool: ${fmtUsd(t.pool)} ¬∑ Split: ${state.split1}/${state.split2}/${state.split3} ¬∑ RF: ${Math.round(state.taxRate*100)}%`;const tp=t.results.reduce((s,r)=>s+(r?r.payout:0),0),tr2=t.results.reduce((s,r)=>s+(r?r.rf:0),0);$("t_gross").textContent=fmtUsd(t.pool);$("t_rf").textContent=fmtUsd(tr2);$("t_final").textContent=fmtUsd(tp)}

  function applyMismatchHighlights(mc){document.querySelectorAll('.cell').forEach(el=>el.className=el.className.replace(/\bhl-\w+/g,''));if(mc)for(const c of mc)document.querySelectorAll(`.cell[data-color="${c}"]`).forEach(el=>el.classList.add('hl-'+c))}
  function setAuditHint(m){const box=$('auditHint');if(!m||!m.length){box.style.display='none';return}box.style.display='block';box.innerHTML='Fix:<br/>'+m.map(x=>`<span class="chip"><span class="sw ${SW[x.color]}"></span><b>${x.color[0].toUpperCase()+x.color.slice(1)}</b>: ${x.diff>0?"+":""}${x.diff}</span>`).join('')}
  function renderAuditAndSummary(){if(mode==="tournament"){renderTournamentSummary();return}const{IN,OUT}=calcAudit();$("auditBody").innerHTML=COLORS.map(c=>{const d=OUT[c]-IN[c],cls=d===0?"good":(Math.abs(d)<=1?"warn":"bad");return`<tr><td>${c[0].toUpperCase()+c.slice(1)}</td><td class="num">${IN[c]}</td><td class="num">${OUT[c]}</td><td class="num ${cls}">${d}</td></tr>`}).join("");    let tg=0,trf=0,tf=0;$("summaryBody").innerHTML=state.players.map((p,pi)=>{const c=calcPlayer(p);tg+=c.gross;trf+=c.rfTax;tf+=c.finalPayout;const cls=c.netProfit>0?"good":(c.netProfit<0?"bad":"muted");return`<tr><td><span class="pColorDot" style="background:${playerColor(pi)};margin-right:6px"></span>${esc(p.name)}</td><td class="num">${c.buyinsCount}</td><td class="num">${fmtUsd(c.gross)}</td><td class="num">${fmtUsd(c.rfTax)}</td><td class="num">${fmtUsd(c.finalPayout)}</td><td class="num ${cls}">${fmtUsd(c.netProfit)}</td></tr>`}).join("");    $("t_gross").textContent=fmtUsd(tg);$("t_rf").textContent=fmtUsd(trf);$("t_final").textContent=fmtUsd(tf);
    // Rake & pot stats
    const totalBuyins=state.players.reduce((s,p)=>s+p.buyins.length*state.buyinUsd,0);
    $("rakeBar").innerHTML=`<div class="rakeStat"><div class="rs-v">${fmtUsd(totalBuyins)}</div><div class="rs-k">Total Pot</div></div><div class="rakeStat"><div class="rs-v">${fmtUsd(trf)}</div><div class="rs-k">RF Rake</div></div><div class="rakeStat"><div class="rs-v">${state.players.length}</div><div class="rs-k">Players</div></div><div class="rakeStat"><div class="rs-v">${state.players.reduce((s,p)=>s+p.buyins.length,0)}</div><div class="rs-k">Total Buy-ins</div></div>`;
    // Payout preview (always visible)
    const ppLines=buildPayoutLines();
    const ppEl=$("payPreview"),ppL=$("payPreviewLines");
    if(ppLines.length){ppEl.style.display="block";ppL.innerHTML=ppLines.map(l=>`<div class="ppLine"><span class="ppDir">${l.type==="collect"?"üì•":"üì§"} ${esc(l.label)}</span><span class="ppAmt">${fmtUsd(l.amount)}</span></div>`).join("")}else{ppEl.style.display="none"}const mm=COLORS.map(c=>({color:c,diff:OUT[c]-IN[c]})).filter(x=>x.diff!==0),hd=COLORS.some(c=>IN[c]||OUT[c]);applyMismatchHighlights(mm.map(m=>m.color));setAuditHint(mm);const pill=$("pill"),pt=$("pillText");if(!hd){pill.className="pill warn";pt.textContent="Audit: pending"}else if(mm.length){pill.className="pill bad";pt.textContent=`Mismatch √ó${mm.length}`}else{pill.className="pill good";pt.textContent="Audit: OK ‚úì"}}

  function buildPayoutLines(){if(mode==="tournament"){const t=calcTournament(),bn=state.players.find(p=>p.id===state.bankId)?.name||"Bank",lines=[];state.players.forEach(p=>{if(p.id!==state.bankId)lines.push({key:`bi-${p.id}`,label:`${p.name} ‚Üí ${bn}`,amount:p.buyins.length*state.buyinUsd,type:"collect"})});t.results.forEach((r,i)=>{if(r){const p=state.players.find(x=>x.name.trim()===r.name);if(p&&p.id!==state.bankId)lines.push({key:`pay-${p.id}`,label:`${bn} ‚Üí ${r.name}`,amount:r.payout,type:"pay"})}});return lines}else{const bid=state.bankId||state.players[0]?.id,bn=state.players.find(p=>p.id===bid)?.name||"Bank",lines=[];state.players.forEach(p=>{if(p.id!==bid)lines.push({key:`bi-${p.id}`,label:`${p.name} ‚Üí ${bn}`,amount:p.buyins.length*state.buyinUsd,type:"collect"})});state.players.forEach(p=>{const c=calcPlayer(p);if(p.id!==bid&&c.finalPayout>0)lines.push({key:`pay-${p.id}`,label:`${bn} ‚Üí ${p.name}`,amount:c.finalPayout,type:"pay"})});return lines}}

  function renderPayouts(){const card=$("payoutCard");if(!state.locked){card.style.display="none";return}card.style.display="block";const lines=buildPayoutLines();$("payoutLines").innerHTML=lines.map(l=>{const ip=!!paidMap[l.key];return`<div class="payLine ${ip?"paid":""}" data-paykey="${l.key}"><div class="payBg ${ip?"toUnpay":"toBePaid"}">${ip?"‚Üê Undo":"Paid ‚úì ‚Üí"}</div><div class="payContent"><div><span style="font-size:12px;font-weight:600">${esc(l.label)}</span><br><span class="muted" style="font-size:11px">${l.type==="collect"?"Buy-in":"Payout"}</span></div><div style="text-align:right"><span style="font-weight:700">${fmtUsd(l.amount)}</span>${ip?'<br><span class="paidBadge">PAID</span>':''}</div></div></div>`}).join("");
    document.querySelectorAll(".payLine").forEach(el=>{let sx=0,sy=0,cx=0,swiping=false;el.addEventListener("touchstart",e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;cx=sx;swiping=true},{passive:true});el.addEventListener("touchmove",e=>{if(!swiping)return;const dy=e.touches[0].clientY-sy,dx=e.touches[0].clientX-sx;if(Math.abs(dy)>Math.abs(dx)){swiping=false;el.querySelector(".payContent").style.cssText="transition:transform .2s;transform:none";return}cx=e.touches[0].clientX;el.querySelector(".payContent").style.cssText=`transform:translateX(${Math.max(-80,Math.min(80,dx))}px);transition:none`},{passive:true});el.addEventListener("touchend",()=>{el.querySelector(".payContent").style.cssText="transition:transform .2s;transform:none";if(!swiping)return;swiping=false;const dx=cx-sx,key=el.dataset.paykey;if(dx>60&&!paidMap[key]){paidMap[key]=true;savePaid();renderPayouts();toast("Paid ‚úì")}else if(dx<-60&&paidMap[key]){delete paidMap[key];savePaid();renderPayouts();toast("Unmarked")}})})}

  function renderHistory(){const h=loadHistory(),tb=$("historyBody"),em=$("historyEmpty");if(!h.length){tb.innerHTML="";em.style.display="block";return}em.style.display="none";tb.innerHTML=h.map(s=>{const d=new Date(s.date),ds=d.toLocaleDateString(undefined,{month:'short',day:'numeric'}),ts=d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});const dr=s.players.map(p=>{const cls=p.net>0?"good":(p.net<0?"bad":"muted");return`<tr class="sessionDetail" data-detail="${s.id}"><td></td><td>${esc(p.name)}</td><td class="num ${cls}">${p.net>=0?"+":""}${fmtUsd(p.net)}</td><td></td><td></td></tr>`}).join("");    return`<tr class="sessionRow" data-sid="${s.id}"><td>${ds} <span class="muted" style="font-size:10px">${ts}</span></td><td>${esc(s.sessionName)}</td><td class="num"><span class="modeBadge ${(s.mode||"cash")==="tournament"?"tourney":"cash"}">${(s.mode||"cash")==="tournament"?"üèÜ":"‚ô†"}</span></td><td class="num">${s.playerCount}</td><td><button class="deleteSession" data-delsession="${s.id}" type="button">‚úï</button></td></tr>${dr}`}).join("")}

  function renderStats(){const h=loadHistory();$("statsSessionCount").textContent=`${h.length} game${h.length!==1?"s":""}`;if(!h.length){$("statsBody").innerHTML="";$("statsEmpty").style.display="block";return}$("statsEmpty").style.display="none";const map={};for(const s of h)for(const p of s.players){const k=p.name.trim().toLowerCase();if(!map[k])map[k]={name:p.name.trim(),sessions:0,wins:0,totalNet:0};const m=map[k];m.sessions++;m.totalNet+=p.net;if(p.net>0)m.wins++;m.name=p.name.trim()}$("statsBody").innerHTML=Object.values(map).sort((a,b)=>b.totalNet-a.totalNet).map(s=>{const wp=s.sessions?Math.round(s.wins/s.sessions*100):0,avg=s.sessions?s.totalNet/s.sessions:0,nc=s.totalNet>0?"statPositive":(s.totalNet<0?"statNegative":"statNeutral");return`<tr><td>${esc(s.name)}</td><td class="num">${s.sessions}</td><td class="num">${s.wins}</td><td class="num">${wp}%</td><td class="num ${nc}">${s.totalNet>=0?"+":""}${fmtUsd(s.totalNet)}</td><td class="num">${avg>=0?"+":""}${fmtUsd(avg)}</td></tr>`}).join("")}

  function renderRosterChips(){const roster=loadRoster(),cur=state.players.map(p=>p.name.trim().toLowerCase());$("rosterChips").innerHTML=roster.length?roster.map((n,i)=>{const inG=cur.includes(n.trim().toLowerCase());return`<div class="rosterChip" data-ridx="${i}"><div class="rc-name"><input type="text" value="${esc(n)}" data-rname-idx="${i}" placeholder="Player name"/></div><div class="rc-add ${inG?"disabled":""}" data-radd="${i}">${inG?"‚úì In game":"+ Add"}</div><div class="rc-del" data-rdel="${i}">Delete</div></div>`}).join(""):'<div class="note" style="margin:0">No regular players saved. Add below or click "Save roster".</div>'}

  function renderAllFull(){renderStatic();renderJumpNav();renderPlayersFull();renderAuditAndSummary();renderPayouts();renderHistory();renderStats();renderRosterChips();save()}

  // Events
  $("sessionName").addEventListener("input",e=>{if(!state.locked){state.sessionName=e.target.value;save()}});
  $("buyinUsd").addEventListener("input",e=>{if(!state.locked){state.buyinUsd=Math.min(10000,Math.max(1,Number(e.target.value)||DEFAULTS.buyinUsd));renderAllFull()}});
  $("taxRate").addEventListener("input",e=>{if(!state.locked){state.taxRate=Math.min(1,Math.max(0,Number(e.target.value)||0));renderAllFull()}});
  $("bankSelect").addEventListener("change",e=>{if(!state.locked){state.bankId=e.target.value;save();renderAllFull()}});
  for(const c of COLORS)$("v_"+c).addEventListener("input",e=>{if(!state.locked){state.chipValues[c]=Number(e.target.value)||DEFAULTS.chipValues[c];renderAllFull()}});
  ["split1","split2","split3"].forEach(id=>$(id).addEventListener("input",e=>{if(!state.locked){state[id]=Number(e.target.value)||0;renderAllFull()}}));
  [1,2,3].forEach(i=>$("place"+i).addEventListener("change",e=>{state["place"+i]=e.target.value;save();renderAllFull()}));
  $("copyChipPack").addEventListener("click",()=>{if(state.locked)return;const pack=clone(state.tourneyPack);for(const p of state.players)for(const b of p.buyins)for(const c of COLORS)b.counts[c]=pack[c];save();renderAllFull();toast(`Copied to ${state.players.length} ‚úì`)});

  // Chip presets (buy-in)
  document.addEventListener("click",e=>{
    const pb=e.target.closest("[data-preset]");
    if(pb&&!state.locked){
      const preset=CHIP_PRESETS[pb.dataset.preset];
      if(!preset)return;
      for(const p of state.players)p.buyins[0].counts=clone(preset);
      DEFAULTS.defaultPack=clone(preset);
      renderAllFull();toast("Buy-in preset applied ‚úì");return;
    }
    // Cashout presets (per player)
    const cpb=e.target.closest("[data-cashpreset]");
    if(cpb&&!state.locked){
      const pid=cpb.dataset.presetp;
      const key=cpb.dataset.cashpreset;
      const p=state.players.find(x=>x.id===pid);
      if(!p)return;
      if(key==="clear"){COLORS.forEach(c=>{p.cashout[c]=0})}
      else{const preset=CHIP_PRESETS[key];if(!preset)return;COLORS.forEach(c=>{p.cashout[c]=preset[c]||0})}
      save();renderPlayersFull();renderAuditAndSummary();
      if(onlineSessionCode)setAdminOverride(p.name.trim());
      toast(key==="clear"?"Cashout cleared":"Preset applied");return;
    }
  });

  let allCollapsed=false;
  $("collapseAll").addEventListener("click",()=>{allCollapsed=!allCollapsed;if(allCollapsed)state.players.forEach(p=>collapsedPlayers.add(p.id));else collapsedPlayers.clear();$("collapseAll").textContent=allCollapsed?"Expand all":"Collapse all";document.querySelectorAll(".player").forEach(el=>{el.classList.toggle("is-collapsed",allCollapsed);el.querySelector(".pbd")?.classList.toggle("collapsed",allCollapsed)})});

  $("addPlayer").addEventListener("click",()=>{if(!state.locked){const p=makePlayer(`Player ${state.players.length+1}`);if(mode==="tournament")p.buyins[0].counts=clone(state.tourneyPack);state.players.push(p);renderAllFull();toast("Added")}});
  $("resetAll").addEventListener("click",()=>{if(!state.locked&&confirm("Reset session?")){localStorage.removeItem(KEY);state=defaultState();collapsedPlayers.clear();paidMap={};savePaid();renderAllFull();toast("Reset")}});
  $("lockSession").addEventListener("click",()=>{
    const was=!state.locked;
    state.locked=!state.locked;save();
    if(state.locked&&was){
      // Use stored session code if online code lost
      const code=onlineSessionCode||localStorage.getItem(ACTIVE_KEY);
      if(code){
        onlineSessionCode=code;
        syncResultsToFirebase();
      }
      fireConfetti();
      archiveCurrentSession();
      toast("Locked & archived üîí");
      renderAllFull();
      return;
    }
    if(!state.locked)allSubmittedSounded=false;
    renderAllFull();
    toast(state.locked?"Locked üîí":"Unlocked üîì");
  });
  $("archiveSession").addEventListener("click",()=>{if(archiveCurrentSession()){renderHistory();renderStats();toast("Archived ‚úì")}});
  $("clearHistory").addEventListener("click",()=>{if(confirm("Delete ALL history?")){saveHistory([]);renderHistory();renderStats();toast("Cleared")}});
  $("startOnline").addEventListener("click",startOnlineSession);
  $("stopOnline").addEventListener("click",()=>{if(confirm("End online?"))stopOnlineSession()});
  $("resumeBtn").addEventListener("click",()=>resumeSession($("resumeCode").value));
  $("resumeCode").addEventListener("keydown",e=>{if(e.key==="Enter")$("resumeBtn").click()});
  $("copyCode").addEventListener("click",()=>{if(onlineSessionCode)navigator.clipboard?.writeText(onlineSessionCode).then(()=>toast("Copied"))});
  $("copyLink").addEventListener("click",()=>{if(onlineSessionCode)navigator.clipboard?.writeText(getPlayerPageUrl(onlineSessionCode)).then(()=>toast("Copied"))});
  $("exportHistory").addEventListener("click",()=>{const h=loadHistory();if(!h.length){toast("Nothing");return}const rows=[["Date","Session","Mode","Player","Buy-ins","Gross","RF","Final","Net"]];h.forEach(s=>{const d=new Date(s.date).toLocaleDateString();s.players.forEach(p=>{rows.push([d,s.sessionName,s.mode||"cash",p.name,p.buyins,p.gross?.toFixed(2),p.rfTax?.toFixed(2),p.final?.toFixed(2),p.net?.toFixed(2)])})});const csv=rows.map(r=>r.map(c=>`"${(c??"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");const blob=new Blob([csv],{type:"text/csv"}),url=URL.createObjectURL(blob),a=document.createElement("a");a.href=url;a.download=`ipl-history-${new Date().toISOString().slice(0,10)}.csv`;a.click();URL.revokeObjectURL(url);toast("Exported ‚úì")});

  // Export results as shareable image
  $("exportImage").addEventListener("click",()=>{
    const W=640,pad=24,lineH=26,headerH=90;
    const players=state.players.map((p,i)=>({name:p.name.trim(),color:playerColor(i),...calcPlayer(p)}));
    players.sort((a,b)=>b.netProfit-a.netProfit);
    const totalPot=state.players.reduce((s,p)=>s+p.buyins.length*state.buyinUsd,0);
    const totalRake=players.reduce((s,p)=>s+p.rfTax,0);

    // Calculate payout lines
    const bankId=state.bankId||state.players[0]?.id;
    const bankName=state.players.find(p=>p.id===bankId)?.name||"Bank";
    const payLines=[];
    state.players.forEach(p=>{if(p.id!==bankId){payLines.push({label:`${p.name} ‚Üí ${bankName}`,amt:p.buyins.length*state.buyinUsd,type:"in"})}});
    state.players.forEach(p=>{const c=calcPlayer(p);if(p.id!==bankId&&c.finalPayout>0){payLines.push({label:`${bankName} ‚Üí ${p.name}`,amt:c.finalPayout,type:"out"})}});

    const tableH=lineH*(players.length+1);
    const payH=payLines.length?lineH*(payLines.length+2)+20:0;
    const H=headerH+pad+tableH+20+payH+80;
    const cv=document.createElement("canvas");cv.width=W;cv.height=H;
    const ctx=cv.getContext("2d");

    // Background
    ctx.fillStyle="#1a1f2e";ctx.fillRect(0,0,W,H);

    // Header
    ctx.fillStyle="#e8eefc";ctx.font="bold 24px system-ui";ctx.textAlign="center";
    ctx.fillText("‚ô† ‚ô• IPL ‚ô¶ ‚ô£",W/2,36);
    ctx.fillStyle="#8b95b0";ctx.font="13px system-ui";
    ctx.fillText(state.sessionName||"Poker Night",W/2,56);
    ctx.fillText(new Date().toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric',year:'numeric'}),W/2,72);
    ctx.font="11px system-ui";
    ctx.fillText(`Buy-in: ${fmtUsd(state.buyinUsd)} ¬∑ RF: ${Math.round(state.taxRate*100)}% ¬∑ ${players.length} players ¬∑ Pot: ${fmtUsd(totalPot)}`,W/2,86);

    // Table header
    let y=headerH+pad;
    ctx.fillStyle="#8b95b0";ctx.font="bold 10px system-ui";ctx.textAlign="left";
    ctx.fillText("Player",pad,y);
    ctx.textAlign="right";
    ctx.fillText("Buy-ins",W*0.32,y);ctx.fillText("Gross",W*0.46,y);ctx.fillText("RF Tax",W*0.58,y);ctx.fillText("Final",W*0.72,y);ctx.fillText("Net",W-pad,y);
    y+=4;ctx.strokeStyle="rgba(255,255,255,0.1)";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-pad,y);ctx.stroke();
    y+=lineH-4;

    // Player rows
    players.forEach(p=>{
      ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(pad+5,y-4,4,0,Math.PI*2);ctx.fill();
      ctx.fillStyle="#e8eefc";ctx.font="13px system-ui";ctx.textAlign="left";
      ctx.fillText(p.name.slice(0,14),pad+16,y);
      ctx.textAlign="right";ctx.font="12px system-ui";
      ctx.fillStyle="#8b95b0";
      ctx.fillText(`${p.buyinsCount}√ó${fmtUsd(state.buyinUsd)}`,W*0.32,y);
      ctx.fillStyle="#e8eefc";
      ctx.fillText(fmtUsd(p.gross),W*0.46,y);
      ctx.fillStyle="#f5c542";
      ctx.fillText(fmtUsd(p.rfTax),W*0.58,y);
      ctx.fillStyle="#e8eefc";
      ctx.fillText(fmtUsd(p.finalPayout),W*0.72,y);
      ctx.fillStyle=p.netProfit>0?"#2bd576":(p.netProfit<0?"#ff5c7a":"#8b95b0");
      ctx.fillText((p.netProfit>=0?"+":"")+fmtUsd(p.netProfit),W-pad,y);
      y+=lineH;
    });

    // Separator
    y+=8;ctx.strokeStyle="rgba(255,255,255,0.08)";ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-pad,y);ctx.stroke();y+=14;

    // Payout section
    if(payLines.length){
      ctx.fillStyle="#8b95b0";ctx.font="bold 11px system-ui";ctx.textAlign="left";
      ctx.fillText("üí∏ SETTLEMENT ("+bankName+" = Bank)",pad,y);y+=lineH;

      payLines.forEach(l=>{
        ctx.fillStyle=l.type==="in"?"#8b95b0":"#e8eefc";
        ctx.font="12px system-ui";ctx.textAlign="left";
        ctx.fillText((l.type==="in"?"üì• ":"üì§ ")+l.label,pad,y);
        ctx.textAlign="right";ctx.font="bold 12px system-ui";
        ctx.fillStyle=l.type==="in"?"#8b95b0":"#2bd576";
        ctx.fillText(fmtUsd(l.amt),W-pad,y);
        y+=lineH;
      });
      y+=6;
    }

    // Footer stats
    ctx.strokeStyle="rgba(255,255,255,0.08)";ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-pad,y);ctx.stroke();y+=16;
    ctx.fillStyle="#8b95b0";ctx.font="11px system-ui";ctx.textAlign="center";
    ctx.fillText(`Pot: ${fmtUsd(totalPot)}  ¬∑  RF Rake: ${fmtUsd(totalRake)}  ¬∑  Total Payouts: ${fmtUsd(players.reduce((s,p)=>s+p.finalPayout,0))}`,W/2,y);
    y+=18;ctx.fillStyle="rgba(139,149,176,0.35)";ctx.font="10px system-ui";
    ctx.fillText("Innovation Poker League  ‚ô†‚ô•‚ô¶‚ô£",W/2,y);

    // Share / download
    cv.toBlob(blob=>{
      if(navigator.share&&navigator.canShare){
        const file=new File([blob],`ipl-${(state.sessionName||"results").replace(/\s+/g,"-")}.png`,{type:"image/png"});
        if(navigator.canShare({files:[file]})){navigator.share({files:[file],title:"IPL Results"}).catch(()=>{});return}
      }
      const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`ipl-results-${new Date().toISOString().slice(0,10)}.png`;a.click();URL.revokeObjectURL(url);
      toast("Image saved ‚úì");
    },"image/png");
  });

  // Roster
  $("saveRoster").addEventListener("click",()=>{const n=state.players.map(p=>p.name.trim()).filter(Boolean);const existing=loadRoster();const merged=[...new Set([...existing,...n])];saveRosterData(merged);renderRosterChips();toast(`Roster updated (${merged.length})`)});
  $("loadRoster").addEventListener("click",()=>{const r=loadRoster();if(!r.length){toast("No roster");return}state.players=r.map(x=>makePlayer(x));renderAllFull();toast(`Loaded ${r.length}`)});
  let rosterOpen=false;$("rosterToggle").addEventListener("click",()=>{rosterOpen=!rosterOpen;$("rosterBody").classList.toggle("open",rosterOpen);$("rosterChev").textContent=rosterOpen?"‚ñ≤":"‚ñº"});
  document.addEventListener("click",e=>{
    // Roster: Add to game
    const addBtn=e.target.closest("[data-radd]");
    if(addBtn&&!addBtn.classList.contains("disabled")&&!state.locked){
      const roster=loadRoster();const idx=Number(addBtn.dataset.radd);const name=roster[idx];
      if(!name)return;
      if(state.players.some(p=>p.name.trim().toLowerCase()===name.trim().toLowerCase())){toast("Already in game");return}
      const p=makePlayer(name);if(mode==="tournament")p.buyins[0].counts=clone(state.tourneyPack);
      state.players.push(p);renderAllFull();toast(`${name} added`);return;
    }
    // Roster: Delete
    const delBtn=e.target.closest("[data-rdel]");
    if(delBtn){
      const roster=loadRoster();const idx=Number(delBtn.dataset.rdel);
      const name=roster[idx];
      roster.splice(idx,1);saveRosterData(roster);renderRosterChips();toast(`${name} removed from roster`);return;
    }
  },true);

  // Roster: rename on blur
  document.addEventListener("change",e=>{
    const inp=e.target.closest("[data-rname-idx]");
    if(!inp)return;
    const idx=Number(inp.dataset.rnameIdx);
    const newName=inp.value.trim();
    const roster=loadRoster();
    if(!newName){toast("Name can't be empty");inp.value=roster[idx]||"";return}
    if(roster.some((n,i)=>i!==idx&&n.toLowerCase()===newName.toLowerCase())){toast("Name already in roster");inp.value=roster[idx]||"";return}
    roster[idx]=newName;saveRosterData(roster);renderRosterChips();toast(`Renamed to ${newName}`);
  },true);
  $("rosterAddBtn").addEventListener("click",()=>{const inp=$("rosterNewName"),name=inp.value.trim();if(!name){toast("Enter a name");return}const r=loadRoster();if(r.some(n=>n.toLowerCase()===name.toLowerCase())){toast("Already in roster");return}r.push(name);saveRosterData(r);inp.value="";renderRosterChips();toast(`${name} saved`)});
  $("rosterNewName").addEventListener("keydown",e=>{if(e.key==="Enter")$("rosterAddBtn").click()});
  $("rosterAddAll").addEventListener("click",()=>{if(state.locked)return;const r=loadRoster(),cur=state.players.map(p=>p.name.trim().toLowerCase());let n=0;r.forEach(nm=>{if(!cur.includes(nm.trim().toLowerCase())){const p=makePlayer(nm);if(mode==="tournament")p.buyins[0].counts=clone(state.tourneyPack);state.players.push(p);cur.push(nm.trim().toLowerCase());n++}});if(n){renderAllFull();renderRosterChips();toast(`${n} added`)}else toast("All in game already")});
  $("rosterClearAll").addEventListener("click",()=>{if(confirm("Clear roster?")){saveRosterData([]);renderRosterChips();toast("Cleared")}});

  // Cashout save button
  document.addEventListener("click",e=>{
    const sb=e.target.closest("[data-savecashout]");
    if(!sb||state.locked)return;
    const pid=sb.dataset.savecashout;
    const p=state.players.find(x=>x.id===pid);
    if(!p)return;
    if(tcc(p.cashout)===0){toast("Enter chip counts first");return}
    savedCashouts.add(pid);
    if(onlineSessionCode)setAdminOverride(p.name.trim());
    save();renderPlayersFull();renderAuditAndSummary();
    toast(`${p.name} cashout saved ‚úÖ`);
  });

  let rulesCol=false;$("toggleRules").addEventListener("click",()=>{rulesCol=!rulesCol;$("rulesBody").style.display=rulesCol?"none":"block";$("toggleRules").textContent=rulesCol?"Expand":"Collapse"});
  $("toTop").addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"}));
  $("copyAll").addEventListener("click",()=>{const l=[state.sessionName.trim()];if(mode==="tournament"){const t=calcTournament();t.results.forEach((r,i)=>{if(r)l.push(`${i+1}. ${r.name}: ${fmtUsd(r.payout)} (net ${r.net>=0?"+":""}${fmtUsd(r.net)})`)})}else state.players.forEach(p=>{l.push(p.name,outputBlockText(p),"")});navigator.clipboard?.writeText(l.join("\n")).then(()=>toast("Copied"))});
  $("copyPayouts").addEventListener("click",()=>{navigator.clipboard?.writeText(buildPayoutLines().map(l=>`${l.label}: ${fmtUsd(l.amount)}${paidMap[l.key]?" ‚úì":""}`).join("\n")).then(()=>toast("Copied"))});

  document.addEventListener("input",e=>{if(state.locked)return;const t=e.target,kind=t?.getAttribute?.("data-kind"),pid=t?.getAttribute?.("data-p");if(kind==="tpack"){const color=t.getAttribute("data-c");if(color){state.tourneyPack[color]=Math.max(0,Number(t.value)||0);save();renderTourneyChipPack()}return}if(!kind||!pid)return;const p=state.players.find(x=>x.id===pid);if(!p)return;    if(kind==="name"){p.name=t.value.slice(0,20);renderAuditAndSummary();renderJumpNav();save();return}const color=t.getAttribute("data-c"),bid=t.getAttribute("data-b");if(kind==="buyin"&&color&&bid){const b=p.buyins.find(x=>x.id===bid);if(b){b.counts[color]=Math.max(0,Number(t.value)||0);save();renderAuditAndSummary()}}if(kind==="cashout"&&color){p.cashout[color]=Math.max(0,Number(t.value)||0);save();renderAuditAndSummary();if(onlineSessionCode)setAdminOverride(p.name.trim())}},{passive:true});

  document.addEventListener("click",e=>{const t=e.target.closest(".sbtn");if(!t||state.locked)return;const step=Number(t.dataset.step)||0,kind=t.dataset.kind,pid=t.dataset.p,color=t.dataset.c,bid=t.dataset.b;if(kind==="tpack"&&color){state.tourneyPack[color]=Math.max(0,(state.tourneyPack[color]||0)+step);t.parentElement.querySelector("input").value=state.tourneyPack[color];save();renderTourneyChipPack();return}const p=state.players.find(x=>x.id===pid);if(!p)return;if(kind==="buyin"&&bid){const b=p.buyins.find(x=>x.id===bid);if(b){b.counts[color]=Math.max(0,(b.counts[color]||0)+step);t.parentElement.querySelector("input").value=b.counts[color];save();renderAuditAndSummary()}}if(kind==="cashout"){p.cashout[color]=Math.max(0,(p.cashout[color]||0)+step);t.parentElement.querySelector("input").value=p.cashout[color];save();renderAuditAndSummary();if(onlineSessionCode)setAdminOverride(p.name.trim())}},true);

  document.addEventListener("click",e=>{const t=e.target.closest("[data-act]");if(!t)return;const act=t.dataset.act,pid=t.dataset.p;if(act==="togglePlayer"){if(collapsedPlayers.has(pid))collapsedPlayers.delete(pid);else collapsedPlayers.add(pid);const el=document.getElementById("player_"+pid);if(el){el.classList.toggle("is-collapsed");el.querySelector(".pbd")?.classList.toggle("collapsed")}return}if(act==="delPlayer"){const p=state.players.find(x=>x.id===pid);if(p){state.players=state.players.filter(x=>x.id!==pid);if(!state.players.length)state.players=[makePlayer("Player 1")];renderAllFull();toast(`${p.name} removed`)}}    if(act==="addRebuy"){const p=state.players.find(x=>x.id===pid);if(p){if(p.buyins.length>=20){toast("Max 20 buy-ins per player");return}p.buyins.push({id:uid(),counts:mode==="tournament"?clone(state.tourneyPack):{black:0,purple:0,yellow:0,pink:0,orange:0}});renderAllFull();syncBuyinsToFirebase();toast("Rebuy added")}}if(act==="removeRebuy"){const p=state.players.find(x=>x.id===pid);if(p&&p.buyins.length>1){p.buyins.pop();renderAllFull();syncBuyinsToFirebase();toast("Rebuy removed")}}if(act==="delBuyin"){const p=state.players.find(x=>x.id===pid);if(p&&p.buyins.length>1){p.buyins=p.buyins.filter(x=>x.id!==t.dataset.b);renderAllFull();syncBuyinsToFirebase()}}},true);

  document.addEventListener("click",e=>{const t=e.target.closest("[data-jump]");if(t){const pid=t.dataset.jump,el=document.getElementById("player_"+pid);if(el){collapsedPlayers.delete(pid);el.classList.remove("is-collapsed");el.querySelector(".pbd")?.classList.remove("collapsed");el.scrollIntoView({behavior:"smooth"})}}},true);
  document.addEventListener("click",e=>{const t=e.target.closest("[data-delsession]");if(t){e.stopPropagation();e.preventDefault();const id=t.dataset.delsession;if(confirm("Delete this session from history?")){const h=loadHistory().filter(s=>s.id!==id);saveHistory(h);renderHistory();renderStats();toast("Session deleted")}}},true);
  document.addEventListener("click",e=>{const row=e.target.closest(".sessionRow");if(row&&!e.target.closest("[data-delsession]"))document.querySelectorAll(`.sessionDetail[data-detail="${row.dataset.sid}"]`).forEach(r=>r.classList.toggle("open"))});

  // Pull to refresh
  (function(){const ind=$("pullIndicator"),pt=ind.querySelector(".pullText"),pi=ind.querySelector(".pullIcon");let sy=0,pulling=false,ready=false;const TH=80,MX=120;document.addEventListener("touchstart",e=>{if(window.scrollY===0){sy=e.touches[0].clientY;pulling=false;ready=false}},{passive:true});document.addEventListener("touchmove",e=>{if(!sy)return;const dy=e.touches[0].clientY-sy;if(dy>10&&window.scrollY===0){pulling=true;const d=Math.min(dy*.5,MX);ind.style.height=d+"px";ind.classList.add("pulling");ind.classList.remove("refreshing");if(d>=TH*.5){ready=d>=TH*.8;ind.classList.toggle("ready",ready);pt.textContent=ready?"Release to refresh":"Pull to refresh";pi.textContent=ready?"‚Üë":"‚Üì"}}else if(dy<0){sy=0;pulling=false;ind.style.height="0";ind.classList.remove("pulling","ready")}},{passive:true});document.addEventListener("touchend",()=>{if(pulling&&ready){ind.classList.remove("pulling","ready");ind.classList.add("refreshing");ind.style.height="40px";pt.textContent="Refreshing‚Ä¶";pi.textContent="‚ü≥";setTimeout(()=>location.reload(),400)}else{ind.style.height="0";ind.classList.remove("pulling","ready")}sy=0;pulling=false;ready=false},{passive:true})})();

  // ‚îÄ‚îÄ PIN System ‚îÄ‚îÄ
  const PIN_KEY="poker_admin_pin";
  let pinMode="verify"; // "verify" | "set" | "confirm" | "change"
  let pinBuffer="";
  let pinNew="";

  function getPin(){return localStorage.getItem(PIN_KEY)||""}
  function setPin(p){if(p)localStorage.setItem(PIN_KEY,p);else localStorage.removeItem(PIN_KEY)}

  function showPinOverlay(md,msg){
    pinMode=md;pinBuffer="";pinNew="";
    $("pinOverlay").classList.remove("hidden");
    $("pinTitle").textContent=md==="verify"?"Enter admin PIN":md==="set"?"Create a 4-digit PIN":md==="confirm"?"Confirm your PIN":md==="remove"?"Enter PIN to remove it":"Enter current PIN";
    if(msg)$("pinMsg").textContent=msg;else $("pinMsg").textContent="";
    updatePinDots();
  }

  function hidePinOverlay(){$("pinOverlay").classList.add("hidden");pinBuffer="";pinNew=""}

  function updatePinDots(wrong){
    for(let i=0;i<4;i++){
      const d=$("pd"+i);
      d.className="pinDot"+(i<pinBuffer.length?" filled":"")+(wrong?" wrong":"");
    }
  }

  function handlePinDigit(d){
    if(d==="cancel"){
      // If verifying (PIN exists, must enter), don't allow cancel
      if(pinMode==="verify"){$("pinMsg").textContent="PIN required to access admin";return}
      // Otherwise cancel setup/change
      hidePinOverlay();toast("Cancelled");return;
    }
    if(d==="back"){pinBuffer=pinBuffer.slice(0,-1);updatePinDots();return}
    if(pinBuffer.length>=4)return;
    pinBuffer+=d;
    updatePinDots();

    if(pinBuffer.length===4){
      setTimeout(()=>{
        if(pinMode==="verify"){
          // Brute force protection
          if(Date.now()<pinLockUntil){const secs=Math.ceil((pinLockUntil-Date.now())/1000);updatePinDots(true);$("pinMsg").textContent=`Locked out. Wait ${secs}s`;setTimeout(()=>{pinBuffer="";updatePinDots()},500);return}
          if(pinBuffer===getPin()){pinAttempts=0;hidePinOverlay();toast("Welcome back üîì")}
          else{pinAttempts++;if(pinAttempts>=5){pinLockUntil=Date.now()+30000;updatePinDots(true);$("pinMsg").textContent="Too many attempts. Locked for 30 seconds.";setTimeout(()=>{pinBuffer="";updatePinDots()},500);// Countdown
            const iv=setInterval(()=>{const s=Math.ceil((pinLockUntil-Date.now())/1000);if(s<=0){$("pinMsg").textContent="Try again";clearInterval(iv)}else $("pinMsg").textContent=`Locked. Wait ${s}s`},1000)}
          else{updatePinDots(true);$("pinMsg").textContent=`Wrong PIN (${5-pinAttempts} attempts left)`;setTimeout(()=>{pinBuffer="";updatePinDots()},500)}}
        }
        else if(pinMode==="set"){
          pinNew=pinBuffer;pinBuffer="";pinMode="confirm";
          $("pinTitle").textContent="Confirm your PIN";$("pinMsg").textContent="";updatePinDots();
        }
        else if(pinMode==="confirm"){
          if(pinBuffer===pinNew){setPin(pinNew);hidePinOverlay();toast("PIN set ‚úì")}
          else{updatePinDots(true);$("pinMsg").textContent="PINs don't match. Start over.";setTimeout(()=>{pinMode="set";pinBuffer="";pinNew="";$("pinTitle").textContent="Create a 4-digit PIN";$("pinMsg").textContent="";updatePinDots()},600)}
        }
        else if(pinMode==="change"){
          if(pinBuffer===getPin()){pinBuffer="";pinMode="set";$("pinTitle").textContent="Create new PIN";$("pinMsg").textContent="";updatePinDots()}
          else{updatePinDots(true);$("pinMsg").textContent="Wrong current PIN.";setTimeout(()=>{pinBuffer="";updatePinDots()},500)}
        }
        else if(pinMode==="remove"){
          if(pinBuffer===getPin()){setPin("");hidePinOverlay();toast("PIN removed ‚úì")}
          else{updatePinDots(true);$("pinMsg").textContent="Wrong PIN.";setTimeout(()=>{pinBuffer="";updatePinDots()},500)}
        }
      },150);
    }
  }

  document.addEventListener("click",e=>{const k=e.target.closest("[data-pk]");if(k)handlePinDigit(k.dataset.pk)});

  $("pinSetBtn").addEventListener("click",()=>{
    const hasPin=!!getPin();
    if(!hasPin){
      showPinOverlay("set","Create a PIN to protect admin access");
    }else{
      const action=prompt("Type CHANGE to change PIN, or REMOVE to remove it:");
      if(!action)return;
      if(action.trim().toUpperCase()==="CHANGE"){showPinOverlay("change","Enter your current PIN first")}
      else if(action.trim().toUpperCase()==="REMOVE"){
        showPinOverlay("remove","Enter your current PIN to remove it");
      }
    }
  });

  // Focus/blur
  document.addEventListener("focus",e=>{const t=e.target;if(t&&t.tagName==="INPUT"&&t.type!=="checkbox")t.select()},true);
  document.addEventListener("blur",e=>{const t=e.target;if(t&&t.type==="number"&&(t.value===""||t.value===null))t.value="0"},true);

  // Init
  state=sanitize(state);const lastCode=localStorage.getItem(ACTIVE_KEY);if(lastCode)$("resumeCode").value=lastCode;
  setMode("cash");renderAllFull();

  // Check PIN on load
  if(getPin()){showPinOverlay("verify")}
})();
</script>
</body>
</html>
