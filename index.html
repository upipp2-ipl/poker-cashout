<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Poker Cashout – Admin (Option 1)</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e8eefc; --muted:#a9b7d6; --line:rgba(255,255,255,.10);
      --good:#2bd576; --warn:#ffcc00; --bad:#ff5c7a; --accent:#7aa7ff;
      --b:#1f2937; --p:#6d28d9; --y:#f59e0b; --pk:#ec4899; --o:#f97316;
      --r:16px; --sh:0 10px 30px rgba(0,0,0,.40);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 850px at 20% 0%, rgba(122,167,255,.20), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(182,140,255,.14), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1050px;margin:0 auto;padding:18px 14px 28px}
    .top{
      position:sticky;top:0;z-index:10;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:12px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--sh); backdrop-filter: blur(8px);
    }
    h1{margin:0;font-size:16px}
    .sub{color:var(--muted);font-size:12px;margin-top:3px;line-height:1.35}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);color:var(--muted);font-size:12px;white-space:nowrap}
    .dot{width:8px;height:8px;border-radius:50%}
    .pill.good .dot{background:var(--good)} .pill.warn .dot{background:var(--warn)} .pill.bad .dot{background:var(--bad)}
    .pill.secondary{background:rgba(0,0,0,.18); color:rgba(232,238,252,.75)}
    .lockedOverlay{
      position:fixed; inset:auto 0 0 0; z-index:99;
      display:none;
      margin:10px 12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color:rgba(232,238,252,.92);
      box-shadow: var(--sh);
      max-width:1050px;
    }
    @media (min-width:1050px){ .lockedOverlay{left:50%; transform:translateX(-50%); width:1050px;} }
    .lockedOverlay .muted{color:var(--muted)}
    button[disabled], input[disabled], select[disabled]{
      opacity:.55;
      filter:saturate(.8);
      cursor:not-allowed !important;
    }

    .grid{display:grid;gap:14px;margin-top:14px}
    @media (min-width:900px){ .grid{grid-template-columns: 1.05fr .95fr;} }

    .card{
      border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--sh); overflow:hidden;
    }
    .hd{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:12px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(122,167,255,.12), rgba(0,0,0,0));
    }
    .hd h2{margin:0;font-size:14px}
    .bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input,select,button{font:inherit}
    input,select{
      width:100%; padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18); color:var(--text); outline:none;
    }
    input:focus,select:focus{border-color:rgba(122,167,255,.55);box-shadow:0 0 0 3px rgba(122,167,255,.12)}
    input[type="number"]{appearance:textfield}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(122,167,255,.18);color:var(--text);
      cursor:pointer; user-select:none; touch-action:manipulation;
    }
    .btn.secondary{background:rgba(0,0,0,.18)}
    .btn.danger{background:rgba(255,92,122,.18)}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .note{color:var(--muted);font-size:12px;line-height:1.35;margin-top:6px}
    .muted{color:var(--muted)}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .hl{outline:2px solid rgba(255,92,122,.65); box-shadow:0 0 0 3px rgba(255,92,122,.12); border-color: rgba(255,92,122,.55) !important;}
    .auditHint{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.14);color:var(--muted);font-size:12px;line-height:1.35}
    .auditHint b{color:rgba(232,238,252,.92)}
    .auditHint .chip{display:inline-flex;align-items:center;gap:6px;margin-right:10px;margin-top:6px}
    .auditHint .sw{width:10px;height:10px;border-radius:3px;display:inline-block}
    .hl-black{outline:2px solid rgba(90,160,255,.85); box-shadow:0 0 0 3px rgba(90,160,255,.20);}
    .hl-purple{outline:2px solid rgba(167,139,250,.85); box-shadow:0 0 0 3px rgba(167,139,250,.20);}
    .hl-yellow{outline:2px solid rgba(250,204,21,.85); box-shadow:0 0 0 3px rgba(250,204,21,.20);}
    .hl-pink{outline:2px solid rgba(244,114,182,.85); box-shadow:0 0 0 3px rgba(244,114,182,.20);}
    .hl-orange{outline:2px solid rgba(251,146,60,.85); box-shadow:0 0 0 3px rgba(251,146,60,.20);}



    .players{display:flex;flex-direction:column;gap:12px}
    .player{
      border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
    }
    .phd{
      padding:12px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(160,120,255,.10), rgba(0,0,0,0));
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .pname{flex:1;min-width:0}
    .pactions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pbd{padding:14px}
    .chips{
      display:grid;gap:14px;grid-template-columns: repeat(5, minmax(0,1fr));
    }
    @media (max-width:560px){ .chips{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width:360px){ .chips{grid-template-columns: 1fr;} }
    .cell{border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;background:rgba(0,0,0,.14)}
    .ctop{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .sw{width:10px;height:10px;border-radius:3px}
    .sw.b{background:var(--b)} .sw.p{background:var(--p)} .sw.y{background:var(--y)} .sw.pk{background:var(--pk)} .sw.o{background:var(--o)}
    .cname{color:var(--muted);font-size:12px}
    .cval{margin-left:auto;color:var(--muted);font-size:12px}

    .miniCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      overflow:hidden;
      margin-top:12px;
    }
    .miniHd{
      padding:10px 10px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.10);
    }
    .miniHd b{font-size:13px}
    .miniBd{padding:10px}

    .outblock{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      padding:12px;
      margin-top:12px;
    }
    .outblock pre{
      margin:0;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      line-height:1.35;
      color:rgba(232,238,252,.92);
    }

    .tablewrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:13px}
    th{position:sticky;top:0;z-index:1;background:rgba(0,0,0,.18);color:var(--muted);text-align:left}
    .num{text-align:right}

    .footer{
      position:sticky;bottom:0;z-index:9;margin-top:12px;
      padding-bottom: env(safe-area-inset-bottom);
      border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.35));
      box-shadow:var(--sh); backdrop-filter: blur(10px);
    }
    .footer .inner{padding:10px 12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .tot{border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);padding:7px 9px;border-radius:12px;min-width:140px;flex:1 1 140px}
    .tot .k{font-size:11px;color:var(--muted)} .tot .v{font-size:14px;font-weight:800}
    .totwrap{display:flex;gap:8px;flex-wrap:wrap;align-items:stretch;flex:1;min-width:260px}
    .totwrap .tot{max-width:220px}
    @media (max-width:420px){ .totwrap{min-width:0} .totwrap .tot{max-width:none} }

  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Poker Cashout (Admin) – Option 1</h1>
      <div class="sub">
        $1 = 1000 value units • Buy-in $50 • RF tax 30% of (Winnings above total buy-ins)
      </div>
    </div>
    <div id="lockBadge" class="pill secondary" style="display:none;margin-right:8px" title="Session is locked (read-only)"><span class="dot" style="background:var(--accent)"></span><span>LOCKED</span></div>
    <div id="pill" class="pill warn">
      <span class="dot"></span><span id="pillText">Audit: pending</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd">
        <h2>Session & Rules</h2>
        <div class="btnbar">
          <button class="btn small danger" id="resetAll" type="button">Reset app data</button>
          <button class="btn small" id="lockSession" type="button">Lock session</button>
          <button class="btn small secondary" id="toggleRules" type="button">Collapse</button>
        </div>
      </div>
      <div class="bd" id="rulesBody">
        <div class="row">
          <div>
            <label>Session name (optional)</label>
            <input id="sessionName" type="text" placeholder="Friday poker – Feb 7" />
          </div>
          <div>
            <label>Buy-in ($)</label>
            <input id="buyinUsd" type="number" step="0.01" inputmode="decimal" />
          </div>
          <div>
            <label>RF tax rate (0.30 = 30%)</label>
            <input id="taxRate" type="number" step="0.01" inputmode="decimal" />
          </div>
        
        <div class="row" style="margin-top:10px">
          <div>
            <label>Bank / Admin (receives buy-ins, pays out finals)</label>
            <select id="bankSelect"></select>
            <div class="note">Tip: Choose the person everyone pays on Venmo/Zelle. When you lock the session, you’ll get a payout list.</div>
          </div>
        </div>

        <div class="sep"></div>

        <label>Chip values (value units per chip)</label>
        <div class="row">
          <div><label>Black</label><input id="v_black" type="number" step="1" inputmode="numeric"/></div>
          <div><label>Purple</label><input id="v_purple" type="number" step="1" inputmode="numeric"/></div>
          <div><label>Yellow</label><input id="v_yellow" type="number" step="1" inputmode="numeric"/></div>
          <div><label>Pink</label><input id="v_pink" type="number" step="1" inputmode="numeric"/></div>
          <div><label>Orange</label><input id="v_orange" type="number" step="1" inputmode="numeric"/></div>
        </div>

        <div class="sep"></div>

        <div class="btnbar">
          <button class="btn secondary" id="saveRoster" type="button">Save roster</button>
          <button class="btn secondary" id="loadRoster" type="button">Load roster</button>
          <button class="btn secondary" id="copyAll" type="button">Copy all outputs</button>
        </div>
        <div class="note">Keyboard fix: typing in chip counts will not collapse the keypad. Rebuys start at 0 so you only fill the colors you actually give out.</div>
        <div id="auditHint" class="auditHint" style="display:none"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h2>Players (<span id="playerCount">0</span>)</h2>
        <div class="btnbar">
          <button class="btn" id="addPlayer" type="button">+ Add player</button>
        </div>
      </div>
      <div class="bd">
        <div id="players" class="players"></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd"><h2>Audit: IN vs OUT by color</h2><span class="muted">Table-level check</span></div>
      <div class="bd">
        <div class="tablewrap">
          <table>
            <thead>
              <tr><th>Color</th><th class="num">IN</th><th class="num">OUT</th><th class="num">OUT − IN</th></tr>
            </thead>
            <tbody id="auditBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2>Weekly summary</h2><span class="muted">Totals</span></div>
      <div class="bd">
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>Player</th>
                <th class="num">Buy-ins</th>
                <th class="num">Gross</th>
                <th class="num">RF tax</th>
                <th class="num">Final</th>
                <th class="num">Net</th>
              </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <div class="card" id="payoutCard" style="margin-top:12px; display:none">
    <div class="hd">
      <h2>Final payouts (Venmo / Zelle list)</h2>
      <div class="btnbar">
        <button class="btn small secondary" id="copyPayouts" type="button">Copy payout list</button>
      </div>
    </div>
    <div class="bd">
      <div class="note">This section appears when the session is locked. “Suggested payouts” is the fastest way for the Bank to settle.</div>
      <div class="outblock">
        <pre id="payoutSuggested"></pre>
      <div class="sep"></div>
      <pre id="payoutText"></pre>
      </div>
      <div class="note">Rule: everyone pays the Bank their buy-ins. Bank pays players their final payout (after RF tax). RF tax is 30% of winnings above total buy-ins (buy-in + rebuys).</div>
    </div>
  </div>

  <div class="footer">
    <div class="inner">
      <div class="totwrap">
        <div class="tot"><div class="k">Total Gross</div><div class="v" id="t_gross">$0.00</div></div>
        <div class="tot"><div class="k">Total RF fund</div><div class="v" id="t_rf">$0.00</div></div>
        <div class="tot"><div class="k">Total Final</div><div class="v" id="t_final">$0.00</div></div>
      </div>
      <button class="btn secondary" id="toTop" type="button">↑ Top</button>
    </div>
  </div>
</div>

<div id="lockedOverlay" class="lockedOverlay"><b>Session locked.</b> <span class="muted">Unlock to edit buy-ins / cashouts.</span></div>

<script>
(() => {
  const KEY = "poker_admin_option1_v12_suggested_payouts";
  const ROSTER_KEY = "poker_admin_roster_v1";

  const COLORS = ["black","purple","yellow","pink","orange"];
  const SW = {black:"b", purple:"p", yellow:"y", pink:"pk", orange:"o"};

  const DEFAULTS = {
    sessionName: "",
    buyinUsd: 50,
    taxRate: 0.30,
    chipValues: {black:100, purple:500, yellow:1000, pink:5000, orange:10000},
    defaultPack: {black:15, purple:3, yellow:12, pink:3, orange:2},
    locked: false,
  };

  const $ = (id)=>document.getElementById(id);
  const clamp = (v)=>Number.isFinite(v)?v:0;
  const clone = (o)=>JSON.parse(JSON.stringify(o));
  const uid = ()=>Math.random().toString(16).slice(2)+"-"+Date.now().toString(16);
  const fmtUsd = (x)=>clamp(x).toLocaleString(undefined,{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2});
  const esc = (s)=>(s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const unitsToUsd = (units)=> clamp(units)/1000;
  const unitsFromCounts = (counts, values)=> COLORS.reduce((sum,c)=> sum + clamp(counts[c])*clamp(values[c]), 0);
  const totalChipCount = (counts)=> COLORS.reduce((sum,c)=> sum + clamp(counts[c]), 0);

  function makePlayer(name){
    return { id: uid(), name: name || "Player", buyins: [{ id: uid(), counts: clone(DEFAULTS.defaultPack) }],
      cashout: {black:0,purple:0,yellow:0,pink:0,orange:0} };
  }

  function defaultState(){
    return { sessionName: DEFAULTS.sessionName, buyinUsd: DEFAULTS.buyinUsd, taxRate: DEFAULTS.taxRate,
      chipValues: clone(DEFAULTS.chipValues), locked: false, bankId: null, players: [ makePlayer("Player 1"), makePlayer("Player 2") ] };
  }

  function sanitize(s){
    if(!s || typeof s!=="object") return defaultState();
    s.sessionName = typeof s.sessionName==="string" ? s.sessionName : "";
    s.buyinUsd = Number(s.buyinUsd); if(!Number.isFinite(s.buyinUsd)||s.buyinUsd<=0) s.buyinUsd=DEFAULTS.buyinUsd;
    s.taxRate = Number(s.taxRate); if(!Number.isFinite(s.taxRate)||s.taxRate<0) s.taxRate=DEFAULTS.taxRate;
    s.locked = !!s.locked;
    s.bankId = (typeof s.bankId==="string") ? s.bankId : null;
    if(!s.chipValues) s.chipValues = {};
    for(const c of COLORS){
      const v = Number(s.chipValues[c]);
      s.chipValues[c] = Number.isFinite(v)&&v>0 ? v : DEFAULTS.chipValues[c];
    }
    if(!Array.isArray(s.players) || s.players.length===0) s.players=[makePlayer("Player 1")];
    for(const p of s.players){
      if(!p.id) p.id=uid();
      if(typeof p.name!=="string") p.name="Player";
      if(!Array.isArray(p.buyins) || p.buyins.length===0) p.buyins=[{id:uid(),counts:clone(DEFAULTS.defaultPack)}];
      for(const b of p.buyins){
        if(!b.id) b.id=uid();
        if(!b.counts) b.counts=clone(DEFAULTS.defaultPack);
        for(const c of COLORS){
          const n = Number(b.counts[c]);
          b.counts[c] = Number.isFinite(n)&&n>=0 ? n : 0;
        }
      }
      if(!p.cashout) p.cashout={black:0,purple:0,yellow:0,pink:0,orange:0};
      for(const c of COLORS){
        const n = Number(p.cashout[c]);
        p.cashout[c] = Number.isFinite(n)&&n>=0 ? n : 0;
      }
    }

    // ensure bankId is valid
    const ids = s.players.map(p=>p.id);
    if(!s.bankId || !ids.includes(s.bankId)) s.bankId = ids[0] || null;
    return s;
  }

  let state = (() => {
    try{ const raw = localStorage.getItem(KEY); return sanitize(raw ? JSON.parse(raw) : null); }
    catch{ return defaultState(); }
  })();

  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch{} }

  function calcPlayer(p){
    const buyinsCount = p.buyins.length;
    const outUnits = unitsFromCounts(p.cashout, state.chipValues);
    const gross = unitsToUsd(outUnits);
    const buyinUsdTotal = buyinsCount * state.buyinUsd;
    const taxBase = Math.max(0, gross - buyinUsdTotal);
    const rfTax = taxBase * state.taxRate;
    const finalPayout = gross - rfTax;
    const netProfit = finalPayout - buyinUsdTotal;
    const outChips = totalChipCount(p.cashout);
    return {buyinsCount,buyinUsdTotal,outUnits,outChips,gross,rfTax,finalPayout,netProfit};
  }

  function calcAudit(){
    const IN = {black:0,purple:0,yellow:0,pink:0,orange:0};
    const OUT = {black:0,purple:0,yellow:0,pink:0,orange:0};
    for(const p of state.players){
      for(const b of p.buyins){
        for(const c of COLORS) IN[c] += clamp(b.counts[c]);
      }
      for(const c of COLORS) OUT[c] += clamp(p.cashout[c]);
    }
    return {IN,OUT};
  }

  function outputBlockText(p){
    const c = calcPlayer(p);
    const sign = c.netProfit >= 0 ? "+" : "";
    return [
      `Total Chips and Value Count = ${c.outChips} / ${Math.round(c.outUnits).toLocaleString()}`,
      `Gross value: ${fmtUsd(c.gross)}`,
      `RF Fund tax: ${fmtUsd(c.rfTax)}`,
      `Final payout: ${fmtUsd(c.finalPayout)}`,
      `Net profit after buy-ins & tax: ${sign}${fmtUsd(c.netProfit)}`
    ].join("\n");
  }

  
function renderStatic(){
    const countEl = document.getElementById("playerCount");
    if(countEl) countEl.textContent = state.players.length;

    $("sessionName").value = state.sessionName;
    $("buyinUsd").value = state.buyinUsd;
    $("taxRate").value = state.taxRate;
    for(const c of COLORS) $("v_"+c).value = state.chipValues[c];

    const lockBtn = document.getElementById("lockSession");
    const badge = document.getElementById("lockBadge");
    const overlay = document.getElementById("lockedOverlay");
    if(lockBtn){
      lockBtn.textContent = state.locked ? "Unlock" : "Lock session";
      lockBtn.classList.toggle("danger", state.locked); // red-ish when locked
    }
    if(badge) badge.style.display = state.locked ? "inline-flex" : "none";
    if(overlay) overlay.style.display = state.locked ? "block" : "none";

    // Disable top-level rule inputs when locked (still visible)
    ["sessionName","buyinUsd","taxRate","v_black","v_purple","v_yellow","v_pink","v_orange"].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.disabled = !!state.locked;
    });

    
    // Bank selector
    const bankSel = document.getElementById("bankSelect");
    if(bankSel){
      bankSel.innerHTML = state.players.map(p=>`<option value="${p.id}">${esc(p.name||"Player")}</option>`).join("");
      bankSel.value = state.bankId || (state.players[0]?.id||"");
      bankSel.disabled = !!state.locked;
    }

    // Disable structural buttons when locked (copy/load/save roster still ok; reset blocked)
    const addBtn = document.getElementById("addPlayer");
    if(addBtn) addBtn.disabled = !!state.locked;
    const resetBtn = document.getElementById("resetAll");
    if(resetBtn) resetBtn.disabled = !!state.locked;
  }

  function colorCell(color, valueUnits, count, kind, pid, bid){
    return `
      <div class="cell" data-color="${color}">
        <div class="ctop">
          <span class="sw ${SW[color]}"></span>
          <span class="cname">${color[0].toUpperCase()+color.slice(1)}</span>
          <span class="cval">${valueUnits.toLocaleString()}</span>
        </div>
        <input type="number" step="1" inputmode="numeric"
          data-kind="${kind}" data-p="${pid}" data-b="${bid||""}" data-c="${color}"
          value="${(count ?? 0)}" placeholder="count" ${state.locked?"disabled":""}/>
      </div>
    `;
  }

  function renderPlayersFull(){
    const wrap = $("players");
    wrap.innerHTML = state.players.map(p=>{
      const buyinsHtml = p.buyins.map((b, idx)=>{
        const title = idx===0 ? "Buy-in 1" : `Rebuy ${idx}`;
        const dispUnits = unitsFromCounts(b.counts, state.chipValues);
        const dispUsd = unitsToUsd(dispUnits);
        return `
          <div class="miniCard">
            <div class="miniHd">
              <b>${title} (dispensed)</b>
              <div class="btnbar">
                <button class="btn small danger" data-act="delBuyin" data-p="${p.id}" data-b="${b.id}" ${(state.locked || p.buyins.length===1)?"disabled":""}>Remove</button>
              </div>
            </div>
            <div class="miniBd">
              <div class="chips">
                ${colorCell("black", state.chipValues.black, b.counts.black, "buyin", p.id, b.id)}
                ${colorCell("purple", state.chipValues.purple, b.counts.purple, "buyin", p.id, b.id)}
                ${colorCell("yellow", state.chipValues.yellow, b.counts.yellow, "buyin", p.id, b.id)}
                ${colorCell("pink", state.chipValues.pink, b.counts.pink, "buyin", p.id, b.id)}
                ${colorCell("orange", state.chipValues.orange, b.counts.orange, "buyin", p.id, b.id)}
              </div>
              <div class="note" id="disp_${p.id}_${b.id}">Dispensed value: <b>${dispUnits.toLocaleString()}</b> units (~ <b>${fmtUsd(dispUsd)}</b>)</div>
            </div>
          </div>
        `;
      }).join("");

      const outUnits = unitsFromCounts(p.cashout, state.chipValues);
      const outUsd = unitsToUsd(outUnits);

      return `
        <div class="player" data-p="${p.id}">
          <div class="phd">
            <div class="pname">
              <label style="margin:0;color:rgba(232,238,252,.85)">Player name</label>
              <input type="text" value="${esc(p.name)}" data-kind="name" data-p="${p.id}" autocomplete="off" autocapitalize="words" ${state.locked?"disabled":""}/>
            </div>
            <div class="pactions">
              <button class="btn small secondary" data-act="addRebuy" data-p="${p.id}" ${state.locked?"disabled":""}>+ Rebuy</button>
              <button class="btn small danger" data-act="delPlayer" data-p="${p.id}" ${state.locked?"disabled":""}>Remove</button>
            </div>
          </div>
          <div class="pbd">
            <div class="outblock">
              <label>Buy-ins & Rebuys (dispensed)</label>
              <div class="note">Buy-in 1 defaults to 15/3/12/3/2. Rebuys start at 0 so you only fill the colors you actually give out.</div>
            </div>

            ${buyinsHtml}

            <div class="outblock">
              <label>Cashout (chips OUT by color)</label>
              <div class="chips">
                ${colorCell("black", state.chipValues.black, p.cashout.black, "cashout", p.id)}
                ${colorCell("purple", state.chipValues.purple, p.cashout.purple, "cashout", p.id)}
                ${colorCell("yellow", state.chipValues.yellow, p.cashout.yellow, "cashout", p.id)}
                ${colorCell("pink", state.chipValues.pink, p.cashout.pink, "cashout", p.id)}
                ${colorCell("orange", state.chipValues.orange, p.cashout.orange, "cashout", p.id)}
              </div>
              <div class="note" id="cashnote_${p.id}">Cashout value: <b>${outUnits.toLocaleString()}</b> units (~ <b>${fmtUsd(outUsd)}</b>)</div>
            </div>

            <div class="outblock">
              <label>Summary</label>
              <pre id="out_${p.id}">${esc(outputBlockText(p))}</pre>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  
  function applyMismatchHighlights(mismatchedColors){
    // clear
    document.querySelectorAll('.cell').forEach(el=>el.className = el.className.replace(/\bhl-[a-z]+\b/g, ''));
    if(!mismatchedColors || mismatchedColors.length===0) return;
    for(const c of mismatchedColors){
      document.querySelectorAll('.cell[data-color="'+c+'"]').forEach(el=>el.classList.add('hl-'+c));
    }
  }

  function setAuditHint(mismatches){
    const box = document.getElementById('auditHint');
    if(!box) return;
    if(!mismatches || mismatches.length===0){
      box.style.display='none';
      box.innerHTML='';
      return;
    }
    box.style.display='block';
    const parts = mismatches.map(m=>{
      const sign = m.diff>0 ? '+' : '';
      const cls = m.color==='black'?'b':(m.color==='purple'?'p':(m.color==='yellow'?'y':(m.color==='pink'?'pk':'o')));
      return `<span class="chip"><span class="sw ${cls}"></span><b>${m.color[0].toUpperCase()+m.color.slice(1)}</b>: OUT − IN = <b>${sign}${m.diff}</b></span>`;
    }).join('');
    box.innerHTML = `Fix these color mismatches (tap into those chip boxes — they’re highlighted above):<br/>${parts}`;
  }

function renderAuditAndSummary(){
    const {IN, OUT} = calcAudit();
    $("auditBody").innerHTML = COLORS.map(c=>{
      const diff = OUT[c]-IN[c];
      const cls = diff===0 ? "good" : (Math.abs(diff)<=1 ? "warn" : "bad");
      return `
        <tr>
          <td>${c[0].toUpperCase()+c.slice(1)}</td>
          <td class="num">${IN[c].toLocaleString()}</td>
          <td class="num">${OUT[c].toLocaleString()}</td>
          <td class="num ${cls}">${diff.toLocaleString()}</td>
        </tr>
      `;
    }).join("");

    let tg=0,trf=0,tf=0;
    $("summaryBody").innerHTML = state.players.map(p=>{
      const c = calcPlayer(p);
      tg += c.gross; trf += c.rfTax; tf += c.finalPayout;
      const cls = c.netProfit>0.0001 ? "good" : (c.netProfit<-0.0001 ? "bad" : "muted");
      return `
        <tr>
          <td>${esc(p.name)}</td>
          <td class="num">${c.buyinsCount}</td>
          <td class="num">${fmtUsd(c.gross)}</td>
          <td class="num">${fmtUsd(c.rfTax)}</td>
          <td class="num">${fmtUsd(c.finalPayout)}</td>
          <td class="num ${cls}">${fmtUsd(c.netProfit)}</td>
        </tr>
      `;
    }).join("");

    $("t_gross").textContent = fmtUsd(tg);
    $("t_rf").textContent = fmtUsd(trf);
    $("t_final").textContent = fmtUsd(tf);

    
    const mismatches = COLORS
      .map(c => ({color:c, diff: (OUT[c]-IN[c])}))
      .filter(x => x.diff !== 0);
    const anyMismatch = mismatches.length > 0;

    const haveAnyData = (COLORS.some(c => IN[c]!==0) || COLORS.some(c => OUT[c]!==0));
    
    applyMismatchHighlights(mismatches.map(m=>m.color));
    setAuditHint(mismatches);
    const pill = $("pill"), pillText=$("pillText");

    if(!haveAnyData){
      pill.className="pill warn";
      pillText.textContent="Audit: pending";
    }else if(anyMismatch){
      pill.className="pill bad";
      
      const short = mismatches.slice(0,2).map(m=>{
        const sign = m.diff>0 ? '+' : '';
        return `${m.color[0].toUpperCase()+m.color.slice(1)} ${sign}${m.diff}`;
      }).join(", ");
      pillText.textContent = short ? `Audit: MISMATCH (${short}${mismatches.length>2?"…":""})` : "Audit: MISMATCH";

    }else{
      pill.className="pill good";
      pillText.textContent="Audit: OK";
    }
  }

  function updatePlayerComputed(pid){
    const p = state.players.find(x=>x.id===pid);
    if(!p) return;
    const outUnits = unitsFromCounts(p.cashout, state.chipValues);
    const outUsd = unitsToUsd(outUnits);
    const cashNote = $("cashnote_"+pid);
    if(cashNote){
      cashNote.innerHTML = `Cashout value: <b>${outUnits.toLocaleString()}</b> units (~ <b>${fmtUsd(outUsd)}</b>)`;
    }
    const outPre = $("out_"+pid);
    if(outPre){
      outPre.textContent = outputBlockText(p);
    }
  }

  function updateBuyinComputed(pid, bid){
    const p = state.players.find(x=>x.id===pid);
    if(!p) return;
    const b = p.buyins.find(x=>x.id===bid);
    if(!b) return;
    const dispUnits = unitsFromCounts(b.counts, state.chipValues);
    const dispUsd = unitsToUsd(dispUnits);
    const dispEl = $("disp_"+pid+"_"+bid);
    if(dispEl){
      dispEl.innerHTML = `Dispensed value: <b>${dispUnits.toLocaleString()}</b> units (~ <b>${fmtUsd(dispUsd)}</b>)`;
    }
  }

  
  function buildSuggestedPayoutText(){
    const bankId = state.bankId || state.players[0]?.id;
    const bank = state.players.find(p=>p.id===bankId);
    const bankName = bank?.name || "Bank";

    const collect = [];
    const pay = [];
    let totalRF = 0;

    for(const p of state.players){
      const c = calcPlayer(p);
      totalRF += c.rfTax;
      if(p.id !== bankId){
        const buyins = p.buyins.length;
        const buyAmt = buyins * state.buyinUsd;
        collect.push({name:p.name, amt: buyAmt, buyins});
        pay.push({name:p.name, amt: c.finalPayout});
      }
    }

    const bankIn = collect.reduce((s,x)=> s + x.amt, 0);
    const bankOut = pay.reduce((s,x)=> s + x.amt, 0);

    const lines = [];
    lines.push(`Suggested payouts (fast settle)`);
    lines.push(`Bank: ${bankName}`);
    lines.push("");
    lines.push("Collect (buy-ins):");
    collect.forEach(x=>{
      lines.push(`- ${x.name} → ${bankName}: ${fmtUsd(x.amt)} (${x.buyins} × ${fmtUsd(state.buyinUsd)})`);
    });
    lines.push(`= Total collect: ${fmtUsd(bankIn)}`);
    lines.push("");
    lines.push("Pay (final payouts after RF tax):");
    pay.forEach(x=>{
      lines.push(`- ${bankName} → ${x.name}: ${fmtUsd(x.amt)}`);
    });
    lines.push(`= Total pay: ${fmtUsd(bankOut)}`);
    lines.push("");
    lines.push(`RF fund to set aside: ${fmtUsd(totalRF)}`);
    lines.push(`Bank check: collect ${fmtUsd(bankIn)} − pay ${fmtUsd(bankOut)} = ${fmtUsd(bankIn-bankOut)} (should ≈ RF fund + any table float)`);
    return lines.join("\n");
  }

  function buildPayoutText(){
    const bankId = state.bankId || state.players[0]?.id;
    const bank = state.players.find(p=>p.id===bankId);
    const bankName = bank?.name || "Bank";
    const lines = [];
    const session = (state.sessionName||"").trim();
    if(session) lines.push(session);
    lines.push(`Bank: ${bankName}`);
    lines.push("");
    // 1) Everyone pays buy-ins to bank
    lines.push("Everyone pays buy-ins to the Bank:");
    let bankIn = 0;
    for(const p of state.players){
      const buyins = p.buyins.length;
      const amt = buyins * state.buyinUsd;
      bankIn += amt;
      if(p.id===bankId){
        lines.push(`- ${p.name}: (Bank) no transfer for buy-in (${buyins} × ${fmtUsd(state.buyinUsd)})`);
      }else{
        lines.push(`- ${p.name} → ${bankName}: ${fmtUsd(amt)}  (${buyins} × ${fmtUsd(state.buyinUsd)})`);
      }
    }
    lines.push("");
    // 2) Bank pays final payouts (after RF tax)
    lines.push("Bank pays final payouts (after RF tax):");
    let bankOut = 0;
    for(const p of state.players){
      const c = calcPlayer(p);
      const pay = c.finalPayout;
      bankOut += pay;
      if(p.id===bankId){
        lines.push(`- ${bankName}: (Bank) final payout ${fmtUsd(pay)} (keeps cash box)`);
      }else{
        lines.push(`- ${bankName} → ${p.name}: ${fmtUsd(pay)}`);
      }
    }
    lines.push("");
    // RF fund total
    const totalRF = state.players.reduce((s,p)=> s + calcPlayer(p).rfTax, 0);
    lines.push(`RF fund total (set aside): ${fmtUsd(totalRF)}`);
    lines.push("");
    // Bank reconciliation (optional)
    const net = bankIn - bankOut; // what remains with bank before RF? actually RF is already removed from payouts, so net should equal RF fund + (table float if cashouts missing)
    lines.push(`Bank check: Total in ${fmtUsd(bankIn)} − total out ${fmtUsd(bankOut)} = ${fmtUsd(net)} (should approximately equal RF fund + any table float).`);
    return lines.join("\n");
  }

function renderAllFull(){
    renderStatic();
    renderPlayersFull();
    renderAuditAndSummary();
    // Payout card (only when locked)
    const card = document.getElementById("payoutCard");
    if(card) card.style.display = state.locked ? "block" : "none";
    const preS = document.getElementById("payoutSuggested");
    if(preS) preS.textContent = state.locked ? buildSuggestedPayoutText() : "";
    const pre = document.getElementById("payoutText");
    if(pre) pre.textContent = state.locked ? buildPayoutText() : "";
    save();
  }

  function tap(el, fn){
    const h = (e)=>{ e.preventDefault?.(); fn(e); };
    // Avoid double-fire on mobile (touchend + click + pointerup). Use Pointer Events when available.
    if(window.PointerEvent){
      el.addEventListener("pointerup", h, {passive:false});
    }else{
      el.addEventListener("click", h, {passive:false});
    }
  }

  $("sessionName").addEventListener("input", (e)=>{ if(state.locked) return; state.sessionName = e.target.value; save(); });
  $("buyinUsd").addEventListener("input", (e)=>{ if(state.locked) return; state.buyinUsd = Number(e.target.value)||DEFAULTS.buyinUsd; renderAuditAndSummary(); save(); updateAllPlayerOutputs(); });
  $("taxRate").addEventListener("input", (e)=>{ if(state.locked) return; state.taxRate = Number(e.target.value)||0; renderAuditAndSummary(); save(); updateAllPlayerOutputs(); });

  $("bankSelect").addEventListener("change", (e)=>{ if(state.locked) return; state.bankId = e.target.value; save(); renderAllFull(); });

  function updateAllPlayerOutputs(){ for(const p of state.players) updatePlayerComputed(p.id); }

  for(const c of COLORS){
    $("v_"+c).addEventListener("input", (e)=>{
      if(state.locked) return;
      state.chipValues[c] = Number(e.target.value)||DEFAULTS.chipValues[c];
      renderAllFull();
    });
  }

  tap($("addPlayer"), ()=>{ if(state.locked) return; state.players.unshift(makePlayer(`Player ${state.players.length+1}`)); renderAllFull(); window.scrollTo({ top: 0, behavior: "smooth" }); });
  tap($("resetAll"), ()=>{ if(state.locked) return; if(!confirm("Reset all app data?")) return; localStorage.removeItem(KEY); state = defaultState(); renderAllFull(); });

  tap($("lockSession"), ()=>{
    state.locked = !state.locked;
    save();
    renderAllFull();
  });

  let collapsed=false;
  tap($("toggleRules"), ()=>{
    collapsed=!collapsed;
    $("rulesBody").style.display = collapsed ? "none" : "block";
    $("toggleRules").textContent = collapsed ? "Expand" : "Collapse";
  });

  tap($("toTop"), ()=> window.scrollTo({top:0,behavior:"smooth"}));

  tap($("saveRoster"), ()=>{
    const names = state.players.map(p=>p.name.trim()).filter(Boolean);
    localStorage.setItem(ROSTER_KEY, JSON.stringify(names));
  });

  tap($("loadRoster"), ()=>{
    let names=[];
    try{ names=JSON.parse(localStorage.getItem(ROSTER_KEY)||"[]"); }catch{}
    if(!Array.isArray(names) || names.length===0) return;
    state.players = names.map(n=>makePlayer(n));
    renderAllFull();
  });

  tap($("copyAll"), ()=>{
    const lines = [];
    if(state.sessionName.trim()) lines.push(state.sessionName.trim());
    for(const p of state.players){
      lines.push(`${p.name}`);
      lines.push(outputBlockText(p));
      lines.push("");
    }
    const txt = lines.join("\n");
    navigator.clipboard?.writeText(txt).catch(()=>prompt("Copy:", txt));
  });

  // Keyboard-safe input: no full re-render while typing
  document.addEventListener("input", (e)=>{
    if(state.locked) return;
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;

    const kind = t.getAttribute("data-kind");
    const pid = t.getAttribute("data-p");
    if(!kind || !pid) return;

    const p = state.players.find(x=>x.id===pid);
    if(!p) return;

    if(kind==="name"){
      p.name = t.value;
      renderAuditAndSummary();
      save();
      return;
    }

    const color = t.getAttribute("data-c");
    const bid = t.getAttribute("data-b");

    if(kind==="buyin" && color && bid){
      const b = p.buyins.find(x=>x.id===bid);
      if(!b) return;
      b.counts[color] = Number(t.value)||0;
      updateBuyinComputed(pid, bid);
      updatePlayerComputed(pid);
      renderAuditAndSummary();
      save();
      return;
    }

    if(kind==="cashout" && color){
      p.cashout[color] = Number(t.value)||0;
      updatePlayerComputed(pid);
      renderAuditAndSummary();
      save();
      return;
    }
  }, {passive:true});

  // Structural actions still full render
  document.addEventListener("click", (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;
    const act = t.getAttribute("data-act");
    if(!act) return;
    const pid = t.getAttribute("data-p");
    const p = state.players.find(x=>x.id===pid);

    if(act==="delPlayer" && p){
      state.players = state.players.filter(x=>x.id!==pid);
      if(state.players.length===0) state.players=[makePlayer("Player 1")];
      renderAllFull();
    }

    if(act==="addRebuy" && p){
      p.buyins.push({id:uid(), counts: {black:0,purple:0,yellow:0,pink:0,orange:0} });
      renderAllFull();
    }

    if(act==="delBuyin" && p){
      const bid = t.getAttribute("data-b");
      if(p.buyins.length<=1) return;
      p.buyins = p.buyins.filter(x=>x.id!==bid);
      renderAllFull();
    }
  }, true);

  state = sanitize(state);
  renderAllFull();
})();
</script>
</body>
</html>
