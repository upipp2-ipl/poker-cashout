<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Poker Cashout â€“ Admin</title>
  <style>
    :root{
      --bg:#0b1220;--text:#e8eefc;--muted:#a9b7d6;--line:rgba(255,255,255,.10);
      --good:#2bd576;--warn:#ffcc00;--bad:#ff5c7a;--accent:#7aa7ff;
      --b:#1f2937;--p:#6d28d9;--y:#f59e0b;--pk:#ec4899;--o:#f97316;
      --r:16px;--sh:0 10px 30px rgba(0,0,0,.40);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
      background:radial-gradient(1100px 850px at 20% 0%,rgba(122,167,255,.20),transparent 60%),radial-gradient(900px 700px at 90% 10%,rgba(182,140,255,.14),transparent 60%),var(--bg)}
    .wrap{max-width:1050px;margin:0 auto;padding:18px 14px 28px}
    .top{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:12px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));box-shadow:var(--sh);backdrop-filter:blur(8px)}
    h1{margin:0;font-size:16px}
    .sub{color:var(--muted);font-size:12px;margin-top:3px;line-height:1.35}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--muted);font-size:12px;white-space:nowrap}
    .dot{width:8px;height:8px;border-radius:50%}
    .pill.good .dot{background:var(--good)}.pill.warn .dot{background:var(--warn)}.pill.bad .dot{background:var(--bad)}
    .pill.secondary{background:rgba(0,0,0,.18);color:rgba(232,238,252,.75)}
    .pill.live{background:rgba(43,213,118,.12);border-color:rgba(43,213,118,.30);color:var(--good)}
    .pill.live .dot{background:var(--good);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    .lockedOverlay{position:fixed;inset:auto 0 0 0;z-index:99;display:none;margin:10px 12px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.55);backdrop-filter:blur(10px);color:rgba(232,238,252,.92);box-shadow:var(--sh);max-width:1050px}
    @media(min-width:1050px){.lockedOverlay{left:50%;transform:translateX(-50%);width:1050px}}
    .lockedOverlay .muted{color:var(--muted)}
    button[disabled],input[disabled],select[disabled]{opacity:.55;filter:saturate(.8);cursor:not-allowed!important}
    .grid{display:grid;gap:14px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{border:1px solid var(--line);border-radius:var(--r);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));box-shadow:var(--sh);overflow:hidden}
    .hd{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(122,167,255,.12),rgba(0,0,0,0))}
    .hd h2{margin:0;font-size:14px}
    .bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row>*{flex:1}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input,select,button{font:inherit}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:var(--text);outline:none}
    input:focus,select:focus{border-color:rgba(122,167,255,.55);box-shadow:0 0 0 3px rgba(122,167,255,.12)}
    input[type="number"]{appearance:textfield}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(122,167,255,.18);color:var(--text);cursor:pointer;user-select:none;touch-action:manipulation}
    .btn.secondary{background:rgba(0,0,0,.18)}.btn.danger{background:rgba(255,92,122,.18)}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .btn.gold{background:rgba(245,158,11,.18);border-color:rgba(245,158,11,.30)}
    .btn.live{background:rgba(43,213,118,.18);border-color:rgba(43,213,118,.30)}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .note{color:var(--muted);font-size:12px;line-height:1.35;margin-top:6px}
    .muted{color:var(--muted)}.good{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
    .auditHint{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.14);color:var(--muted);font-size:12px;line-height:1.35}
    .auditHint b{color:rgba(232,238,252,.92)}
    .auditHint .chip{display:inline-flex;align-items:center;gap:6px;margin-right:10px;margin-top:6px}
    .auditHint .sw{width:10px;height:10px;border-radius:3px;display:inline-block}
    .hl-black{outline:2px solid rgba(90,160,255,.85);box-shadow:0 0 0 3px rgba(90,160,255,.20)}
    .hl-purple{outline:2px solid rgba(167,139,250,.85);box-shadow:0 0 0 3px rgba(167,139,250,.20)}
    .hl-yellow{outline:2px solid rgba(250,204,21,.85);box-shadow:0 0 0 3px rgba(250,204,21,.20)}
    .hl-pink{outline:2px solid rgba(244,114,182,.85);box-shadow:0 0 0 3px rgba(244,114,182,.20)}
    .hl-orange{outline:2px solid rgba(251,146,60,.85);box-shadow:0 0 0 3px rgba(251,146,60,.20)}
    .jumpNav{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
    .jumpNav .jbtn{padding:6px 10px;border-radius:10px;font-size:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--muted);cursor:pointer;user-select:none;touch-action:manipulation;transition:all .15s}
    .jumpNav .jbtn:hover{background:rgba(122,167,255,.15);color:var(--text);border-color:rgba(122,167,255,.35)}
    .players{display:flex;flex-direction:column;gap:12px}
    .player{border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(0,0,0,.10))}
    .phd{padding:12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(160,120,255,.10),rgba(0,0,0,0));display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pname{flex:1;min-width:0}
    .pactions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .pbd{padding:14px}.pbd.collapsed{display:none}
    .pSummaryInline{display:none;font-size:12px;color:var(--muted);margin-top:4px}
    .player.is-collapsed .pSummaryInline{display:block}
    .chips{display:grid;gap:10px;grid-template-columns:repeat(5,minmax(0,1fr))}
    @media(max-width:560px){.chips{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:360px){.chips{grid-template-columns:1fr}}
    .cell{border-radius:12px;padding:10px;transition:box-shadow .15s}
    .cell .ctop{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .sw{width:12px;height:12px;border-radius:4px}
    .sw.b{background:var(--b)}.sw.p{background:var(--p)}.sw.y{background:var(--y)}.sw.pk{background:var(--pk)}.sw.o{background:var(--o)}
    .cname{color:var(--muted);font-size:12px;font-weight:600}.cval{margin-left:auto;color:var(--muted);font-size:11px;opacity:.75}
    .cell[data-color="black"]{background:rgba(31,41,55,.50);border:1px solid rgba(31,41,55,.65)}
    .cell[data-color="purple"]{background:rgba(109,40,217,.14);border:1px solid rgba(109,40,217,.30)}
    .cell[data-color="yellow"]{background:rgba(245,158,11,.10);border:1px solid rgba(245,158,11,.25)}
    .cell[data-color="pink"]{background:rgba(236,72,153,.10);border:1px solid rgba(236,72,153,.25)}
    .cell[data-color="orange"]{background:rgba(249,115,22,.10);border:1px solid rgba(249,115,22,.25)}
    .cell[data-color="black"] input{border-color:rgba(75,85,99,.55)}
    .cell[data-color="purple"] input{border-color:rgba(139,92,246,.35)}
    .cell[data-color="yellow"] input{border-color:rgba(245,158,11,.30)}
    .cell[data-color="pink"] input{border-color:rgba(236,72,153,.30)}
    .cell[data-color="orange"] input{border-color:rgba(249,115,22,.30)}
    .stepper{display:flex;align-items:stretch;gap:0;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
    .stepper input{border:none;border-radius:0;text-align:center;padding:8px 2px;min-width:0;flex:1;background:transparent}
    .stepper input:focus{box-shadow:none}
    .stepper .sbtn{display:flex;align-items:center;justify-content:center;width:36px;min-width:36px;background:rgba(255,255,255,.05);color:var(--muted);cursor:pointer;user-select:none;touch-action:manipulation;font-size:18px;font-weight:700;border:none;transition:background .12s}
    .stepper .sbtn:hover{background:rgba(255,255,255,.12);color:var(--text)}
    .stepper .sbtn:active{background:rgba(122,167,255,.20)}
    .stepper .sbtn[disabled]{pointer-events:none;opacity:.35}
    .cashoutSection{border:1px solid rgba(122,167,255,.20);border-radius:16px;background:rgba(122,167,255,.04);padding:12px;margin-top:12px}
    .cashoutSection>label{color:var(--accent);font-weight:600}
    .miniCard{border:1px solid rgba(255,255,255,.10);border-radius:16px;background:rgba(0,0,0,.14);overflow:hidden;margin-top:12px}
    .miniHd{padding:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.10)}
    .miniHd b{font-size:13px}.miniBd{padding:10px}
    .outblock{border:1px solid rgba(255,255,255,.10);border-radius:16px;background:rgba(0,0,0,.14);padding:12px;margin-top:12px}
    .outblock pre{margin:0;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;line-height:1.35;color:rgba(232,238,252,.92)}
    .tablewrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:13px}
    th{position:sticky;top:0;z-index:1;background:rgba(0,0,0,.18);color:var(--muted);text-align:left}
    .num{text-align:right}
    .footer{position:sticky;bottom:0;z-index:9;margin-top:12px;padding-bottom:env(safe-area-inset-bottom);border:1px solid var(--line);border-radius:var(--r);background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.35));box-shadow:var(--sh);backdrop-filter:blur(10px)}
    .footer .inner{padding:10px 12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .tot{border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);padding:7px 9px;border-radius:12px;min-width:140px;flex:1 1 140px}
    .tot .k{font-size:11px;color:var(--muted)}.tot .v{font-size:14px;font-weight:800}
    .totwrap{display:flex;gap:8px;flex-wrap:wrap;align-items:stretch;flex:1;min-width:260px}
    .totwrap .tot{max-width:220px}
    @media(max-width:420px){.totwrap{min-width:0}.totwrap .tot{max-width:none}}
    .toastBox{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none}
    .toast{padding:10px 18px;border-radius:12px;background:rgba(20,24,36,.92);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(10px);color:var(--text);font-size:13px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.45);opacity:0;transform:translateY(-8px) scale(.96);animation:toastIn .25s ease forwards;pointer-events:auto}
    .toast.out{animation:toastOut .2s ease forwards}
    @keyframes toastIn{to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes toastOut{to{opacity:0;transform:translateY(-8px) scale(.96)}}
    .chevron{display:inline-block;width:20px;height:20px;border-radius:6px;background:rgba(255,255,255,.06);text-align:center;line-height:20px;font-size:12px;color:var(--muted);cursor:pointer;user-select:none;transition:transform .2s;flex-shrink:0}
    .player.is-collapsed .chevron{transform:rotate(-90deg)}
    .histHd{background:linear-gradient(180deg,rgba(245,158,11,.12),rgba(0,0,0,0))}
    .statPositive{color:var(--good);font-weight:700}.statNegative{color:var(--bad);font-weight:700}.statNeutral{color:var(--muted);font-weight:700}
    .sessionRow{cursor:pointer;transition:background .12s}.sessionRow:hover{background:rgba(255,255,255,.04)}
    .sessionDetail{display:none;background:rgba(0,0,0,.10)}
    .sessionDetail td{border-bottom:1px solid rgba(255,255,255,.05);font-size:12px;color:var(--muted)}
    .sessionDetail.open{display:table-row}
    .deleteSession{opacity:.5;cursor:pointer;font-size:11px;transition:opacity .12s}.deleteSession:hover{opacity:1;color:var(--bad)}
    .emptyState{text-align:center;padding:24px 12px;color:var(--muted);font-size:13px}
    /* Online session card */
    .onlineCard{margin-top:14px}
    .onlineCard .hd{background:linear-gradient(180deg,rgba(43,213,118,.12),rgba(0,0,0,0))}
    .codeDisplay{font-size:28px;font-weight:800;letter-spacing:4px;text-align:center;padding:16px;color:var(--text);font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .playerLink{font-size:13px;color:var(--accent);word-break:break-all;text-align:center;padding:4px 0}
    .statusGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-top:12px}
    .statusItem{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.14);font-size:13px;display:flex;align-items:center;gap:8px}
    .statusItem .sDot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
    .statusItem.pending .sDot{background:rgba(255,255,255,.15)}.statusItem.submitted .sDot{background:var(--good)}
    .statusItem.submitted{border-color:rgba(43,213,118,.25);background:rgba(43,213,118,.06)}
    .submitBadge{font-size:10px;padding:3px 7px;border-radius:6px;font-weight:600;white-space:nowrap}
    .submitBadge.yes{background:rgba(43,213,118,.18);color:var(--good);border:1px solid rgba(43,213,118,.30)}
    .submitBadge.no{background:rgba(255,255,255,.05);color:var(--muted);border:1px solid rgba(255,255,255,.08)}
  </style>
</head>
<body>
<div class="toastBox" id="toastBox"></div>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Poker Cashout (Admin)</h1>
      <div class="sub">$1 = 1000 value units â€¢ Buy-in $50 â€¢ RF tax 30% of (Winnings above total buy-ins)</div>
    </div>
    <div id="liveBadge" class="pill live" style="display:none"><span class="dot"></span><span id="liveText">LIVE</span></div>
    <div id="lockBadge" class="pill secondary" style="display:none"><span class="dot" style="background:var(--accent)"></span><span>LOCKED</span></div>
    <div id="pill" class="pill warn"><span class="dot"></span><span id="pillText">Audit: pending</span></div>
  </div>

  <!-- Online Session Card -->
  <div class="card onlineCard" id="onlineCard">
    <div class="hd">
      <h2>Online Session</h2>
      <div class="btnbar">
        <button class="btn small live" id="startOnline" type="button">Start Online Session</button>
        <button class="btn small danger" id="stopOnline" type="button" style="display:none">End Online</button>
      </div>
    </div>
    <div class="bd">
      <div id="onlineOff">
        <div class="note" style="margin:0;text-align:center;padding:8px 0">Start an online session so players can submit their cashout chip counts from their phones.</div>
      </div>
      <div id="onlineOn" style="display:none">
        <div class="note" style="margin:0;text-align:center">Share this code with your players:</div>
        <div class="codeDisplay" id="sessionCodeDisplay"></div>
        <div class="playerLink" id="playerLinkDisplay"></div>
        <div class="btnbar" style="justify-content:center;margin-top:8px">
          <button class="btn small secondary" id="copyCode">Copy code</button>
          <button class="btn small secondary" id="copyLink">Copy player link</button>
        </div>
        <div class="sep"></div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px"><b id="submitCount">0</b> / <span id="submitTotal">0</span> players submitted</div>
        <div class="statusGrid" id="statusGrid"></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd">
        <h2>Session & Rules</h2>
        <div class="btnbar">
          <button class="btn small gold" id="archiveSession" type="button">Archive</button>
          <button class="btn small danger" id="resetAll" type="button">Reset</button>
          <button class="btn small" id="lockSession" type="button">Lock session</button>
          <button class="btn small secondary" id="toggleRules" type="button">Collapse</button>
        </div>
      </div>
      <div class="bd" id="rulesBody">
        <div class="row">
          <div><label>Session name (optional)</label><input id="sessionName" type="text" placeholder="Friday poker â€” Feb 7"/></div>
          <div><label>Buy-in ($)</label><input id="buyinUsd" type="number" step="0.01" inputmode="decimal"/></div>
          <div><label>RF tax rate (0.30 = 30%)</label><input id="taxRate" type="number" step="0.01" inputmode="decimal"/></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div><label>Bank / Admin</label><select id="bankSelect"></select><div class="note">Tip: Choose the person everyone pays on Venmo/Zelle.</div></div>
        </div>
        <div class="sep"></div>
        <label>Chip values (value units per chip)</label>
        <div class="row">
          <div><label>Black</label><input id="v_black" type="number" step="1" inputmode="numeric"/></div>
          <div><label>Purple</label><input id="v_purple" type="number" step="1" inputmode="numeric"/></div>
          <div><label>Yellow</label><input id="v_yellow" type="number" step="1" inputmode="numeric"/></div>
          <div><label>Pink</label><input id="v_pink" type="number" step="1" inputmode="numeric"/></div>
          <div><label>Orange</label><input id="v_orange" type="number" step="1" inputmode="numeric"/></div>
        </div>
        <div class="sep"></div>
        <div class="btnbar">
          <button class="btn secondary" id="saveRoster" type="button">Save roster</button>
          <button class="btn secondary" id="loadRoster" type="button">Load roster</button>
          <button class="btn secondary" id="copyAll" type="button">Copy all outputs</button>
        </div>
        <div class="note">Rebuys start at 0. Use +/âˆ’ buttons for quick chip counting.</div>
        <div id="auditHint" class="auditHint" style="display:none"></div>
      </div>
    </div>
    <div class="card">
      <div class="hd"><h2>Players (<span id="playerCount">0</span>)</h2><div class="btnbar"><button class="btn" id="addPlayer" type="button">+ Add player</button></div></div>
      <div class="bd"><div id="jumpNav" class="jumpNav"></div><div id="players" class="players"></div></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd"><h2>Audit: IN vs OUT by color</h2><span class="muted">Table-level check</span></div>
      <div class="bd"><div class="tablewrap"><table><thead><tr><th>Color</th><th class="num">IN</th><th class="num">OUT</th><th class="num">OUT âˆ’ IN</th></tr></thead><tbody id="auditBody"></tbody></table></div></div>
    </div>
    <div class="card">
      <div class="hd"><h2>Weekly summary</h2><span class="muted">Totals</span></div>
      <div class="bd"><div class="tablewrap"><table><thead><tr><th>Player</th><th class="num">Buy-ins</th><th class="num">Gross</th><th class="num">RF tax</th><th class="num">Final</th><th class="num">Net</th></tr></thead><tbody id="summaryBody"></tbody></table></div></div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="hd histHd"><h2>Player Stats (All-Time)</h2><span class="muted" id="statsSessionCount"></span></div>
    <div class="bd"><div class="tablewrap"><table><thead><tr><th>Player</th><th class="num">Sessions</th><th class="num">Wins</th><th class="num">Win %</th><th class="num">Total Net</th><th class="num">Avg Net</th><th class="num">Best</th><th class="num">Worst</th></tr></thead><tbody id="statsBody"></tbody></table></div><div id="statsEmpty" class="emptyState" style="display:none">No archived sessions yet.</div></div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="hd histHd"><h2>Session History</h2><div class="btnbar"><button class="btn small danger" id="clearHistory" type="button">Clear all history</button></div></div>
    <div class="bd"><div class="tablewrap"><table><thead><tr><th>Date</th><th>Session</th><th class="num">Players</th><th class="num">Total RF</th><th></th></tr></thead><tbody id="historyBody"></tbody></table></div><div id="historyEmpty" class="emptyState" style="display:none">No sessions archived yet.</div></div>
  </div>

  <div class="card" id="payoutCard" style="margin-top:14px;display:none">
    <div class="hd"><h2>Final payouts (Venmo / Zelle list)</h2><div class="btnbar"><button class="btn small secondary" id="copyPayouts" type="button">Copy payout list</button></div></div>
    <div class="bd"><div class="note">This section appears when the session is locked.</div><div class="outblock"><pre id="payoutSuggested"></pre><div class="sep"></div><pre id="payoutText"></pre></div></div>
  </div>

  <div class="footer">
    <div class="inner">
      <div class="totwrap">
        <div class="tot"><div class="k">Total Gross</div><div class="v" id="t_gross">$0.00</div></div>
        <div class="tot"><div class="k">Total RF fund</div><div class="v" id="t_rf">$0.00</div></div>
        <div class="tot"><div class="k">Total Final</div><div class="v" id="t_final">$0.00</div></div>
      </div>
      <button class="btn secondary" id="toTop" type="button">â†‘ Top</button>
    </div>
  </div>
</div>
<div id="lockedOverlay" class="lockedOverlay"><b>Session locked.</b> <span class="muted">Unlock to edit.</span></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
(()=>{
  // â”€â”€â”€ Firebase â”€â”€â”€
  const firebaseConfig = {
    apiKey: "AIzaSyCZKgCKh9qxBcW0Gf3LmQFMsFfVB16rwCM",
    authDomain: "poker-cashout-bde23.firebaseapp.com",
    databaseURL: "https://poker-cashout-bde23-default-rtdb.firebaseio.com",
    projectId: "poker-cashout-bde23",
    storageBucket: "poker-cashout-bde23.firebasestorage.app",
    messagingSenderId: "1054875878552",
    appId: "1:1054875878552:web:94d610f9d20a18bed07ced"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const KEY="poker_admin_option1_v12_suggested_payouts";
  const ROSTER_KEY="poker_admin_roster_v1";
  const HISTORY_KEY="poker_admin_history_v1";
  const COLORS=["black","purple","yellow","pink","orange"];
  const SW={black:"b",purple:"p",yellow:"y",pink:"pk",orange:"o"};
  const DEFAULTS={sessionName:"",buyinUsd:50,taxRate:.30,chipValues:{black:100,purple:500,yellow:1000,pink:5000,orange:10000},defaultPack:{black:15,purple:3,yellow:12,pink:3,orange:2},locked:false};
  const $=id=>document.getElementById(id);
  const clamp=v=>Number.isFinite(v)?v:0;
  const clone=o=>JSON.parse(JSON.stringify(o));
  const uid=()=>Math.random().toString(16).slice(2)+"-"+Date.now().toString(16);
  const fmtUsd=x=>clamp(x).toLocaleString(undefined,{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2});
  const esc=s=>(s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const unitsToUsd=u=>clamp(u)/1000;
  const unitsFromCounts=(c,v)=>COLORS.reduce((s,cl)=>s+clamp(c[cl])*clamp(v[cl]),0);
  const totalChipCount=c=>COLORS.reduce((s,cl)=>s+clamp(c[cl]),0);

  function toast(msg,dur=2200){const box=$("toastBox"),el=document.createElement("div");el.className="toast";el.textContent=msg;box.appendChild(el);setTimeout(()=>{el.classList.add("out");setTimeout(()=>el.remove(),220)},dur)}

  const collapsedPlayers=new Set();
  let onlineSessionCode=null;
  let firebaseListener=null;

  function makePlayer(name){return{id:uid(),name:name||"Player",buyins:[{id:uid(),counts:clone(DEFAULTS.defaultPack)}],cashout:{black:0,purple:0,yellow:0,pink:0,orange:0}}}
  function defaultState(){return{sessionName:DEFAULTS.sessionName,buyinUsd:DEFAULTS.buyinUsd,taxRate:DEFAULTS.taxRate,chipValues:clone(DEFAULTS.chipValues),locked:false,bankId:null,players:[makePlayer("Player 1"),makePlayer("Player 2")]}}

  function sanitize(s){
    if(!s||typeof s!=="object")return defaultState();
    s.sessionName=typeof s.sessionName==="string"?s.sessionName:"";
    s.buyinUsd=Number(s.buyinUsd);if(!Number.isFinite(s.buyinUsd)||s.buyinUsd<=0)s.buyinUsd=DEFAULTS.buyinUsd;
    s.taxRate=Number(s.taxRate);if(!Number.isFinite(s.taxRate)||s.taxRate<0)s.taxRate=DEFAULTS.taxRate;
    s.locked=!!s.locked;s.bankId=typeof s.bankId==="string"?s.bankId:null;
    if(!s.chipValues)s.chipValues={};
    for(const c of COLORS){const v=Number(s.chipValues[c]);s.chipValues[c]=Number.isFinite(v)&&v>0?v:DEFAULTS.chipValues[c]}
    if(!Array.isArray(s.players)||s.players.length===0)s.players=[makePlayer("Player 1")];
    for(const p of s.players){
      if(!p.id)p.id=uid();if(typeof p.name!=="string")p.name="Player";
      if(!Array.isArray(p.buyins)||p.buyins.length===0)p.buyins=[{id:uid(),counts:clone(DEFAULTS.defaultPack)}];
      for(const b of p.buyins){if(!b.id)b.id=uid();if(!b.counts)b.counts=clone(DEFAULTS.defaultPack);for(const c of COLORS){const n=Number(b.counts[c]);b.counts[c]=Number.isFinite(n)&&n>=0?n:0}}
      if(!p.cashout)p.cashout={black:0,purple:0,yellow:0,pink:0,orange:0};
      for(const c of COLORS){const n=Number(p.cashout[c]);p.cashout[c]=Number.isFinite(n)&&n>=0?n:0}
    }
    const ids=s.players.map(p=>p.id);if(!s.bankId||!ids.includes(s.bankId))s.bankId=ids[0]||null;return s;
  }

  let state=(()=>{try{const r=localStorage.getItem(KEY);return sanitize(r?JSON.parse(r):null)}catch{return defaultState()}})();
  function save(){try{localStorage.setItem(KEY,JSON.stringify(state))}catch{}}
  function loadHistory(){try{return JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]")}catch{return[]}}
  function saveHistory(h){try{localStorage.setItem(HISTORY_KEY,JSON.stringify(h))}catch{}}

  function calcPlayer(p){const bc=p.buyins.length,ou=unitsFromCounts(p.cashout,state.chipValues),g=unitsToUsd(ou),bt=bc*state.buyinUsd,tb=Math.max(0,g-bt),rf=tb*state.taxRate,fp=g-rf,np=fp-bt,oc=totalChipCount(p.cashout);return{buyinsCount:bc,buyinUsdTotal:bt,outUnits:ou,outChips:oc,gross:g,rfTax:rf,finalPayout:fp,netProfit:np}}
  function calcAudit(){const IN={black:0,purple:0,yellow:0,pink:0,orange:0},OUT={black:0,purple:0,yellow:0,pink:0,orange:0};for(const p of state.players){for(const b of p.buyins)for(const c of COLORS)IN[c]+=clamp(b.counts[c]);for(const c of COLORS)OUT[c]+=clamp(p.cashout[c])}return{IN,OUT}}
  function outputBlockText(p){const c=calcPlayer(p),s=c.netProfit>=0?"+":"";return[`Chips: ${c.outChips} / ${Math.round(c.outUnits).toLocaleString()} units`,`Gross: ${fmtUsd(c.gross)}`,`RF tax: ${fmtUsd(c.rfTax)}`,`Final: ${fmtUsd(c.finalPayout)}`,`Net: ${s}${fmtUsd(c.netProfit)}`].join("\n")}
  function shortSummary(p){const c=calcPlayer(p),s=c.netProfit>=0?"+":"";return`${c.buyinsCount} buy-in${c.buyinsCount>1?"s":""} Â· Final ${fmtUsd(c.finalPayout)} Â· Net ${s}${fmtUsd(c.netProfit)}`}

  function archiveCurrentSession(){
    const players=state.players.map(p=>{const c=calcPlayer(p);return{name:p.name.trim()||"Player",buyins:c.buyinsCount,gross:c.gross,rfTax:c.rfTax,final:c.finalPayout,net:c.netProfit}});
    const totalRF=players.reduce((s,p)=>s+p.rfTax,0);
    const entry={id:uid(),date:new Date().toISOString(),sessionName:(state.sessionName||"").trim()||"Untitled session",buyinUsd:state.buyinUsd,taxRate:state.taxRate,playerCount:players.length,totalRF,players};
    const h=loadHistory();const recent=h[0];
    if(recent&&Math.abs(new Date(recent.date)-new Date(entry.date))<30000&&recent.sessionName===entry.sessionName){toast("Already archived");return false}
    h.unshift(entry);saveHistory(h);return true;
  }

  // â”€â”€â”€ Online Session â”€â”€â”€
  function generateCode(){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let c="";for(let i=0;i<4;i++)c+=chars[Math.floor(Math.random()*chars.length)];
    return c;
  }

  function getPlayerPageUrl(code){
    const base=window.location.href.replace(/\/[^/]*$/,"/");
    return base+"player.html?code="+code;
  }

  function startOnlineSession(){
    const code=generateCode();
    onlineSessionCode=code;
    const config={
      sessionName:state.sessionName||"Poker Night",
      buyinUsd:state.buyinUsd,
      taxRate:state.taxRate,
      chipValues:clone(state.chipValues),
      playerNames:state.players.map(p=>p.name.trim()).filter(Boolean),
      createdAt:Date.now()
    };
    // Initialize cashout slots
    const cashouts={};
    config.playerNames.forEach(n=>{cashouts[n]={submitted:false,black:0,purple:0,yellow:0,pink:0,orange:0}});

    db.ref("sessions/"+code).set({config,cashouts}).then(()=>{
      $("onlineOff").style.display="none";
      $("onlineOn").style.display="block";
      $("sessionCodeDisplay").textContent=code;
      $("playerLinkDisplay").textContent=getPlayerPageUrl(code);
      $("startOnline").style.display="none";
      $("stopOnline").style.display="inline-flex";
      $("liveBadge").style.display="inline-flex";
      $("liveText").textContent=`LIVE: ${code}`;
      toast("Online session started: "+code);
      listenForCashouts(code);
    }).catch(err=>{toast("Firebase error â€” check console");console.error(err)});
  }

  function stopOnlineSession(){
    if(firebaseListener&&onlineSessionCode){
      db.ref("sessions/"+onlineSessionCode+"/cashouts").off("value",firebaseListener);
      firebaseListener=null;
    }
    onlineSessionCode=null;
    $("onlineOff").style.display="block";
    $("onlineOn").style.display="none";
    $("startOnline").style.display="inline-flex";
    $("stopOnline").style.display="none";
    $("liveBadge").style.display="none";
    toast("Online session ended");
  }

  function listenForCashouts(code){
    firebaseListener=db.ref("sessions/"+code+"/cashouts").on("value",snap=>{
      const data=snap.val();
      if(!data)return;
      const names=Object.keys(data);
      let submitted=0;
      // Update status grid
      const grid=$("statusGrid");
      grid.innerHTML=names.map(n=>{
        const d=data[n];
        const isSub=!!d.submitted;
        if(isSub)submitted++;
        return`<div class="statusItem ${isSub?"submitted":"pending"}"><span class="sDot"></span><span>${esc(n)}</span></div>`;
      }).join("");
      $("submitCount").textContent=submitted;
      $("submitTotal").textContent=names.length;

      // Auto-fill cashout into state
      for(const p of state.players){
        const pName=p.name.trim();
        if(data[pName]&&data[pName].submitted){
          COLORS.forEach(c=>{p.cashout[c]=clamp(data[pName][c]||0)});
        }
      }
      save();
      renderPlayersFull();
      renderAuditAndSummary();
    });
  }

  // â”€â”€â”€ Rendering â”€â”€â”€
  function colorCell(color,valueUnits,count,kind,pid,bid){
    const dis=state.locked?"disabled":"";
    return`<div class="cell" data-color="${color}"><div class="ctop"><span class="sw ${SW[color]}"></span><span class="cname">${color[0].toUpperCase()+color.slice(1)}</span><span class="cval">${valueUnits.toLocaleString()}</span></div><div class="stepper"><button class="sbtn" data-step="-1" data-kind="${kind}" data-p="${pid}" data-b="${bid||""}" data-c="${color}" ${dis}>âˆ’</button><input type="number" step="1" inputmode="numeric" data-kind="${kind}" data-p="${pid}" data-b="${bid||""}" data-c="${color}" value="${count??0}" placeholder="0" ${dis}/><button class="sbtn" data-step="1" data-kind="${kind}" data-p="${pid}" data-b="${bid||""}" data-c="${color}" ${dis}>+</button></div></div>`;
  }

  function renderJumpNav(){const nav=$("jumpNav");if(!nav)return;if(state.players.length<=2){nav.innerHTML="";return}nav.innerHTML=state.players.map(p=>`<span class="jbtn" data-jump="${p.id}">${esc(p.name||"Player")}</span>`).join("")}

  function renderStatic(){
    $("playerCount").textContent=state.players.length;
    $("sessionName").value=state.sessionName;$("buyinUsd").value=state.buyinUsd;$("taxRate").value=state.taxRate;
    for(const c of COLORS)$("v_"+c).value=state.chipValues[c];
    const lockBtn=$("lockSession"),badge=$("lockBadge"),overlay=$("lockedOverlay");
    if(lockBtn){lockBtn.textContent=state.locked?"Unlock":"Lock session";lockBtn.classList.toggle("danger",state.locked)}
    if(badge)badge.style.display=state.locked?"inline-flex":"none";
    if(overlay)overlay.style.display=state.locked?"block":"none";
    ["sessionName","buyinUsd","taxRate","v_black","v_purple","v_yellow","v_pink","v_orange"].forEach(id=>{const el=$(id);if(el)el.disabled=!!state.locked});
    const bankSel=$("bankSelect");
    if(bankSel){bankSel.innerHTML=state.players.map(p=>`<option value="${p.id}">${esc(p.name||"Player")}</option>`).join("");bankSel.value=state.bankId||(state.players[0]?.id||"");bankSel.disabled=!!state.locked}
    $("addPlayer").disabled=!!state.locked;$("resetAll").disabled=!!state.locked;
  }

  function renderPlayersFull(){
    $("players").innerHTML=state.players.map(p=>{
      const isCol=collapsedPlayers.has(p.id);
      // Check if this player submitted online
      const isOnlineSub=onlineSessionCode&&p._onlineSubmitted;
      const buyinsHtml=p.buyins.map((b,idx)=>{
        const title=idx===0?"Buy-in 1":`Rebuy ${idx}`;
        const du=unitsFromCounts(b.counts,state.chipValues),dd=unitsToUsd(du);
        return`<div class="miniCard"><div class="miniHd"><b>${title}</b><div class="btnbar"><button class="btn small danger" data-act="delBuyin" data-p="${p.id}" data-b="${b.id}" ${(state.locked||p.buyins.length===1)?"disabled":""}>Remove</button></div></div><div class="miniBd"><div class="chips">${COLORS.map(c=>colorCell(c,state.chipValues[c],b.counts[c],"buyin",p.id,b.id)).join("")}</div><div class="note" id="disp_${p.id}_${b.id}">Dispensed: <b>${du.toLocaleString()}</b> units (~ <b>${fmtUsd(dd)}</b>)</div></div></div>`;
      }).join("");
      const ou=unitsFromCounts(p.cashout,state.chipValues),od=unitsToUsd(ou);
      return`<div class="player ${isCol?"is-collapsed":""}" data-p="${p.id}" id="player_${p.id}"><div class="phd"><span class="chevron" data-act="togglePlayer" data-p="${p.id}">â–¼</span><div class="pname"><input type="text" value="${esc(p.name)}" data-kind="name" data-p="${p.id}" autocomplete="off" autocapitalize="words" ${state.locked?"disabled":""} style="font-weight:600;background:transparent;border-color:transparent;padding:6px 8px" onfocus="this.style.borderColor='rgba(122,167,255,.55)'" onblur="this.style.borderColor='transparent'"/><div class="pSummaryInline">${shortSummary(p)}</div></div><div class="pactions"><span class="submitBadge ${onlineSessionCode?(totalChipCount(p.cashout)>0?"yes":"no"):""}}" style="${onlineSessionCode?"":"display:none"}">${totalChipCount(p.cashout)>0?"Submitted":"Pending"}</span><button class="btn small secondary" data-act="addRebuy" data-p="${p.id}" ${state.locked?"disabled":""}>+ Rebuy</button><button class="btn small danger" data-act="delPlayer" data-p="${p.id}" ${state.locked?"disabled":""}>Remove</button></div></div><div class="pbd ${isCol?"collapsed":""}"><div class="outblock"><label>Buy-ins & Rebuys (dispensed)</label><div class="note">Buy-in 1 defaults to 15/3/12/3/2. Rebuys start at 0.</div></div>${buyinsHtml}<div class="cashoutSection"><label>Cashout (chips OUT)</label><div class="chips" style="margin-top:8px">${COLORS.map(c=>colorCell(c,state.chipValues[c],p.cashout[c],"cashout",p.id,"")).join("")}</div><div class="note" id="cashnote_${p.id}">Cashout: <b>${ou.toLocaleString()}</b> units (~ <b>${fmtUsd(od)}</b>)</div></div><div class="outblock"><label>Summary</label><pre id="out_${p.id}">${esc(outputBlockText(p))}</pre></div></div></div>`;
    }).join("");
  }

  function applyMismatchHighlights(mc){document.querySelectorAll('.cell').forEach(el=>el.className=el.className.replace(/\bhl-[a-z]+\b/g,''));if(!mc||mc.length===0)return;for(const c of mc)document.querySelectorAll('.cell[data-color="'+c+'"]').forEach(el=>el.classList.add('hl-'+c))}
  function setAuditHint(m){const box=$('auditHint');if(!box)return;if(!m||m.length===0){box.style.display='none';box.innerHTML='';return}box.style.display='block';box.innerHTML='Fix these color mismatches:<br/>'+m.map(x=>{const s=x.diff>0?'+':'';return`<span class="chip"><span class="sw ${SW[x.color]}"></span><b>${x.color[0].toUpperCase()+x.color.slice(1)}</b>: OUT âˆ’ IN = <b>${s}${x.diff}</b></span>`}).join('')}

  function renderAuditAndSummary(){
    const{IN,OUT}=calcAudit();
    $("auditBody").innerHTML=COLORS.map(c=>{const d=OUT[c]-IN[c],cls=d===0?"good":(Math.abs(d)<=1?"warn":"bad");return`<tr><td>${c[0].toUpperCase()+c.slice(1)}</td><td class="num">${IN[c].toLocaleString()}</td><td class="num">${OUT[c].toLocaleString()}</td><td class="num ${cls}">${d.toLocaleString()}</td></tr>`}).join("");
    let tg=0,trf=0,tf=0;
    $("summaryBody").innerHTML=state.players.map(p=>{const c=calcPlayer(p);tg+=c.gross;trf+=c.rfTax;tf+=c.finalPayout;const cls=c.netProfit>0.0001?"good":(c.netProfit<-0.0001?"bad":"muted");return`<tr><td>${esc(p.name)}</td><td class="num">${c.buyinsCount}</td><td class="num">${fmtUsd(c.gross)}</td><td class="num">${fmtUsd(c.rfTax)}</td><td class="num">${fmtUsd(c.finalPayout)}</td><td class="num ${cls}">${fmtUsd(c.netProfit)}</td></tr>`}).join("");
    $("t_gross").textContent=fmtUsd(tg);$("t_rf").textContent=fmtUsd(trf);$("t_final").textContent=fmtUsd(tf);
    const mm=COLORS.map(c=>({color:c,diff:OUT[c]-IN[c]})).filter(x=>x.diff!==0);
    applyMismatchHighlights(mm.map(m=>m.color));setAuditHint(mm);
    const pill=$("pill"),pt=$("pillText"),haveData=COLORS.some(c=>IN[c]!==0)||COLORS.some(c=>OUT[c]!==0);
    if(!haveData){pill.className="pill warn";pt.textContent="Audit: pending"}
    else if(mm.length>0){pill.className="pill bad";const sh=mm.slice(0,2).map(m=>`${m.color[0].toUpperCase()+m.color.slice(1)} ${m.diff>0?"+":""}${m.diff}`).join(", ");pt.textContent=`Audit: MISMATCH (${sh}${mm.length>2?"â€¦":""})`}
    else{pill.className="pill good";pt.textContent="Audit: OK âœ“"}
  }

  function updatePlayerComputed(pid){const p=state.players.find(x=>x.id===pid);if(!p)return;const ou=unitsFromCounts(p.cashout,state.chipValues),od=unitsToUsd(ou);const cn=$("cashnote_"+pid);if(cn)cn.innerHTML=`Cashout: <b>${ou.toLocaleString()}</b> units (~ <b>${fmtUsd(od)}</b>)`;const op=$("out_"+pid);if(op)op.textContent=outputBlockText(p)}
  function updateBuyinComputed(pid,bid){const p=state.players.find(x=>x.id===pid);if(!p)return;const b=p.buyins.find(x=>x.id===bid);if(!b)return;const du=unitsFromCounts(b.counts,state.chipValues),dd=unitsToUsd(du);const el=$("disp_"+pid+"_"+bid);if(el)el.innerHTML=`Dispensed: <b>${du.toLocaleString()}</b> units (~ <b>${fmtUsd(dd)}</b>)`}

  function renderHistory(){
    const h=loadHistory(),tbody=$("historyBody"),empty=$("historyEmpty");
    if(h.length===0){tbody.innerHTML="";empty.style.display="block";return}
    empty.style.display="none";
    tbody.innerHTML=h.map(s=>{
      const d=new Date(s.date),ds=d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}),ts=d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});
      const dr=s.players.map(p=>{const cls=p.net>0.0001?"good":(p.net<-0.0001?"bad":"muted");return`<tr class="sessionDetail" data-detail="${s.id}"><td></td><td>${esc(p.name)}</td><td class="num">${p.buyins}</td><td class="num ${cls}">${p.net>=0?"+":""}${fmtUsd(p.net)}</td><td></td></tr>`}).join("");
      return`<tr class="sessionRow" data-sid="${s.id}"><td>${ds}<br><span class="muted" style="font-size:11px">${ts}</span></td><td>${esc(s.sessionName)}</td><td class="num">${s.playerCount}</td><td class="num">${fmtUsd(s.totalRF)}</td><td><span class="deleteSession" data-delsession="${s.id}" title="Delete">âœ•</span></td></tr>${dr}`;
    }).join("");
  }

  function renderStats(){
    const h=loadHistory();$("statsSessionCount").textContent=`${h.length} session${h.length!==1?"s":""}`;
    if(h.length===0){$("statsBody").innerHTML="";$("statsEmpty").style.display="block";return}
    $("statsEmpty").style.display="none";
    const map={};
    for(const s of h)for(const p of s.players){const key=p.name.trim().toLowerCase();if(!map[key])map[key]={name:p.name.trim(),sessions:0,wins:0,totalNet:0,best:-Infinity,worst:Infinity};const m=map[key];m.sessions++;m.totalNet+=p.net;if(p.net>0.0001)m.wins++;if(p.net>m.best)m.best=p.net;if(p.net<m.worst)m.worst=p.net;m.name=p.name.trim()}
    const stats=Object.values(map).sort((a,b)=>b.totalNet-a.totalNet);
    $("statsBody").innerHTML=stats.map(s=>{
      const wp=s.sessions>0?Math.round(s.wins/s.sessions*100):0,avg=s.sessions>0?s.totalNet/s.sessions:0;
      const nc=s.totalNet>0.0001?"statPositive":(s.totalNet<-0.0001?"statNegative":"statNeutral");
      return`<tr><td>${esc(s.name)}</td><td class="num">${s.sessions}</td><td class="num">${s.wins}</td><td class="num">${wp}%</td><td class="num ${nc}">${s.totalNet>=0?"+":""}${fmtUsd(s.totalNet)}</td><td class="num">${avg>=0?"+":""}${fmtUsd(avg)}</td><td class="num">${s.best>=0?"+":""}${fmtUsd(s.best)}</td><td class="num">${fmtUsd(s.worst)}</td></tr>`;
    }).join("");
  }

  function buildSuggestedPayoutText(){
    const bankId=state.bankId||state.players[0]?.id,bank=state.players.find(p=>p.id===bankId),bankName=bank?.name||"Bank";
    const collect=[],pay=[];let totalRF=0;
    for(const p of state.players){const c=calcPlayer(p);totalRF+=c.rfTax;if(p.id!==bankId){collect.push({name:p.name,amt:p.buyins.length*state.buyinUsd,buyins:p.buyins.length});pay.push({name:p.name,amt:c.finalPayout})}}
    const bankIn=collect.reduce((s,x)=>s+x.amt,0),bankOut=pay.reduce((s,x)=>s+x.amt,0);
    const l=[`Suggested payouts (fast settle)`,`Bank: ${bankName}`,"","Collect (buy-ins):"];
    collect.forEach(x=>l.push(`  ${x.name} â†’ ${bankName}: ${fmtUsd(x.amt)} (${x.buyins} Ã— ${fmtUsd(state.buyinUsd)})`));
    l.push(`  = Total: ${fmtUsd(bankIn)}`,"","Pay (after RF tax):");
    pay.forEach(x=>l.push(`  ${bankName} â†’ ${x.name}: ${fmtUsd(x.amt)}`));
    l.push(`  = Total: ${fmtUsd(bankOut)}`,"",`RF fund: ${fmtUsd(totalRF)}`,`Bank check: ${fmtUsd(bankIn)} âˆ’ ${fmtUsd(bankOut)} = ${fmtUsd(bankIn-bankOut)}`);
    return l.join("\n");
  }

  function buildPayoutText(){
    const bankId=state.bankId||state.players[0]?.id,bank=state.players.find(p=>p.id===bankId),bankName=bank?.name||"Bank";
    const l=[];if((state.sessionName||"").trim())l.push(state.sessionName.trim());
    l.push(`Bank: ${bankName}`,"","Everyone pays buy-ins:");
    let bankIn=0;for(const p of state.players){const buyins=p.buyins.length,amt=buyins*state.buyinUsd;bankIn+=amt;if(p.id===bankId)l.push(`  ${p.name}: (Bank) â€” ${buyins} Ã— ${fmtUsd(state.buyinUsd)}`);else l.push(`  ${p.name} â†’ ${bankName}: ${fmtUsd(amt)}`)}
    l.push("","Bank pays final payouts:");let bankOut=0;
    for(const p of state.players){const c=calcPlayer(p);bankOut+=c.finalPayout;if(p.id===bankId)l.push(`  ${bankName}: keeps ${fmtUsd(c.finalPayout)}`);else l.push(`  ${bankName} â†’ ${p.name}: ${fmtUsd(c.finalPayout)}`)}
    const totalRF=state.players.reduce((s,p)=>s+calcPlayer(p).rfTax,0);
    l.push("",`RF fund: ${fmtUsd(totalRF)}`,`Bank check: ${fmtUsd(bankIn)} âˆ’ ${fmtUsd(bankOut)} = ${fmtUsd(bankIn-bankOut)}`);
    return l.join("\n");
  }

  function renderAllFull(){
    renderStatic();renderJumpNav();renderPlayersFull();renderAuditAndSummary();renderHistory();renderStats();
    const card=$("payoutCard");if(card)card.style.display=state.locked?"block":"none";
    $("payoutSuggested").textContent=state.locked?buildSuggestedPayoutText():"";
    $("payoutText").textContent=state.locked?buildPayoutText():"";
    save();
  }

  function tap(el,fn){const h=e=>{e.preventDefault?.();fn(e)};if(window.PointerEvent)el.addEventListener("pointerup",h,{passive:false});else el.addEventListener("click",h,{passive:false})}

  // â”€â”€â”€ Event listeners â”€â”€â”€
  $("sessionName").addEventListener("input",e=>{if(state.locked)return;state.sessionName=e.target.value;save()});
  $("buyinUsd").addEventListener("input",e=>{if(state.locked)return;state.buyinUsd=Number(e.target.value)||DEFAULTS.buyinUsd;renderAuditAndSummary();save();for(const p of state.players)updatePlayerComputed(p.id)});
  $("taxRate").addEventListener("input",e=>{if(state.locked)return;state.taxRate=Number(e.target.value)||0;renderAuditAndSummary();save();for(const p of state.players)updatePlayerComputed(p.id)});
  $("bankSelect").addEventListener("change",e=>{if(state.locked)return;state.bankId=e.target.value;save();renderAllFull()});
  for(const c of COLORS){$("v_"+c).addEventListener("input",e=>{if(state.locked)return;state.chipValues[c]=Number(e.target.value)||DEFAULTS.chipValues[c];renderAllFull()})}

  tap($("addPlayer"),()=>{if(state.locked)return;state.players.unshift(makePlayer(`Player ${state.players.length+1}`));renderAllFull();toast("Player added")});
  tap($("resetAll"),()=>{if(state.locked)return;if(!confirm("Reset session data? (History preserved)"))return;localStorage.removeItem(KEY);state=defaultState();collapsedPlayers.clear();renderAllFull();toast("Session reset")});

  tap($("lockSession"),()=>{
    const wasUnlocked=!state.locked;state.locked=!state.locked;save();
    if(state.locked&&wasUnlocked){if(archiveCurrentSession()){toast("Session locked & archived ðŸ”’");renderAllFull();return}}
    renderAllFull();toast(state.locked?"Session locked ðŸ”’":"Session unlocked ðŸ”“");
  });

  tap($("archiveSession"),()=>{if(archiveCurrentSession()){renderHistory();renderStats();toast("Session archived âœ“")}});
  tap($("clearHistory"),()=>{if(!confirm("Delete ALL session history?"))return;saveHistory([]);renderHistory();renderStats();toast("History cleared")});

  // Online session buttons
  tap($("startOnline"),()=>startOnlineSession());
  tap($("stopOnline"),()=>{if(confirm("End online session? Players won't be able to submit."))stopOnlineSession()});
  tap($("copyCode"),()=>{if(onlineSessionCode)navigator.clipboard?.writeText(onlineSessionCode).then(()=>toast("Code copied: "+onlineSessionCode))});
  tap($("copyLink"),()=>{if(onlineSessionCode)navigator.clipboard?.writeText(getPlayerPageUrl(onlineSessionCode)).then(()=>toast("Player link copied âœ“"))});

  let rulesCollapsed=false;
  tap($("toggleRules"),()=>{rulesCollapsed=!rulesCollapsed;$("rulesBody").style.display=rulesCollapsed?"none":"block";$("toggleRules").textContent=rulesCollapsed?"Expand":"Collapse"});
  tap($("toTop"),()=>window.scrollTo({top:0,behavior:"smooth"}));
  tap($("saveRoster"),()=>{const names=state.players.map(p=>p.name.trim()).filter(Boolean);localStorage.setItem(ROSTER_KEY,JSON.stringify(names));toast(`Roster saved (${names.length})`)});
  tap($("loadRoster"),()=>{let names=[];try{names=JSON.parse(localStorage.getItem(ROSTER_KEY)||"[]")}catch{}if(!Array.isArray(names)||names.length===0){toast("No roster found");return}state.players=names.map(n=>makePlayer(n));renderAllFull();toast(`Roster loaded (${names.length})`)});
  tap($("copyAll"),()=>{const l=[];if(state.sessionName.trim())l.push(state.sessionName.trim());for(const p of state.players){l.push(p.name);l.push(outputBlockText(p));l.push("")}navigator.clipboard?.writeText(l.join("\n")).then(()=>toast("Copied âœ“"))});
  tap($("copyPayouts"),()=>{navigator.clipboard?.writeText((buildSuggestedPayoutText()+"\n\n"+buildPayoutText()).trim()).then(()=>toast("Payouts copied âœ“"))});

  document.addEventListener("input",e=>{
    if(state.locked)return;const t=e.target;if(!(t instanceof HTMLElement))return;
    const kind=t.getAttribute("data-kind"),pid=t.getAttribute("data-p");if(!kind||!pid)return;
    const p=state.players.find(x=>x.id===pid);if(!p)return;
    if(kind==="name"){p.name=t.value;renderAuditAndSummary();renderJumpNav();save();return}
    const color=t.getAttribute("data-c"),bid=t.getAttribute("data-b");
    if(kind==="buyin"&&color&&bid){const b=p.buyins.find(x=>x.id===bid);if(!b)return;b.counts[color]=Math.max(0,Number(t.value)||0);updateBuyinComputed(pid,bid);updatePlayerComputed(pid);renderAuditAndSummary();save();return}
    if(kind==="cashout"&&color){p.cashout[color]=Math.max(0,Number(t.value)||0);updatePlayerComputed(pid);renderAuditAndSummary();save()}
  },{passive:true});

  document.addEventListener("click",e=>{
    const t=e.target.closest(".sbtn");if(!t||state.locked)return;
    const step=Number(t.getAttribute("data-step"))||0,kind=t.getAttribute("data-kind"),pid=t.getAttribute("data-p"),color=t.getAttribute("data-c"),bid=t.getAttribute("data-b");
    const p=state.players.find(x=>x.id===pid);if(!p)return;
    if(kind==="buyin"&&bid){const b=p.buyins.find(x=>x.id===bid);if(!b)return;b.counts[color]=Math.max(0,(b.counts[color]||0)+step);const inp=t.parentElement.querySelector("input");if(inp)inp.value=b.counts[color];updateBuyinComputed(pid,bid);updatePlayerComputed(pid);renderAuditAndSummary();save()}
    if(kind==="cashout"){p.cashout[color]=Math.max(0,(p.cashout[color]||0)+step);const inp=t.parentElement.querySelector("input");if(inp)inp.value=p.cashout[color];updatePlayerComputed(pid);renderAuditAndSummary();save()}
  },true);

  document.addEventListener("click",e=>{
    const t=e.target.closest("[data-act]");if(!t)return;
    const act=t.getAttribute("data-act"),pid=t.getAttribute("data-p");
    if(act==="togglePlayer"){if(collapsedPlayers.has(pid))collapsedPlayers.delete(pid);else collapsedPlayers.add(pid);const el=document.getElementById("player_"+pid);if(el){el.classList.toggle("is-collapsed",collapsedPlayers.has(pid));el.querySelector(".pbd")?.classList.toggle("collapsed",collapsedPlayers.has(pid))}return}
    if(act==="delPlayer"){const p=state.players.find(x=>x.id===pid);if(!p)return;state.players=state.players.filter(x=>x.id!==pid);if(state.players.length===0)state.players=[makePlayer("Player 1")];collapsedPlayers.delete(pid);renderAllFull();toast(`${p.name} removed`)}
    if(act==="addRebuy"){const p=state.players.find(x=>x.id===pid);if(!p)return;p.buyins.push({id:uid(),counts:{black:0,purple:0,yellow:0,pink:0,orange:0}});renderAllFull();toast(`Rebuy added`)}
    if(act==="delBuyin"){const p=state.players.find(x=>x.id===pid);if(!p)return;const bid=t.getAttribute("data-b");if(p.buyins.length<=1)return;p.buyins=p.buyins.filter(x=>x.id!==bid);renderAllFull()}
  },true);

  document.addEventListener("click",e=>{const t=e.target.closest("[data-jump]");if(!t)return;const pid=t.getAttribute("data-jump"),el=document.getElementById("player_"+pid);if(el){if(collapsedPlayers.has(pid)){collapsedPlayers.delete(pid);el.classList.remove("is-collapsed");el.querySelector(".pbd")?.classList.remove("collapsed")}el.scrollIntoView({behavior:"smooth",block:"start"})}},true);
  document.addEventListener("click",e=>{const row=e.target.closest(".sessionRow");if(!row||e.target.closest(".deleteSession"))return;const sid=row.getAttribute("data-sid");document.querySelectorAll(`.sessionDetail[data-detail="${sid}"]`).forEach(r=>r.classList.toggle("open"))},true);
  document.addEventListener("click",e=>{const t=e.target.closest("[data-delsession]");if(!t)return;if(!confirm("Delete this session?"))return;const h=loadHistory().filter(s=>s.id!==t.getAttribute("data-delsession"));saveHistory(h);renderHistory();renderStats();toast("Session deleted")},true);

  state=sanitize(state);renderAllFull();
})();
</script>
</body>
</html>
